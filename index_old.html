<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>VOLTIGE APP</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <style>
        /* Reset */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* Theme variables */
        :root {
            --bg: linear-gradient(135deg, #f7f8fc 0%, #eef2ff 100%);
            --surface: rgba(255, 255, 255, 0.6);
            --card-bg: rgba(255, 255, 255, 0.75);
            --text: #071124;
            --muted: #6b7280;
            --accent: #7c5cff;
            --accent-2: #00e5ff;
            --glass: rgba(255, 255, 255, 0.12);
            --border: rgba(10, 10, 20, 0.06);
            --card-left: #7c5cff;
            --shadow: 0 10px 30px rgba(10, 12, 20, 0.06);
            --glass-blur: 8px;
            --sidebar-bg: rgba(255, 255, 255, 0.4);
        }

        :root[data-theme='dark'],
        [data-theme='dark'] {
            --bg: linear-gradient(120deg, #071630 0%, #081026 60%);
            --surface: rgba(8, 10, 18, 0.6);
            --card-bg: rgba(12, 14, 22, 0.65);
            --text: #e6eef8;
            --muted: #98a0b3;
            --accent: #8b63ff;
            --accent-2: #00ffc6;
            --glass: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.03);
            --card-left: #8b63ff;
            --shadow: 0 12px 34px rgba(2, 6, 23, 0.6);
            --sidebar-bg: rgba(12, 14, 22, 0.4);
        }

        html,
        body {
            height: 100%;
        }

        body {
            font-family: 'JetBrains Mono NL', 'JetBrains Mono', Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            transition: background 400ms ease, color 400ms ease;
            position: relative;
            overflow-x: hidden;
            display: flex;
        }

        body::before {
            content: '';
            position: fixed;
            left: -20%;
            top: -30%;
            width: 140%;
            height: 120%;
            background: radial-gradient(circle at 20% 20%, rgba(124, 92, 255, 0.14), transparent 12%), radial-gradient(circle at 80% 80%, rgba(0, 229, 255, 0.08), transparent 12%);
            filter: blur(80px);
            pointer-events: none;
            z-index: 0;
            transition: opacity 400ms ease;
        }

        /* Layout Principal */
        .layout {
            display: flex;
            width: 100%;
            position: relative;
            z-index: 2;
        }

        /* Sidebar */
        .sidebar {
            width: 70px;
            background: var(--sidebar-bg);
            backdrop-filter: blur(var(--glass-blur));
            border-right: 1px solid var(--border);
            padding: 24px 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            flex-shrink: 0;
            transition: width 300ms ease, padding 300ms ease;
            position: relative;
        }

        .sidebar:hover {
            width: 320px;
            padding: 24px;
            overflow-y: auto;
        }

        .sidebar h2 {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 20px 0 12px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            opacity: 0;
            max-width: 0;
            overflow: hidden;
            transition: opacity 300ms ease, max-width 300ms ease;
            white-space: nowrap;
        }

        .sidebar:hover h2 {
            opacity: 1;
            max-width: 200px;
        }

        .sidebar h2:first-child {
            margin-top: 0;
        }

        /* Search Box dalam Sidebar */
        .search-box {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--card-bg);
            border-radius: 12px;
            padding: 12px 14px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            margin-bottom: 20px;
            transition: box-shadow 300ms ease, opacity 300ms ease, max-width 300ms ease, padding 300ms ease, width 300ms ease;
            opacity: 0;
            max-width: 0;
            overflow: hidden;
            white-space: nowrap;
            width: 44px;
            height: 44px;
            padding: 0;
            justify-content: center;
        }

        .sidebar:hover .search-box {
            opacity: 1;
            max-width: 250px;
            width: 100%;
            height: auto;
            padding: 12px 14px;
            justify-content: flex-start;
            overflow: visible;
        }

        .search-box:focus-within {
            box-shadow: 0 12px 30px rgba(12, 14, 22, 0.2);
        }

        .search-icon {
            width: 18px;
            height: 18px;
            color: var(--muted);
            flex-shrink: 0;
        }

        .sidebar:not(:hover) .search-box input {
            display: none;
        }

        /* Tooltip pour search-box */
        .sidebar:not(:hover) .search-box {
            position: relative;
        }

        .sidebar:not(:hover) .search-box::after {
            content: attr(title);
            position: absolute;
            left: 50px;
            background: var(--card-bg);
            color: var(--text);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 200ms ease;
            border: 1px solid var(--border);
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .sidebar:not(:hover) .search-box:hover::after {
            opacity: 1;
        }

        input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 0.95rem;
            background: transparent;
            color: var(--text);
        }

        input::placeholder {
            color: var(--muted);
        }

        /* File Links */
        .file-links {
            display: flex;
            flex-direction: column;
            gap: 10px;
            opacity: 0;
            max-width: 0;
            overflow: hidden;
            transition: opacity 300ms ease, max-width 300ms ease;
            white-space: nowrap;
        }

        .sidebar:hover .file-links {
            opacity: 1;
            max-width: 250px;
        }

        .file-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 10px;
            text-decoration: none;
            color: var(--accent);
            font-weight: 500;
            font-size: 0.95rem;
            transition: transform 200ms, box-shadow 200ms, padding 300ms ease, justify-content 300ms ease, background 200ms;
            cursor: pointer;
            position: relative;
            min-height: 44px;
            backdrop-filter: blur(6px);
        }

        .sidebar:not(:hover) .file-link {
            padding: 12px;
            justify-content: center;
            border: 1px solid var(--border);
        }

        .file-link:hover {
            transform: translateX(4px);
            box-shadow: 0 8px 16px rgba(124, 92, 255, 0.15);
            background: var(--card-bg);
            border-color: var(--accent);
        }

        .file-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
            transition: opacity 300ms ease;
        }

        .sidebar:not(:hover) .file-link::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: inherit;
            opacity: 0;
        }

        /* Masquer le texte sauf emoji au d√©but dans le mode r√©duit */
        .sidebar:not(:hover) .file-link {
            font-size: 1.2rem;
            width: 44px;
            height: 44px;
            overflow: hidden;
            padding: 0;
        }

        /* Afficher le texte en mode √©tendu */
        .sidebar:hover .file-link {
            width: auto;
            height: auto;
            overflow: visible;
        }

        /* G√©rer le texte enfant du file-link */
        .file-link> :not(.file-icon):not(svg) {
            max-width: 150px;
            white-space: normal;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar:not(:hover) .file-link> :not(.file-icon):not(svg) {
            display: none;
        }

        /* Tooltips pour le mode r√©duit */
        .sidebar:not(:hover) .file-link {
            position: relative;
        }

        .sidebar:not(:hover) .file-link::after {
            content: attr(title);
            position: absolute;
            left: 50px;
            background: var(--card-bg);
            color: var(--text);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 200ms ease;
            border: 1px solid var(--border);
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .sidebar:not(:hover) .file-link:hover::after {
            opacity: 1;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 64px 72px;
            overflow-y: auto;
            position: relative;
            max-width: 1600px;
            margin: 0 auto;
            width: 100%;
        }

        header {
            text-align: center;
            margin-bottom: 60px;
            animation: fadeIn 600ms ease-out;
        }

        h1 {
            font-size: clamp(2.2rem, 4.5vw, 3.6rem);
            font-weight: 700;
            letter-spacing: -0.6px;
        }

        .subtitle {
            color: var(--muted);
            margin-top: 12px;
            font-size: clamp(1rem, 1.5vw, 1.3rem);
        }

        /* Theme toggle */
        #themeToggle {
            position: static;
            width: 100%;
            height: auto;
            border-radius: 8px;
            border: 1px solid var(--border);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: var(--glass);
            padding: 10px 16px;
            color: var(--text);
            backdrop-filter: blur(6px);
            transition: all 0.3s ease;
            font-size: 14px;
        }

        #themeToggle:hover {
            background: var(--card-bg);
            border-color: var(--accent);
            transform: none;
        }

        #themeToggle:active {
            transform: scale(0.98);
        }

        /* Tabs Navigation */
        .tabs-nav {
            display: flex;
            gap: 20px;
            margin-bottom: 48px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 14px 24px;
            background: var(--glass);
            border: 1px solid var(--border);
            color: var(--muted);
            font-weight: 600;
            font-size: 1.05rem;
            cursor: pointer;
            transition: all 200ms ease;
            position: relative;
            border-radius: 10px;
            backdrop-filter: blur(6px);
            margin-right: 8px;
        }

        .tab-btn:hover {
            background: var(--card-bg);
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .tab-btn.active {
            color: var(--accent);
            background: var(--card-bg);
            border-color: var(--accent);
            box-shadow: 0 8px 20px rgba(124, 92, 255, 0.15);
        }

        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 300ms ease;
        }

        .tab-content.active {
            display: block;
        }

        /* Results Grid */
        .results {
            display: grid;
            gap: 24px;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        }

        .card {
            background: var(--glass);
            border-radius: 16px;
            padding: 28px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            transition: transform 280ms cubic-bezier(.2, .9, .3, 1), box-shadow 280ms, background 280ms;
            cursor: pointer;
            backdrop-filter: blur(12px);
            animation: fadeUp 400ms ease both;
        }

        .card:hover {
            transform: translateY(-6px) rotateZ(-0.2deg);
            box-shadow: 0 22px 50px rgba(124, 92, 255, 0.25);
            background: var(--card-bg);
            border-color: var(--accent);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            gap: 12px;
        }

        .card-title {
            font-size: 1.05rem;
            font-weight: 700;
            color: var(--text);
        }

        .card-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--accent);
            text-decoration: none;
            font-weight: 600;
            padding: 8px 12px;
            border-radius: 8px;
            transition: background 180ms;
        }

        .card-link:hover {
            background: rgba(124, 92, 255, 0.06);
        }

        .card-explain {
            color: var(--muted);
            margin-bottom: 12px;
            font-size: 0.95rem;
            line-height: 1.45;
        }

        .card-spec {
            background: rgba(0, 0, 0, 0.03);
            padding: 10px 12px;
            border-radius: 10px;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, monospace;
            font-size: 0.85rem;
            color: var(--muted);
            border-left: 3px solid var(--card-left);
        }

        .category-badge {
            display: inline-block;
            padding: 6px 10px;
            border-radius: 999px;
            font-weight: 700;
            font-size: 0.8rem;
            color: var(--accent);
            background: linear-gradient(90deg, rgba(124, 92, 255, 0.08), rgba(0, 229, 255, 0.04));
        }

        /* Chart Container */
        .chart-container {
            background: var(--glass);
            border-radius: 14px;
            padding: 30px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            max-width: 900px;
            backdrop-filter: blur(12px);
            transition: all 300ms ease;
        }

        .chart-container:hover {
            background: var(--card-bg);
            border-color: var(--accent);
            transform: translateY(-4px);
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 24px;
            color: var(--text);
        }

        canvas {
            max-height: 400px;
        }

        /* Performance table (remplace le radar) */
        .performance-table {
            width: 100%;
            overflow: auto;
        }

        .performance-table table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.98rem;
        }

        .performance-table th,
        .performance-table td {
            padding: 12px 14px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .performance-table th {
            color: var(--muted);
            width: 45%;
        }

        .perf-value {
            font-weight: 700;
        }

        .perf-diff {
            background: linear-gradient(90deg, rgba(124, 92, 255, 0.06), rgba(0, 229, 255, 0.03));
            border-radius: 8px;
            padding: 6px 8px;
            display: inline-block;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--muted);
        }

        /* Augmenter la taille de la section Performances */
        #performances .chart-container {
            max-width: 1200px;
            padding: 40px;
            margin-bottom: 40px;
        }

        #performances .chart-title {
            font-size: 1.5rem;
            margin-bottom: 32px;
        }

        #performances .performance-table {
            font-size: 1.1rem;
        }

        #performances .performance-table table {
            font-size: 1.05rem;
        }

        #performances .performance-table th,
        #performances .performance-table td {
            padding: 18px 20px;
        }

        #performances canvas {
            max-height: 500px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateY(8px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        /* Scrollbar */
        .sidebar::-webkit-scrollbar,
        .main-content::-webkit-scrollbar {
            width: 8px;
        }

        .sidebar::-webkit-scrollbar-track,
        .main-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar::-webkit-scrollbar-thumb,
        .main-content::-webkit-scrollbar-thumb {
            background: rgba(124, 92, 255, 0.3);
            border-radius: 4px;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                width: 280px;
                padding: 20px;
            }

            .main-content {
                padding: 32px;
            }
        }

        @media (max-width: 768px) {
            .layout {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--border);
                max-height: 200px;
                display: flex;
                gap: 30px;
                overflow-x: auto;
            }

            .main-content {
                padding: 24px;
            }

            .results {
                grid-template-columns: 1fr;
            }
        }

        /* Calculateur Styles */
        .calc-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 1024px) {
            .calc-grid {
                grid-template-columns: 1fr;
            }
        }

        .calc-card {
            background: var(--card-bg);
            border-radius: 14px;
            padding: 30px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .calc-card h2 {
            font-size: 1.3rem;
            margin-bottom: 24px;
            color: var(--text);
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.95em;
            color: var(--text);
        }

        .value-display {
            color: var(--accent);
            font-weight: 700;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(to right, var(--accent), var(--accent-2));
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            box-shadow: 0 0 10px rgba(124, 92, 255, 0.5);
            transition: all 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            width: 24px;
            height: 24px;
            box-shadow: 0 0 20px rgba(124, 92, 255, 0.8);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px rgba(124, 92, 255, 0.5);
            transition: all 0.2s;
        }

        input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--glass);
            color: var(--text);
            font-size: 1em;
            transition: all 0.2s ease;
            backdrop-filter: blur(6px);
        }

        input[type="number"]:hover {
            background: var(--card-bg);
            border-color: var(--accent);
        }

        input[type="number"]:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--card-bg);
            box-shadow: 0 0 15px rgba(124, 92, 255, 0.3);
            backdrop-filter: blur(8px);
        }

        select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--glass);
            color: var(--text);
            font-size: 1em;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(6px);
        }

        select:hover {
            background: var(--card-bg);
            border-color: var(--accent);
        }

        select:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--card-bg);
            box-shadow: 0 0 15px rgba(124, 92, 255, 0.3);
            backdrop-filter: blur(8px);
        }

        .toggle-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .toggle-switch {
            flex: 1;
            min-width: 150px;
        }

        .toggle-switch input {
            display: none;
        }

        .toggle-label {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background: rgba(124, 92, 255, 0.1);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            color: var(--text);
        }

        .toggle-switch input:checked+.toggle-label {
            background: rgba(124, 92, 255, 0.3);
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(124, 92, 255, 0.3);
        }

        .calc-results {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .calc-result {
            background: linear-gradient(135deg, rgba(124, 92, 255, 0.1), rgba(0, 229, 255, 0.05));
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .result-label {
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.8;
            margin-bottom: 10px;
            color: var(--muted);
        }

        .result-value {
            font-size: 2em;
            font-weight: 900;
            color: var(--accent);
            text-shadow: 0 0 10px rgba(124, 92, 255, 0.3);
        }

        .result-unit {
            font-size: 0.9em;
            color: var(--accent-2);
            margin-top: 5px;
        }

        .calc-btn-primary {
            width: 100%;
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            color: var(--text);
        }

        .calc-btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(124, 92, 255, 0.4);
        }

        .calc-alert {
            background: rgba(255, 107, 107, 0.2);
            border-left: 4px solid #ff6b6b;
            padding: 15px;
            border-radius: 8px;
            color: #ff6b6b;
        }

        /* Comparateur Styles */
        .comparator-table-container {
            overflow-x: auto;
            margin-bottom: 40px;
            border-radius: 14px;
            background: var(--card-bg);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .comparator-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }

        .comparator-table thead {
            background: linear-gradient(90deg, rgba(124, 92, 255, 0.1), rgba(0, 229, 255, 0.1));
        }

        .comparator-table th {
            padding: 18px 14px;
            text-align: center;
            font-weight: 700;
            color: var(--text);
            border-bottom: 2px solid var(--border);
            vertical-align: bottom;
        }

        .comparator-table th.config-a {
            background: rgba(255, 209, 102, 0.1);
        }

        .comparator-table th.config-b {
            background: rgba(255, 107, 107, 0.1);
        }

        .comparator-table th.config-c {
            background: rgba(0, 229, 255, 0.1);
        }

        .config-subtitle {
            display: block;
            font-size: 0.75em;
            font-weight: 500;
            opacity: 0.8;
            margin-top: 4px;
        }

        .comparator-table td {
            padding: 14px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .comparator-table tbody tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.02);
        }

        .comparator-table tbody tr:hover {
            background: rgba(124, 92, 255, 0.08);
        }

        .section-header {
            background: linear-gradient(90deg, rgba(124, 92, 255, 0.15), rgba(0, 229, 255, 0.08));
            font-weight: 700;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .section-header td {
            padding: 16px 14px;
            border-bottom: 2px solid var(--border);
        }

        .highlight {
            background: rgba(124, 92, 255, 0.1);
            padding: 6px 10px;
            border-radius: 6px;
            font-weight: 600;
            color: var(--accent);
        }

        .highlight-strong {
            background: linear-gradient(90deg, rgba(124, 92, 255, 0.2), rgba(0, 229, 255, 0.15));
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: 700;
            color: var(--accent);
        }

        .use-cases-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px;
        }

        .use-case-card {
            background: var(--card-bg);
            border-radius: 14px;
            padding: 24px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: transform 280ms cubic-bezier(.2, .9, .3, 1), box-shadow 280ms;
        }

        .use-case-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 22px 50px rgba(2, 6, 23, 0.25);
        }

        .use-case-card ul {
            list-style-type: none;
            padding: 0;
        }

        .use-case-card li {
            padding: 6px 0;
            line-height: 1.5;
        }

        .use-case-card li:before {
            content: "‚ñ∏ ";
            margin-right: 8px;
        }

        @media (max-width: 1024px) {
            .comparator-table {
                font-size: 0.85rem;
            }

            .comparator-table th,
            .comparator-table td {
                padding: 10px 8px;
            }
        }

        /* Telemetry Dashboard Styles */
        .telemetry-layout {
            display: grid;
            grid-template-columns: 280px 1fr 280px;
            gap: 20px;
            margin-top: 20px;
        }

        .telemetry-section {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .telemetry-charts {
            grid-column: 2;
        }

        .telemetry-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .telemetry-card h3 {
            font-size: 0.95rem;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.9rem;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-label {
            color: var(--muted);
            font-weight: 600;
        }

        .status-value {
            color: var(--accent);
            font-weight: 700;
            font-family: ui-monospace, monospace;
        }

        .battery-bar {
            width: 100%;
            height: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .battery-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #FFD166, #00e5ff);
            border-radius: 6px;
            transition: width 0.3s ease;
        }

        @media (max-width: 1400px) {
            .telemetry-layout {
                grid-template-columns: 1fr;
            }

            .telemetry-charts {
                grid-column: 1;
            }
        }

        @media (max-width: 768px) {
            .telemetry-layout {
                grid-template-columns: 1fr;
            }

            .telemetry-section {
                order: 2;
            }

            .telemetry-section:first-child {
                order: 1;
            }
        }

        /* MISSION BUILDER STYLES */
        .mb-step {
            animation: fadeIn 300ms ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .scenario-card {
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 300ms ease;
            text-align: center;
            backdrop-filter: blur(8px);
        }

        .scenario-card:hover {
            border-color: var(--accent);
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(124, 92, 255, 0.2);
            background: var(--card-bg);
        }

        .scenario-card.selected {
            border-color: var(--accent);
            background: var(--card-bg);
            box-shadow: 0 12px 24px rgba(124, 92, 255, 0.3);
            backdrop-filter: blur(10px);
        }

        .scenario-card h3 {
            margin: 12px 0;
            font-size: 18px;
        }

        .mb-btn-primary,
        .mb-btn-secondary {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 200ms ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .mb-btn-primary {
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            color: white;
        }

        .mb-btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(124, 92, 255, 0.3);
        }

        .mb-btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .mb-btn-secondary {
            background: var(--glass);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .mb-btn-secondary:hover {
            background: var(--card-bg);
            border-color: var(--accent);
        }

        #mb-map {
            position: relative;
            z-index: 1;
        }

        .leaflet-container {
            background: var(--surface);
        }

        .leaflet-popup-content-wrapper {
            background: var(--card-bg);
            color: var(--text);
            border-radius: 8px;
        }

        .leaflet-popup-tip {
            background: var(--card-bg);
        }

        .mb-waypoint-marker {
            background: var(--accent);
            border: 3px solid white;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: white;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        input[type="range"] {
            accent-color: var(--accent);
        }

        input[type="time"],
        select {
            font-family: inherit;
        }

        label {
            cursor: pointer;
        }

        input[type="radio"],
        input[type="checkbox"] {
            cursor: pointer;
            margin-right: 8px;
        }

        /* BUDGET STYLES */
        .budget-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .budget-table-container {
            overflow-x: auto;
            margin: 30px 0;
            border-radius: 14px;
            background: var(--glass);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            backdrop-filter: blur(12px);
            transition: all 300ms ease;
        }

        .budget-table-container:hover {
            background: var(--card-bg);
            border-color: var(--accent);
        }

        .budget-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 1rem;
        }

        .budget-table thead {
            background: linear-gradient(90deg, rgba(124, 92, 255, 0.15), rgba(0, 229, 255, 0.08));
        }

        .budget-table th {
            padding: 20px;
            text-align: left;
            font-weight: 700;
            color: var(--text);
            border-bottom: 2px solid var(--border);
        }

        .budget-row {
            border-bottom: 1px solid var(--border);
            transition: background 200ms;
        }

        .budget-row:hover {
            background: rgba(124, 92, 255, 0.05);
        }

        .budget-row td {
            padding: 18px 20px;
        }

        .budget-total {
            background: linear-gradient(90deg, rgba(124, 92, 255, 0.15), rgba(0, 229, 255, 0.1));
            border-top: 2px solid var(--accent);
            border-bottom: none;
        }

        .budget-total td {
            padding: 20px;
            color: var(--accent);
        }

        .budget-label {
            font-weight: 600;
            color: var(--text);
            min-width: 250px;
        }

        .budget-amount {
            font-weight: 700;
            color: var(--accent);
            font-family: ui-monospace, monospace;
            min-width: 120px;
            text-align: right;
            padding-right: 40px;
        }

        .budget-notes {
            color: var(--muted);
            font-size: 0.95rem;
            font-style: italic;
        }

        .components-cost-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .component-cost-card {
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            transition: transform 200ms, box-shadow 200ms, background 200ms;
            backdrop-filter: blur(8px);
        }

        .component-cost-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(124, 92, 255, 0.2);
            background: var(--card-bg);
            border-color: var(--accent);
        }

        .component-cost-name {
            font-weight: 700;
            color: var(--text);
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .component-cost-category {
            display: inline-block;
            background: rgba(124, 92, 255, 0.1);
            color: var(--accent);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .component-cost-price {
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--accent);
            margin-bottom: 8px;
        }

        .component-cost-link {
            display: inline-block;
            color: var(--accent-2);
            text-decoration: none;
            font-size: 0.9rem;
            margin-top: 10px;
            padding: 6px 10px;
            border-radius: 6px;
            background: rgba(0, 229, 255, 0.1);
            transition: background 200ms;
        }

        .component-cost-link:hover {
            background: rgba(0, 229, 255, 0.2);
        }

        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            box-shadow: var(--shadow);
            transition: transform 200ms;
        }

        .stat-card:hover {
            transform: translateY(-4px);
        }

        .stat-label {
            color: var(--muted);
            font-size: 0.95rem;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 900;
            color: var(--accent);
            text-shadow: 0 0 15px rgba(124, 92, 255, 0.2);
        }

        @media (max-width: 768px) {

            .budget-table th,
            .budget-table td {
                padding: 12px;
                font-size: 0.9rem;
            }

            .budget-label {
                min-width: auto;
            }

            .budget-amount {
                padding-right: 20px;
            }

            .components-cost-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="layout">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <h2> Debug & Outils</h2>
            <div class="file-links">
                <a href="VERIFY_TELEMETRY.html" target="_blank" class="file-link" title="V√©rifier T√©l√©m√©trie"
                    style="background: #00ff88; color: #000; display: block; padding: 8px; border-radius: 6px; text-decoration: none; font-weight: 600; text-align: center; margin-bottom: 8px;">
                    ‚úÖ V√©rifier T√©l√©m√©trie
                </a>
                <a href="CHECK.html" target="_blank" class="file-link" title="V√©rification Syst√®me"
                    style="background: #00e5ff; color: #000; display: block; padding: 8px; border-radius: 6px; text-decoration: none; font-weight: 600; text-align: center; margin-bottom: 8px;">
                    üß™ V√©rification Syst√®me
                </a>
                <a href="CHECK.html" target="_blank" class="file-link" title="V√©rification Syst√®me"
                    style="background: #ff8d22; color: #000; display: block; padding: 8px; border-radius: 6px; text-decoration: none; font-weight: 600; text-align: center; margin-bottom: 8px;">
                    üìô V√©rification Syst√®me
                </a>
            </div>

            <h2>üìÑ Documentation</h2>
            <div class="file-links">
                <a href="VOLTIGE DOCS/VOLTIGE_SYNTHESE_COMPLETE.pdf" target="_blank" class="file-link"
                    title="Synth√®se compl√®te V3">
                    <svg class="file-icon" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M9 12h6m-6 4h6m2-13H7a2 2 0 00-2 2v16a2 2 0 002 2h10a2 2 0 002-2V5a2 2 0 00-2-2z" />
                    </svg>
                    Synth√®se compl√®te V3
                </a>
                <a href="VOLTIGE DOCS/VOLTIGE - Cas d'Usage & Applications R√©elles.pdf" target="_blank"
                    class="file-link" title="Spec V3 cas d'usage">
                    <svg class="file-icon" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M9 12h6m-6 4h6m2-13H7a2 2 0 00-2 2v16a2 2 0 002 2h10a2 2 0 002-2V5a2 2 0 00-2-2z" />
                    </svg>
                    Spec V3 cas d'usage
                </a>
                <a href="VOLTIGE DOCS/VOLTIGE - Comparaison 3 Configurations.pdf" target="_blank" class="file-link"
                    title="Comparaison des configurations">
                    <svg class="file-icon" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M9 12h6m-6 4h6m2-13H7a2 2 0 00-2 2v16a2 2 0 002 2h10a2 2 0 002-2V5a2 2 0 00-2-2z" />
                    </svg>
                    V2 comparaison des configurations
                </a>
                <a href="VOLTIGE DOCS/VOLTIGE V1 - Sp√©cifications Techniques Finales.pdf" target="_blank"
                    class="file-link" title="Sp√©cifications Techniques V1">
                    <svg class="file-icon" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M9 12h6m-6 4h6m2-13H7a2 2 0 00-2 2v16a2 2 0 002 2h10a2 2 0 002-2V5a2 2 0 00-2-2z" />
                    </svg>
                    VOLTIGE V1 - Sp√©cifications Techniques Finales
                </a>
            </div>

            <!-- Theme Toggle Button -->
            <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border);">
                <button id="themeToggle" aria-label="Basculer th√®me" title="Basculer th√®me" type="button"
                    style="width: 100%; padding: 10px 16px; background: var(--glass); border: 1px solid var(--border); border-radius: 8px; color: var(--text); cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s;">
                    <span id="themeIcon">üåô</span>
                    <span>Mode Sombre/Clair</span>
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="main-content">
            <header>
                <h1>VOLTIGE</h1>
                <p class="subtitle">De la passion √† l'action</p>
            </header>
            <!-- Tabs Navigation -->
            <div class="tabs-nav">
                <button class="tab-btn active" data-tab="composants">üì¶ Composants</button>
                <button class="tab-btn" data-tab="performances">üìä Performances</button>
                <button class="tab-btn" data-tab="calculateur">‚ö° Calculateur</button>
                <button class="tab-btn" data-tab="comparateur">üîÑ Comparateur</button>
                <button class="tab-btn" data-tab="telemetry">üì° Live Telemetry</button>
                <button class="tab-btn" data-tab="mission-builder">üéØ Mission Builder</button>
                <button class="tab-btn" data-tab="budget">üí∞ Budget</button>
                <button class="tab-btn" data-tab="documentation">üìö Documentation</button>
            </div>

            <!-- SPOTLIGHT SEARCH BUTTON (Floating) -->
            <button id="spotlightBtn"
                style="position: fixed; top: 20px; right: 20px; width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #7c5cff, #00e5ff); border: 2px solid var(--accent); cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 999; box-shadow: 0 4px 20px rgba(124, 92, 255, 0.4); transition: all 0.3s; font-size: 24px;">
                üîç
            </button>

            <!-- SPOTLIGHT MODAL -->
            <div id="spotlightOverlay"
                style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); z-index: 1000; animation: fadeIn 0.2s;">
            </div>

            <div id="spotlightModal"
                style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--card-bg); border: 1px solid var(--border); border-radius: 16px; width: 90%; max-width: 600px; max-height: 70vh; overflow: hidden; z-index: 1001; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); animation: slideDown 0.3s;">
                <!-- Search Input -->
                <div
                    style="padding: 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px;">
                    <svg style="width: 20px; height: 20px; color: var(--accent); flex-shrink: 0;" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <input type="text" id="spotlightInput"
                        placeholder=" Recherche globale... (ex: @composants[batterie] ou batterie)"
                        style="flex: 1; background: transparent; border: none; outline: none; color: var(--text); font-size: 16px; font-family: inherit;"
                        autocomplete="off" />
                </div>

                <!-- Results Container -->
                <div id="spotlightResults" style="overflow-y: auto; max-height: calc(70vh - 100px); padding: 12px;">
                    <div style="color: var(--muted); text-align: center; padding: 40px 20px; font-size: 14px;">
                        Commence √† taper pour chercher...
                    </div>
                </div>

                <!-- Footer with shortcuts -->
                <div
                    style="padding: 12px 16px; border-top: 1px solid var(--border); background: rgba(0,0,0,0.05); font-size: 12px; color: var(--muted); display: flex; justify-content: space-between;">
                    <span>‚Üë‚Üì Naviguer ‚Ä¢ ‚Üµ S√©lectionner</span>
                    <span>ESC Fermer</span>
                </div>
            </div>

            <!-- CSS for animations -->
            <style>
                @keyframes fadeIn {
                    from {
                        opacity: 0;
                    }

                    to {
                        opacity: 1;
                    }
                }

                @keyframes slideDown {
                    from {
                        opacity: 0;
                        transform: translate(-50%, -55%);
                    }

                    to {
                        opacity: 1;
                        transform: translate(-50%, -50%);
                    }
                }

                #spotlightBtn:hover {
                    transform: scale(1.1);
                    box-shadow: 0 6px 30px rgba(124, 92, 255, 0.6) !important;
                }

                #spotlightBtn:active {
                    transform: scale(0.95);
                }
            </style>

            <!-- Tab 1: Composants -->
            <div id="composants" class="tab-content active">
                <div id="results" class="results"></div>
            </div>

            <!-- Tab 2: Performances -->
            <div id="performances" class="tab-content">
                <div class="chart-container">
                    <h2 class="chart-title">Performances : V1 vs V2</h2>
                    <div id="performanceTable" class="performance-table"></div>
                </div>
                <div class="chart-container" style="margin-top:20px;">
                    <h2 class="chart-title">Pouss√©e des moteurs (V1 vs V2)</h2>
                    <div id="motorTable" class="performance-table"></div>
                </div>
                <div class="chart-container" style="margin-top: 30px;">
                    <h2 class="chart-title">Autonomie par mode</h2>
                    <canvas id="autonomyChart"></canvas>
                </div>
                <div class="chart-container" style="margin-top: 20px;">
                    <h2 class="chart-title">Eau ‚Äî Autonomie par vitesse</h2>
                    <canvas id="waterChart"></canvas>
                </div>
                <div class="chart-container" style="margin-top: 20px;">
                    <h2 class="chart-title">Performances des Processeur</h2>
                    <canvas id="cpuComparisonChart" style="height: 350px;"></canvas>
                </div>
            </div>

            <!-- Tab 3: Calculateur -->
            <div id="calculateur" class="tab-content">
                <div class="calc-grid">
                    <!-- Environment & Controls -->
                    <div class="card calc-card">
                        <h2>‚öôÔ∏è Environnement & Contr√¥les</h2>

                        <div class="input-group">
                            <label>Mode Op√©ration</label>
                            <select id="environment">
                                <option value="air">‚úàÔ∏è Air</option>
                                <option value="water">üåä Eau</option>
                            </select>
                        </div>

                        <div id="airControls">
                            <div class="input-group">
                                <label>Throttle Sustentation: <span class="value-display"
                                        id="sustentationThrottleVal">50</span>%</label>
                                <input type="range" id="sustentationThrottle" min="0" max="100" value="50">
                            </div>

                            <div class="input-group">
                                <label>Throttle Propulsion: <span class="value-display"
                                        id="propulsionThrottleVal">50</span>%</label>
                                <input type="range" id="propulsionThrottle" min="0" max="100" value="50">
                            </div>

                            <div class="input-group">
                                <label>Vitesse Vent: <span class="value-display" id="windSpeedVal">0</span> km/h</label>
                                <input type="range" id="windSpeed" min="0" max="50" value="0" step="1">
                            </div>

                            <div class="toggle-group">
                                <div class="toggle-switch">
                                    <input type="checkbox" id="stabilization" checked>
                                    <label class="toggle-label" for="stabilization">üîß Stabilisation</label>
                                </div>
                            </div>
                        </div>

                        <div id="waterControls" style="display: none;">
                            <div class="input-group">
                                <label>Vitesse Eau: <span class="value-display" id="waterSpeedVal">9</span> km/h</label>
                                <input type="range" id="waterSpeed" min="5" max="30" value="9" step="1">
                            </div>

                            <div class="input-group">
                                <label>Force Courant Marin: <span class="value-display" id="currentVal">0</span>
                                    km/h</label>
                                <input type="range" id="current" min="0" max="10" value="0" step="0.5">
                            </div>

                            <div class="toggle-group">
                                <div class="toggle-switch">
                                    <input type="checkbox" id="surfaceMode">
                                    <label class="toggle-label" for="surfaceMode">üèÑ Surface Only</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Results -->
                    <div class="card calc-card">
                        <h2>üìä R√©sultats Autonomie</h2>
                        <div class="results calc-results">
                            <div class="result-box calc-result">
                                <div class="result-label">Consommation</div>
                                <div class="result-value" id="consumption">585</div>
                                <div class="result-unit">W</div>
                            </div>
                            <div class="result-box calc-result">
                                <div class="result-label">Autonomie</div>
                                <div class="result-value" id="autonomy">35</div>
                                <div class="result-unit">minutes</div>
                            </div>
                            <div class="result-box calc-result">
                                <div class="result-label">Distance</div>
                                <div class="result-value" id="distance">0</div>
                                <div class="result-unit">km</div>
                            </div>
                            <div class="result-box calc-result">
                                <div class="result-label">√ânergie Restante</div>
                                <div class="result-value" id="energyUsed">0</div>
                                <div class="result-unit">Wh</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mission Planner Section -->
                <div style="margin-top: 40px;">
                    <h2 class="chart-title" style="margin-bottom: 20px;">üó∫Ô∏è Planification Mission</h2>
                    <div class="calc-grid">
                        <div class="card calc-card">
                            <h2>Param√®tres Mission</h2>

                            <div class="input-group">
                                <label>Distance Point A ‚Üí B</label>
                                <input type="number" id="missionDistance" placeholder="km" value="10" min="0"
                                    step="0.5">
                            </div>

                            <div class="input-group">
                                <label>Vitesse Moyenne</label>
                                <select id="missionSpeed">
                                    <option value="9">9 km/h (Eau - Lent)</option>
                                    <option value="19">19 km/h (Eau - Moyen)</option>
                                    <option value="30">30 km/h (Eau - Rapide)</option>
                                    <option value="50">50 km/h (Air - Lent)</option>
                                    <option value="70">70 km/h (Air - Croisi√®re)</option>
                                    <option value="100">100 km/h (Air - Rapide)</option>
                                    <option value="160">160 km/h (Air - Vmax)</option>
                                </select>
                            </div>

                            <div class="input-group">
                                <label>Relief (Altitude Gain): <span class="value-display" id="reliefVal">0</span>
                                    m</label>
                                <input type="range" id="relief" min="0" max="500" value="0" step="50">
                            </div>

                            <div class="input-group">
                                <label>Batterie √† Utiliser</label>
                                <select id="batteryPercent">
                                    <option value="100">100% (Pleine)</option>
                                    <option value="90">90%</option>
                                    <option value="80">80%</option>
                                    <option value="70">70%</option>
                                    <option value="50">50%</option>
                                </select>
                            </div>

                            <button class="calc-btn-primary" onclick="calculateMission()">üéØ Calculer Mission</button>
                        </div>

                        <div class="card calc-card">
                            <h2>‚úÖ R√©sultats Mission</h2>
                            <div class="results calc-results">
                                <div class="result-box calc-result">
                                    <div class="result-label">Temps Trajet</div>
                                    <div class="result-value" id="missionTime">--</div>
                                    <div class="result-unit">min</div>
                                </div>
                                <div class="result-box calc-result">
                                    <div class="result-label">Batterie Requise</div>
                                    <div class="result-value" id="batteryNeeded">--</div>
                                    <div class="result-unit">%</div>
                                </div>
                                <div class="result-box calc-result">
                                    <div class="result-label">Batterie Restante</div>
                                    <div class="result-value" id="batteryRemaining">--</div>
                                    <div class="result-unit">%</div>
                                </div>
                                <div class="result-box calc-result">
                                    <div class="result-label">Status Mission</div>
                                    <div class="result-value" id="missionStatus">--</div>
                                    <div class="result-unit"></div>
                                </div>
                            </div>

                            <div id="missionAlert" class="calc-alert" style="display: none; margin-top: 20px;">
                                ‚ö†Ô∏è Batterie insuffisante pour cette mission!
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Specs Section -->
                <div style="margin-top: 40px;">
                    <h2 class="chart-title" style="margin-bottom: 20px;">üìã Sp√©cifications VOLTIGE V3</h2>
                    <div class="card calc-card">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 30px;">
                            <div>
                                <h3 style="color: var(--accent); margin-bottom: 15px;">Batterie</h3>
                                <p><strong>Type:</strong> Li-Ion 6S4P Molicel P50B</p>
                                <p><strong>Capacit√©:</strong> 20000 mAh</p>
                                <p><strong>√ânergie:</strong> 432 Wh (345.6 Wh utilisable)</p>
                                <p><strong>Voltage:</strong> 21.6V nominal</p>
                            </div>
                            <div>
                                <h3 style="color: var(--accent); margin-bottom: 15px;">Propulsion</h3>
                                <p><strong>Sustentation:</strong> 4√ó DarwinFPV 2307.5 V3</p>
                                <p><strong>Propulsion:</strong> 1√ó T-Motor F90 2806.5 150KV</p>
                                <p><strong>H√©lices Air:</strong> 5" tripales</p>
                                <p><strong>H√©lice Eau:</strong> 2" courb√©e √©paisse</p>
                            </div>
                            <div>
                                <h3 style="color: var(--accent); margin-bottom: 15px;">Dimensions & Poids</h3>
                                <p><strong>Longueur:</strong> 43 cm</p>
                                <p><strong>Envergure:</strong> 36 cm</p>
                                <p><strong>Poids Total:</strong> 2.6 kg</p>
                                <p><strong>Nez Allong√©:</strong> 5-7 cm (a√©rodynamisme)</p>
                            </div>
                            <div>
                                <h3 style="color: var(--accent); margin-bottom: 15px;">Performances</h3>
                                <p><strong>Vitesse Max Air:</strong> 160 km/h</p>
                                <p><strong>Vitesse Max Eau:</strong> 28 km/h</p>
                                <p><strong>Profondeur Max:</strong> 20m</p>
                                <p><strong>TWR:</strong> 2.87:1</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 4: Comparateur de Configurations -->
            <div id="comparateur" class="tab-content">
                <h2 class="chart-title" style="margin-bottom: 30px;">üîÑ Comparateur de Configurations</h2>

                <!-- Tableau Comparatif -->
                <div class="comparator-table-container">
                    <table class="comparator-table">
                        <thead>
                            <tr>
                                <th>M√©trique</th>
                                <th class="config-a">CONFIG A<br><span class="config-subtitle">L√©ger</span></th>
                                <th class="config-b">CONFIG B<br><span class="config-subtitle">Standard</span></th>
                                <th class="config-c">CONFIG C<br><span class="config-subtitle">Lourd</span></th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Batterie -->
                            <tr class="section-header">
                                <td colspan="4">üîã BATTERIE</td>
                            </tr>
                            <tr>
                                <td>Capacit√©</td>
                                <td>6000 mAh</td>
                                <td>15000 mAh</td>
                                <td>28000 mAh</td>
                            </tr>
                            <tr>
                                <td>Voltage</td>
                                <td>6S (22.2V)</td>
                                <td>6S (22.2V)</td>
                                <td>6S (22.2V)</td>
                            </tr>
                            <tr>
                                <td>√ânergie</td>
                                <td>132 Wh</td>
                                <td>330 Wh</td>
                                <td>604 Wh</td>
                            </tr>
                            <tr>
                                <td>Utilisable (80%)</td>
                                <td>106 Wh</td>
                                <td>264 Wh</td>
                                <td>483 Wh</td>
                            </tr>
                            <tr>
                                <td>Poids batterie</td>
                                <td class="highlight">300g</td>
                                <td class="highlight">750g</td>
                                <td class="highlight">1400g</td>
                            </tr>

                            <!-- Poids & Structure -->
                            <tr class="section-header">
                                <td colspan="4">‚öñÔ∏è POIDS & STRUCTURE</td>
                            </tr>
                            <tr>
                                <td>Poids structure</td>
                                <td>1300g</td>
                                <td>1300g</td>
                                <td>1300g</td>
                            </tr>
                            <tr>
                                <td><strong>POIDS TOTAL</strong></td>
                                <td class="highlight-strong">1.6 kg</td>
                                <td class="highlight-strong">2.05 kg</td>
                                <td class="highlight-strong">2.7 kg</td>
                            </tr>
                            <tr>
                                <td>Charge utile max</td>
                                <td>200g</td>
                                <td>700g</td>
                                <td>1200g</td>
                            </tr>

                            <!-- Moteurs -->
                            <tr class="section-header">
                                <td colspan="4">‚öôÔ∏è MOTEURS</td>
                            </tr>
                            <tr>
                                <td>Moteur</td>
                                <td>Darwin 2307.5</td>
                                <td>Darwin 2307.5</td>
                                <td>T-Motor F2806.5</td>
                            </tr>
                            <tr>
                                <td>Thrust/moteur</td>
                                <td>1200g</td>
                                <td>1200g</td>
                                <td>1400g</td>
                            </tr>
                            <tr>
                                <td>Thrust total (4√ó)</td>
                                <td>4800g</td>
                                <td>4800g</td>
                                <td>5600g</td>
                            </tr>
                            <tr>
                                <td><strong>TWR</strong></td>
                                <td class="highlight-strong">3.0:1</td>
                                <td class="highlight-strong">2.3:1</td>
                                <td class="highlight-strong">2.1:1</td>
                            </tr>

                            <!-- Autonomies -->
                            <tr class="section-header">
                                <td colspan="4">‚è±Ô∏è AUTONOMIES</td>
                            </tr>
                            <tr>
                                <td>Hover</td>
                                <td class="highlight">11 min</td>
                                <td class="highlight">27 min</td>
                                <td class="highlight">49 min</td>
                            </tr>
                            <tr>
                                <td>70 km/h (Croisi√®re)</td>
                                <td class="highlight">9 min</td>
                                <td class="highlight">23 min</td>
                                <td class="highlight">41 min</td>
                            </tr>
                            <tr>
                                <td>160 km/h (Vmax)</td>
                                <td class="highlight">7 min</td>
                                <td class="highlight">18 min</td>
                                <td class="highlight">32 min</td>
                            </tr>
                            <tr>
                                <td>Eau 9 km/h</td>
                                <td class="highlight">57 min</td>
                                <td class="highlight">141 min</td>
                                <td class="highlight">259 min</td>
                            </tr>
                            <tr>
                                <td>Eau 19 km/h</td>
                                <td class="highlight">31 min</td>
                                <td class="highlight">76 min</td>
                                <td class="highlight">139 min</td>
                            </tr>

                            <!-- Sp√©cifications -->
                            <tr class="section-header">
                                <td colspan="4">üìã SP√âCIFICATIONS</td>
                            </tr>
                            <tr>
                                <td>Profondeur max</td>
                                <td>15m</td>
                                <td>20m</td>
                                <td>20m</td>
                            </tr>
                            <tr>
                                <td>Distance couvrable</td>
                                <td>~10 km</td>
                                <td>~27 km</td>
                                <td>~49 km</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Cas d'Usage -->
                <div style="margin-top: 60px;">
                    <h2 class="chart-title" style="margin-bottom: 30px;">üìå Cas d'Usage Optimaux</h2>

                    <div class="use-cases-grid">
                        <!-- CONFIG A -->
                        <div class="use-case-card" style="border-left: 4px solid #FFD166;">
                            <h3 style="color: #FFD166; margin-bottom: 15px;">CONFIG A - L√âGER</h3>
                            <p style="font-size: 0.9em; color: var(--muted); margin-bottom: 15px;">
                                <strong>Poids:</strong> 1.6 kg | <strong>Autonomie max:</strong> 57 min eau
                            </p>

                            <div style="margin-bottom: 15px;">
                                <h4 style="color: var(--text); margin-bottom: 8px;">‚ùå Non recommand√© pour:</h4>
                                <ul style="margin-left: 20px; color: var(--muted); font-size: 0.9em;">
                                    <li>Sauvetage maritime (trop court)</li>
                                    <li>Inspection longue (manque autonomie)</li>
                                    <li>Surveillance zones</li>
                                </ul>
                            </div>

                            <div>
                                <h4 style="color: var(--text); margin-bottom: 8px;">‚úÖ Id√©al pour:</h4>
                                <ul style="margin-left: 20px; color: var(--muted); font-size: 0.9em;">
                                    <li>Prototypes & tests</li>
                                    <li>D√©ploiement rapide</li>
                                    <li>Essaims (5-10 drones)</li>
                                </ul>
                            </div>
                        </div>

                        <!-- CONFIG B -->
                        <div class="use-case-card" style="border-left: 4px solid #FF6B6B;">
                            <h3 style="color: #FF6B6B; margin-bottom: 15px;">CONFIG B - STANDARD ‚≠ê MEILLEUR COMPROMIS
                            </h3>
                            <p style="font-size: 0.9em; color: var(--muted); margin-bottom: 15px;">
                                <strong>Poids:</strong> 2.05 kg | <strong>Autonomie max:</strong> 141 min eau
                            </p>

                            <div
                                style="background: rgba(255, 107, 107, 0.1); padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                                <p style="font-size: 0.85em; margin: 0;">‚úÖ <strong>Meilleur pour:</strong> Sauvetage
                                    maritime, Inspection standard, Surveillance urgence, Recherche acad√©mique</p>
                            </div>

                            <div>
                                <h4 style="color: var(--text); margin-bottom: 8px;">Cas d'usage couverts:</h4>
                                <ul style="margin-left: 20px; color: var(--muted); font-size: 0.9em;">
                                    <li>üö¢ Sauvetage SNSM (27 km couverture)</li>
                                    <li>üîß Inspection pipeline (55 min plong√©e)</li>
                                    <li>üåä Surveillance crue (5-10 km¬≤ par mission)</li>
                                    <li>üî¨ Science c√¥ti√®re (2-3h patrouille)</li>
                                </ul>
                            </div>
                        </div>

                        <!-- CONFIG C -->
                        <div class="use-case-card" style="border-left: 4px solid #00E5FF;">
                            <h3 style="color: #00E5FF; margin-bottom: 15px;">CONFIG C - LOURD (PROFESSIONNEL)</h3>
                            <p style="font-size: 0.9em; color: var(--muted); margin-bottom: 15px;">
                                <strong>Poids:</strong> 2.7 kg | <strong>Autonomie max:</strong> 259 min eau
                            </p>

                            <div style="margin-bottom: 15px;">
                                <h4 style="color: var(--text); margin-bottom: 8px;">üî• Pour missions longues:</h4>
                                <ul style="margin-left: 20px; color: var(--muted); font-size: 0.9em;">
                                    <li>Inspection longue (100+ min sous l'eau)</li>
                                    <li>Recherche scientifique (4.3h patrouille)</li>
                                    <li>Surveillance complexe (49 km couverture)</li>
                                    <li>Cam√©ra thermique + multi-capteurs</li>
                                </ul>
                            </div>

                            <div>
                                <h4 style="color: var(--text); margin-bottom: 8px;">‚ö†Ô∏è Contrainte:</h4>
                                <p style="margin-left: 20px; color: var(--muted); font-size: 0.9em;">Plus lent √†
                                    d√©ployer (2.7 kg), moteurs plus puissants requis</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 5: Live Telemetry Dashboard -->
            <div id="telemetry" class="tab-content">
                <h2 class="chart-title" style="margin-bottom: 20px;">üì° LIVE TELEMETRY DASHBOARD</h2>

                <!-- Controls -->
                <div style="display: flex; gap: 12px; margin-bottom: 24px;">
                    <button id="telemetry-start" class="calc-btn-primary"
                        style="flex: 1; background: linear-gradient(135deg, #00e5ff, #00ffc6);">‚ñ∂Ô∏è START
                        SIMULATION</button>
                    <button id="telemetry-stop" class="calc-btn-primary"
                        style="flex: 1; background: #999; cursor: not-allowed;" disabled>‚èπÔ∏è STOP</button>
                    <button id="telemetry-reset" class="calc-btn-primary" style="flex: 1;">üîÑ RESET</button>
                </div>

                <!-- Main Layout: 3 Columns -->
                <div class="telemetry-layout">
                    <!-- COLUMN 1: STATUS GLOBAL -->
                    <div class="telemetry-section">
                        <div class="telemetry-card">
                            <h3 style="color: var(--accent); margin-bottom: 16px;">üöÅ FLIGHT STATUS</h3>
                            <div class="status-item">
                                <span class="status-label">√âtat</span>
                                <span id="telem-flight-state" class="status-value" style="color: #00e5ff;">EN
                                    ATTENTE</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">Dur√©e vol</span>
                                <span id="telem-flight-time" class="status-value">00:00</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">Prochaine action</span>
                                <span id="telem-next-action" class="status-value" style="font-size: 0.85em;">--</span>
                            </div>
                        </div>

                        <div class="telemetry-card">
                            <h3 style="color: var(--accent); margin-bottom: 16px;">üìç POSITION</h3>
                            <div class="status-item">
                                <span class="status-label">GPS</span>
                                <span id="telem-gps" class="status-value" style="font-size: 0.85em;">--</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">Altitude</span>
                                <span id="telem-altitude" class="status-value">0 m</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">Distance base</span>
                                <span id="telem-distance" class="status-value">0 km</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">Cap</span>
                                <span id="telem-heading" class="status-value">0¬∞</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">Vitesse sol</span>
                                <span id="telem-groundspeed" class="status-value">0 km/h</span>
                            </div>
                        </div>

                        <div class="telemetry-card">
                            <h3 style="color: var(--accent); margin-bottom: 16px;">üîã BATTERIE</h3>
                            <div class="battery-bar">
                                <div id="telem-battery-bar" class="battery-fill" style="width: 100%;"></div>
                            </div>
                            <div class="status-item">
                                <span class="status-label">Voltage</span>
                                <span id="telem-voltage" class="status-value">21.6V</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">Courant</span>
                                <span id="telem-current" class="status-value">0 A</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">Puissance</span>
                                <span id="telem-power" class="status-value">0 W</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">Temps vol</span>
                                <span id="telem-battery-time" class="status-value" style="color: #ff6b6b;">--</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">Temp√©rature</span>
                                <span id="telem-battery-temp" class="status-value">35¬∞C</span>
                            </div>
                        </div>

                        <div class="telemetry-card">
                            <h3 style="color: var(--accent); margin-bottom: 16px;">‚öôÔ∏è SANT√â SYST√àME</h3>
                            <div class="status-item">
                                <span class="status-label">CPU Load</span>
                                <span id="telem-cpu" class="status-value">0%</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">RAM</span>
                                <span id="telem-ram" class="status-value">0/256 MB</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">Loop rate</span>
                                <span id="telem-looprate" class="status-value">400Hz</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">Latence</span>
                                <span id="telem-latency" class="status-value">45ms</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">Signal 4G</span>
                                <span id="telem-4g" class="status-value" style="color: #FFD166;">-95 dBm</span>
                            </div>
                        </div>
                    </div>

                    <!-- COLUMN 2: CHARTS -->
                    <div class="telemetry-section telemetry-charts">
                        <div class="telemetry-card">
                            <h3 style="color: var(--accent); margin-bottom: 12px;">üìà ALTITUDE</h3>
                            <canvas id="chart-altitude" style="max-height: 200px;"></canvas>
                        </div>
                        <div class="telemetry-card">
                            <h3 style="color: var(--accent); margin-bottom: 12px;">üí® VITESSE</h3>
                            <canvas id="chart-speed" style="max-height: 200px;"></canvas>
                        </div>
                        <div class="telemetry-card">
                            <h3 style="color: var(--accent); margin-bottom: 12px;">üîå BATTERIE %</h3>
                            <canvas id="chart-battery" style="max-height: 200px;"></canvas>
                        </div>
                        <div class="telemetry-card">
                            <h3 style="color: var(--accent); margin-bottom: 12px;">‚ö° PUISSANCE</h3>
                            <canvas id="chart-power" style="max-height: 200px;"></canvas>
                        </div>
                    </div>

                    <!-- COLUMN 3: D√âTAILS CAPTEURS & ALERTES -->
                    <div class="telemetry-section">
                        <div class="telemetry-card">
                            <h3 style="color: var(--accent); margin-bottom: 12px;">üö® ALERTES EN TEMPS R√âEL</h3>
                            <div id="telem-alerts" style="max-height: 300px; overflow-y: auto; font-size: 0.85em;">
                                <div style="color: var(--muted); text-align: center; padding: 20px;">
                                    Aucune alerte
                                </div>
                            </div>
                        </div>

                        <div class="telemetry-card">
                            <h3 style="color: var(--accent); margin-bottom: 12px;">üéÆ MOTEURS</h3>
                            <div class="status-item">
                                <span class="status-label">M1 (Front-L)</span>
                                <span id="telem-motor-1" class="status-value" style="font-size: 0.85em;">0 RPM</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">M2 (Front-R)</span>
                                <span id="telem-motor-2" class="status-value" style="font-size: 0.85em;">0 RPM</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">M3 (Back-L)</span>
                                <span id="telem-motor-3" class="status-value" style="font-size: 0.85em;">0 RPM</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">M4 (Back-R)</span>
                                <span id="telem-motor-4" class="status-value" style="font-size: 0.85em;">0 RPM</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">M5 (Pusher)</span>
                                <span id="telem-motor-5" class="status-value" style="font-size: 0.85em;">0 RPM</span>
                            </div>
                        </div>

                        <div class="telemetry-card">
                            <h3 style="color: var(--accent); margin-bottom: 12px;">üß≠ ORIENTATION (IMU)</h3>
                            <div class="status-item">
                                <span class="status-label">Pitch</span>
                                <span id="telem-pitch" class="status-value">0¬∞</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">Roll</span>
                                <span id="telem-roll" class="status-value">0¬∞</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">Yaw</span>
                                <span id="telem-yaw" class="status-value">0¬∞</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">Stabilit√©</span>
                                <span id="telem-stability" class="status-value"
                                    style="color: #00e5ff;">EXCELLENTE</span>
                            </div>
                        </div>

                        <div class="telemetry-card">
                            <h3 style="color: var(--accent); margin-bottom: 12px;">üåä MODE EAU</h3>
                            <div class="status-item">
                                <span class="status-label">√âtat</span>
                                <span id="telem-water-state" class="status-value">INACTIF</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">Profondeur</span>
                                <span id="telem-depth" class="status-value">0 m</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">Temp eau</span>
                                <span id="telem-water-temp" class="status-value">--</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">Beacon</span>
                                <span id="telem-beacon" class="status-value" style="color: #FFD166;">DORMANT</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Timeline Mission -->
                <div style="margin-top: 40px;">
                    <h3 style="color: var(--accent); margin-bottom: 16px;">üìã LOG √âV√âNEMENTS</h3>
                    <div id="telem-timeline"
                        style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 16px; background: rgba(255,255,255,0.02);">
                        <div style="color: var(--muted); text-align: center;">√âv√©nements en attente...</div>
                    </div>
                </div>
            </div>

            <!-- Tab 6: Mission Builder - R√âALISTE v2 -->
            <div id="mission-builder" class="tab-content">
                <div id="mb-container" style="padding: 20px;">
                    <!-- √âTAPE 1: Scenario Selection - AM√âLIOR√â -->
                    <div id="mb-step1" class="mb-step active">
                        <h2 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <span
                                style="background: linear-gradient(135deg, #7c5cff, #00e5ff); padding: 8px 12px; border-radius: 6px; color: white; font-size: 14px; font-weight: 600;">√âTAPE
                                1</span>
                            S√©lectionne ton sc√©nario
                        </h2>
                        <div
                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;">
                            <!-- Maritime Rescue -->
                            <div class="scenario-card" data-scenario="maritime">
                                <div style="font-size: 48px; margin-bottom: 12px;">üåä</div>
                                <h3>Sauvetage Maritime</h3>
                                <p style="color: var(--muted); font-size: 14px; margin: 8px 0;"><strong>Personne √† la
                                        mer, zone c√¥ti√®re</strong></p>
                                <ul style="font-size: 13px; color: var(--muted); margin: 12px 0; list-style: none;">
                                    <li>‚è±Ô∏è <strong>Temps critique</strong>: 15-30 min</li>
                                    <li>üì¶ <strong>Payload</strong>: Beacon + Cam√©ra HD</li>
                                    <li>üìè <strong>Distance type</strong>: 5-30 km</li>
                                    <li>üåä <strong>Profondeur</strong>: 10-20m</li>
                                    <li>‚úàÔ∏è <strong>Autonomie requise</strong>: Min 25 min</li>
                                </ul>
                            </div>
                            <!-- Underwater Inspection -->
                            <div class="scenario-card" data-scenario="underwater">
                                <div style="font-size: 48px; margin-bottom: 12px;">üíß</div>
                                <h3>Inspection Sous-marine</h3>
                                <p style="color: var(--muted); font-size: 14px; margin: 8px 0;">
                                    <strong>Pipeline/c√¢bles/structures</strong>
                                </p>
                                <ul style="font-size: 13px; color: var(--muted); margin: 12px 0; list-style: none;">
                                    <li>üåä <strong>Profondeur</strong>: 5-20m (toi qui choisis)</li>
                                    <li>üì¶ <strong>Payload</strong>: Cam√©ra thermique + LED</li>
                                    <li>üìè <strong>Distance inspection</strong>: 500m-5km</li>
                                    <li>‚úàÔ∏è <strong>Autonomie requise</strong>: 60-120 min</li>
                                    <li>üîÑ <strong>Plong√©e multi-profondeur OK</strong></li>
                                </ul>
                            </div>
                            <!-- Flooded Zone -->
                            <div class="scenario-card" data-scenario="flooded">
                                <div style="font-size: 48px; margin-bottom: 12px;">üåä</div>
                                <h3>Zone Inond√©e</h3>
                                <p style="color: var(--muted); font-size: 14px; margin: 8px 0;"><strong>Cartographie
                                        d√©g√¢ts + survivants</strong></p>
                                <ul style="font-size: 13px; color: var(--muted); margin: 12px 0; list-style: none;">
                                    <li>üó∫Ô∏è <strong>Zone</strong>: 5-20 km¬≤</li>
                                    <li>üìπ <strong>Cam√©ra thermique</strong> + d√©tection</li>
                                    <li>‚è±Ô∏è <strong>Urgence</strong>: Maximale</li>
                                    <li>üöÅ <strong>Autonomie</strong>: 45-90 min</li>
                                    <li>üìä <strong>CONFIG C recommand√©e</strong></li>
                                </ul>
                            </div>
                            <!-- Scientific Research -->
                            <div class="scenario-card" data-scenario="research">
                                <div style="font-size: 48px; margin-bottom: 12px;">üî¨</div>
                                <h3>Recherche Scientifique</h3>
                                <p style="color: var(--muted); font-size: 14px; margin: 8px 0;"><strong>Pr√©l√®vements +
                                        capteurs eau</strong></p>
                                <ul style="font-size: 13px; color: var(--muted); margin: 12px 0; list-style: none;">
                                    <li>‚è±Ô∏è <strong>Autonomie</strong>: 2-5 heures</li>
                                    <li>üì¶ <strong>6 capteurs eau</strong> int√©gr√©s</li>
                                    <li>üîÑ <strong>Multi-waypoints</strong> stations</li>
                                    <li>üíæ <strong>Stockage donn√©es</strong>: 847+ KB</li>
                                    <li>üèÜ <strong>CONFIG C recommand√©e</strong></li>
                                </ul>
                            </div>
                            <!-- Custom -->
                            <div class="scenario-card" data-scenario="custom">
                                <div style="font-size: 48px; margin-bottom: 12px;">‚ûï</div>
                                <h3>Personnalis√©</h3>
                                <p style="color: var(--muted); font-size: 14px; margin: 8px 0;"><strong>D√©finis tout
                                        toi-m√™me</strong></p>
                                <ul style="font-size: 13px; color: var(--muted); margin: 12px 0; list-style: none;">
                                    <li>üé® <strong>Template vierge</strong></li>
                                    <li>üîß <strong>Pas de contraintes</strong></li>
                                    <li>‚ú® <strong>Flexibilit√© maximale</strong></li>
                                    <li>üìê <strong>Poids/autonomie libres</strong></li>
                                    <li>üéØ <strong>Payloads custom</strong></li>
                                </ul>
                            </div>
                        </div>
                        <div style="margin-top: 24px;">
                            <button id="mb-continue-step1" class="mb-btn-primary" disabled
                                style="opacity: 0.5; cursor: not-allowed;">
                                Continuer vers √âTAPE 2 ‚Üí
                            </button>
                        </div>
                    </div>

                    <!-- √âTAPE 2: Map Interactive & Waypoints - D√âTAILL√â -->
                    <div id="mb-step2" class="mb-step" style="display: none;">
                        <h2 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <span
                                style="background: linear-gradient(135deg, #7c5cff, #00e5ff); padding: 8px 12px; border-radius: 6px; color: white; font-size: 14px; font-weight: 600;">√âTAPE
                                2</span>
                            Dessine ton trajet sur la map
                        </h2>
                        <div style="display: grid; grid-template-columns: 1fr 400px; gap: 20px;">
                            <div>
                                <div id="mb-map"
                                    style="height: 500px; border-radius: 12px; overflow: hidden; border: 2px solid var(--accent-2);">
                                </div>
                                <p style="color: var(--muted); font-size: 13px; margin-top: 12px;">
                                    üñ±Ô∏è <strong>CLICK</strong> sur map = ajouter waypoint ‚Ä¢
                                    <strong>DOUBLE-CLICK</strong> = √©diter d√©tails ‚Ä¢ <strong>DELETE</strong> = supprimer
                                </p>
                            </div>
                            <div
                                style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 16px; max-height: 600px; overflow-y: auto;">
                                <h3 style="margin-bottom: 12px;">üìç Waypoints D√©tails</h3>
                                <div id="mb-waypoints-list" style="font-size: 12px;">
                                    <div style="color: var(--muted); text-align: center; padding: 20px 0;">Clique sur la
                                        map pour ajouter</div>
                                </div>
                                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                                    <h4 style="margin-bottom: 12px; font-size: 13px;">üìä R√âSUM√â TRAJET</h4>
                                    <div style="font-size: 11px; color: var(--muted);">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                            <span>üìè Distance totale:</span>
                                            <strong id="mb-total-distance">0.0</strong> km
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                            <span>‚è±Ô∏è Temps vol (est):</span>
                                            <strong id="mb-total-time">0:00</strong>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                            <span>üîã Batterie utilis√©e:</span>
                                            <strong id="mb-total-battery">0%</strong>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>‚úàÔ∏è Autonomie restante:</span>
                                            <strong id="mb-battery-remaining" style="color: #00e5ff;">100%</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 24px; display: flex; gap: 12px;">
                            <button id="mb-back-step1" class="mb-btn-secondary">‚Üê Retour √âTAPE 1</button>
                            <button id="mb-continue-step2" class="mb-btn-primary" disabled
                                style="opacity: 0.5; cursor: not-allowed;">
                                Continuer vers √âTAPE 3 ‚Üí
                            </button>
                        </div>
                    </div>

                    <!-- √âTAPE 3: Actions at Waypoints - 6 TYPES D√âTAILL√âS -->
                    <div id="mb-step3" class="mb-step" style="display: none;">
                        <h2 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <span
                                style="background: linear-gradient(135deg, #7c5cff, #00e5ff); padding: 8px 12px; border-radius: 6px; color: white; font-size: 14px; font-weight: 600;">√âTAPE
                                3</span>
                            Actions pour chaque waypoint
                        </h2>
                        <p style="color: var(--muted); margin-bottom: 20px;">S√©lectionne les actions √† ex√©cuter √† chaque
                            waypoint. Chaque action consomme batterie et temps.</p>
                        <div id="mb-actions-container" style="display: grid; gap: 16px;">
                            <!-- Dynamically populated with waypoint action panels -->
                        </div>
                        <div style="margin-top: 24px; display: flex; gap: 12px;">
                            <button id="mb-back-step2" class="mb-btn-secondary">‚Üê Retour √âTAPE 2</button>
                            <button id="mb-continue-step3" class="mb-btn-primary">
                                Continuer vers √âTAPE 4 ‚Üí
                            </button>
                        </div>
                    </div>

                    <!-- √âTAPE 4: Environment Conditions - 8 PARAM√àTRES + FORMULES -->
                    <div id="mb-step4" class="mb-step" style="display: none;">
                        <h2 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <span
                                style="background: linear-gradient(135deg, #7c5cff, #00e5ff); padding: 8px 12px; border-radius: 6px; color: white; font-size: 14px; font-weight: 600;">√âTAPE
                                4</span>
                            Conditions environnement r√©alistes
                        </h2>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <!-- LEFT COLUMN: Conditions -->
                            <div
                                style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 24px;">
                                <h3 style="margin-bottom: 20px;">‚öôÔ∏è Param√®tres</h3>

                                <!-- VENT -->
                                <div style="margin-bottom: 24px;">
                                    <label style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                        <span>üå¨Ô∏è Vent</span>
                                        <input type="range" id="mb-wind" min="0" max="30" value="5" style="flex: 1;">
                                        <span id="mb-wind-val" style="font-weight: bold; min-width: 40px;">5</span> km/h
                                    </label>
                                    <p id="mb-wind-impact" style="color: var(--muted); font-size: 11px; margin: 0;">
                                        Impact: +0% batterie</p>
                                </div>

                                <!-- VISIBILIT√â -->
                                <div style="margin-bottom: 24px;">
                                    <label style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                        <span>üëÅÔ∏è Visibilit√©</span>
                                        <input type="range" id="mb-visibility" min="10" max="1000" value="200"
                                            style="flex: 1;">
                                        <span id="mb-visibility-val"
                                            style="font-weight: bold; min-width: 40px;">200</span> m
                                    </label>
                                    <p id="mb-visibility-impact"
                                        style="color: var(--muted); font-size: 11px; margin: 0;">Impact: 0% d√©tection
                                    </p>
                                </div>

                                <!-- VAGUES -->
                                <div style="margin-bottom: 24px;">
                                    <label style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                        <span>üåä Vagues</span>
                                        <input type="range" id="mb-waves" min="0" max="5" value="1" step="0.1"
                                            style="flex: 1;">
                                        <span id="mb-waves-val" style="font-weight: bold; min-width: 40px;">1</span> m
                                    </label>
                                    <p id="mb-waves-impact" style="color: var(--muted); font-size: 11px; margin: 0;">
                                        Impact: Stable</p>
                                </div>

                                <!-- TEMP√âRATURE -->
                                <div style="margin-bottom: 24px;">
                                    <label style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                        <span>üå°Ô∏è Temp eau</span>
                                        <input type="range" id="mb-temp" min="-2" max="30" value="12" style="flex: 1;">
                                        <span id="mb-temp-val" style="font-weight: bold; min-width: 40px;">12</span>¬∞C
                                    </label>
                                    <p id="mb-temp-impact" style="color: var(--muted); font-size: 11px; margin: 0;">
                                        Impact: -8% batterie</p>
                                </div>

                                <!-- M√âT√âO -->
                                <div style="margin-bottom: 24px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">‚òÄÔ∏è
                                        M√©t√©o</label>
                                    <select id="mb-weather"
                                        style="width: 100%; padding: 8px; background: var(--glass); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
                                        <option value="clear">‚òÄÔ∏è D√©gag√© (100%)</option>
                                        <option value="cloudy" selected>‚òÅÔ∏è Nuageux (80%)</option>
                                        <option value="light-rain">üåßÔ∏è Pluie l√©g√®re (60%)</option>
                                        <option value="heavy-rain">‚õàÔ∏è Pluie forte (40%)</option>
                                    </select>
                                    <p id="mb-weather-impact"
                                        style="color: var(--muted); font-size: 11px; margin: 4px 0 0 0;">Impact: 0%
                                        d√©tection</p>
                                </div>

                                <!-- HEURE -->
                                <div style="margin-bottom: 24px;">
                                    <label style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                        <span>üåô Heure</span>
                                        <input type="time" id="mb-time" value="14:00"
                                            style="padding: 6px; background: var(--glass); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
                                    </label>
                                    <p id="mb-time-impact" style="color: var(--muted); font-size: 11px; margin: 0;">
                                        Impact: Jour optimal</p>
                                </div>

                                <!-- TYPE EAU -->
                                <div style="margin-bottom: 24px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">üíß Type
                                        eau</label>
                                    <select id="mb-water-type"
                                        style="width: 100%; padding: 8px; background: var(--glass); border: 1px solid var(--border); border-radius: 6px; color: var(--text);">
                                        <option value="fresh">üíß Eau douce</option>
                                        <option value="coastal" selected">üåä Eau c√¥ti√®re</option>
                                        <option value="ocean">üåä Oc√©an clair</option>
                                    </select>
                                    <p id="mb-water-type-impact"
                                        style="color: var(--muted); font-size: 11px; margin: 4px 0 0 0;">Impact:
                                        Turbidit√©</p>
                                </div>

                                <!-- COURANT -->
                                <div style="margin-bottom: 0;">
                                    <label style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                        <span>üß≤ Courant</span>
                                        <input type="range" id="mb-current" min="0" max="5" value="0.5" step="0.1"
                                            style="flex: 1;">
                                        <span id="mb-current-val" style="font-weight: bold; min-width: 40px;">0.5</span>
                                        km/h
                                    </label>
                                    <p id="mb-current-impact" style="color: var(--muted); font-size: 11px; margin: 0;">
                                        Impact: D√©rive 0 m</p>
                                </div>
                            </div>

                            <!-- RIGHT COLUMN: Analysis -->
                            <div
                                style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 24px;">
                                <h3 style="margin-bottom: 20px;">üìä Analyse Impact</h3>

                                <div
                                    style="background: rgba(124, 92, 255, 0.1); border-left: 4px solid #7c5cff; padding: 12px; border-radius: 6px; margin-bottom: 16px;">
                                    <p style="font-size: 12px; margin: 0;"><strong>Batterie:</strong></p>
                                    <p id="mb-analysis-battery"
                                        style="font-size: 14px; font-weight: bold; color: #00e5ff; margin: 4px 0 0 0;">
                                        38% ‚Üí 38% (-0%)</p>
                                </div>

                                <div
                                    style="background: rgba(255, 209, 102, 0.1); border-left: 4px solid #ffd166; padding: 12px; border-radius: 6px; margin-bottom: 16px;">
                                    <p style="font-size: 12px; margin: 0;"><strong>D√©tection Succ√®s:</strong></p>
                                    <p id="mb-analysis-detection"
                                        style="font-size: 14px; font-weight: bold; color: #ffd166; margin: 4px 0 0 0;">
                                        87% (excellent)</p>
                                </div>

                                <div
                                    style="background: rgba(0, 255, 136, 0.1); border-left: 4px solid #00ff88; padding: 12px; border-radius: 6px; margin-bottom: 16px;">
                                    <p style="font-size: 12px; margin: 0;"><strong>Temps Mission:</strong></p>
                                    <p id="mb-analysis-time"
                                        style="font-size: 14px; font-weight: bold; color: #00ff88; margin: 4px 0 0 0;">
                                        22 min 7 sec</p>
                                </div>

                                <div
                                    style="background: rgba(255, 107, 107, 0.1); border-left: 4px solid #ff6b6b; padding: 12px; border-radius: 6px; margin-bottom: 16px;">
                                    <p style="font-size: 12px; margin: 0;"><strong>Risques:</strong></p>
                                    <p id="mb-analysis-risks"
                                        style="font-size: 13px; color: #ff6b6b; margin: 4px 0 0 0;">Aucun‚†Ärisque majeur
                                    </p>
                                </div>

                                <div
                                    style="background: rgba(0, 229, 255, 0.1); border-left: 4px solid #00e5ff; padding: 12px; border-radius: 6px;">
                                    <p style="font-size: 12px; margin: 0;"><strong>Recommandations:</strong></p>
                                    <p id="mb-analysis-recommendations"
                                        style="font-size: 12px; color: #00e5ff; margin: 4px 0 0 0;">Mission faisable
                                        avec marge de s√©curit√© confortable</p>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 24px; display: flex; gap: 12px;">
                            <button id="mb-back-step3" class="mb-btn-secondary">‚Üê Retour √âTAPE 3</button>
                            <button id="mb-continue-step4" class="mb-btn-primary">
                                Continuer vers √âTAPE 5 ‚Üí
                            </button>
                        </div>
                    </div>

                    <!-- √âTAPE 5: Drone Config & Simulation LAUNCHER -->
                    <div id="mb-step5" class="mb-step" style="display: none;">
                        <h2 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <span
                                style="background: linear-gradient(135deg, #7c5cff, #00e5ff); padding: 8px 12px; border-radius: 6px; color: white; font-size: 14px; font-weight: 600;">√âTAPE
                                5</span>
                            Config drone & Lancer simulation
                        </h2>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div
                                style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 20px;">
                                <h3>üöÅ Configuration</h3>
                                <div style="margin-top: 16px;">
                                    <label style="display: block; margin-bottom: 12px;">
                                        <input type="radio" name="config" value="A"> <strong>CONFIG A</strong> (L√©ger) -
                                        2.05 kg max
                                    </label>
                                    <label style="display: block; margin-bottom: 12px;">
                                        <input type="radio" name="config" value="B" checked> <strong>CONFIG B</strong>
                                        (Standard) - 3.0 kg max ‚≠ê
                                    </label>
                                    <label style="display: block; margin-bottom: 12px;">
                                        <input type="radio" name="config" value="C"> <strong>CONFIG C</strong> (Lourd) -
                                        4.5 kg max
                                    </label>
                                </div>
                                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
                                    <h4>üì¶ Payloads (int√©gr√©s par d√©faut)</h4>
                                    <p style="font-size: 11px; color: var(--muted); margin: 0 0 12px 0;">VOLTIGE V3
                                        inclut: Beacon, Cam√©ra HD 4K, Capteurs eau x6, LED</p>
                                    <label style="display: block; margin-bottom: 8px; font-size: 13px;">
                                        <input type="checkbox" class="mb-payload" value="thermal" data-weight="0.2"
                                            checked> Cam√©ra Thermique (200g) - OPTIONNEL
                                    </label>
                                    <label style="display: block; margin-bottom: 8px; font-size: 13px;">
                                        <input type="checkbox" class="mb-payload" value="extra-led" data-weight="0.05">
                                        LED suppl√©mentaire (50g) - OPTIONNEL
                                    </label>
                                </div>
                            </div>

                            <div
                                style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 20px;">
                                <h3>üìä R√©sum√© Mission</h3>
                                <div style="margin-top: 16px; font-size: 13px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span>Poids drone:</span>
                                        <strong id="mb-drone-weight">2.1</strong> kg
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span>Poids payload:</span>
                                        <strong id="mb-payload-weight">0.2</strong> kg
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
                                        <span>Poids total:</span>
                                        <strong id="mb-total-weight">2.3</strong> kg
                                    </div>
                                    <div
                                        style="border-top: 1px solid var(--border); padding-top: 8px; margin-top: 8px;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                            <span>Autonomie th√©orique:</span>
                                            <strong id="mb-autonomy-theo">35</strong> min
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                            <span>Autonomie effective:</span>
                                            <strong id="mb-autonomy-mission">32</strong> min
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                            <span>Dur√©e trajet:</span>
                                            <strong id="mb-flight-duration">8.4</strong> min
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>Marge batterie:</span>
                                            <strong id="mb-battery-margin" style="color: #00e5ff;">38%</strong>
                                        </div>
                                    </div>
                                </div>
                                <div id="mb-warnings" style="margin-top: 16px;"></div>
                            </div>
                        </div>

                        <div style="margin-top: 24px;">
                            <button id="mb-launch-simulation" class="mb-btn-primary"
                                style="width: 100%; padding: 12px; font-size: 16px;">
                                üöÄ LANCER SIMULATION R√âALISTE
                            </button>
                        </div>

                        <div style="margin-top: 24px; display: flex; gap: 12px;">
                            <button id="mb-back-step4" class="mb-btn-secondary">‚Üê Retour √âTAPE 4</button>
                        </div>
                    </div>

                    <!-- R√âSULTAT: LIVE TELEMETRY DASHBOARD -->
                    <div id="mb-result" class="mb-step" style="display: none;">
                        <h2 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <span
                                style="background: linear-gradient(135deg, #ff6b6b, #ffd166); padding: 8px 12px; border-radius: 6px; color: white; font-size: 13px; font-weight: 600;">üé¨
                                T√âL√âM√âTRIE EN DIRECT</span>
                        </h2>

                        <!-- LIVE TELEMETRY -->
                        <div id="mb-live-telemetry" style="display: none;">
                            <!-- Main Metrics Grid -->
                            <div
                                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 20px;">
                                <!-- Time -->
                                <div
                                    style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 16px; text-align: center;">
                                    <div style="font-size: 11px; color: var(--muted); margin-bottom: 4px;">üïê TEMPS
                                    </div>
                                    <div style="font-size: 24px; font-weight: bold; color: #00e5ff;" id="telem-time">
                                        00:00:00</div>
                                </div>

                                <!-- Battery -->
                                <div
                                    style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 16px; text-align: center;">
                                    <div style="font-size: 11px; color: var(--muted); margin-bottom: 4px;">‚ö° BATTERIE
                                    </div>
                                    <div style="font-size: 24px; font-weight: bold; color: #00ff88;" id="telem-battery">
                                        100%</div>
                                    <div
                                        style="background: rgba(0,229,255,0.1); height: 6px; border-radius: 3px; margin-top: 8px; overflow: hidden;">
                                        <div id="telem-battery-bar"
                                            style="height: 100%; background: #00ff88; width: 100%; transition: width 0.2s;">
                                        </div>
                                    </div>
                                </div>

                                <!-- Speed -->
                                <div
                                    style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 16px; text-align: center;">
                                    <div style="font-size: 11px; color: var(--muted); margin-bottom: 4px;">üöÄ VITESSE
                                    </div>
                                    <div style="font-size: 24px; font-weight: bold; color: #ffd166;" id="telem-speed">0
                                        km/h</div>
                                </div>

                                <!-- Altitude/Profondeur -->
                                <div
                                    style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 16px; text-align: center;">
                                    <div style="font-size: 11px; color: var(--muted); margin-bottom: 4px;">üìè ALT/PROF
                                    </div>
                                    <div style="font-size: 24px; font-weight: bold; color: #7c5cff;"
                                        id="telem-altitude">0 m</div>
                                </div>

                                <!-- Waypoint -->
                                <div
                                    style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 16px; text-align: center;">
                                    <div style="font-size: 11px; color: var(--muted); margin-bottom: 4px;">üéØ WAYPOINT
                                    </div>
                                    <div style="font-size: 24px; font-weight: bold; color: #ff6b6b;"
                                        id="telem-waypoint">WP0</div>
                                </div>

                                <!-- Distance -->
                                <div
                                    style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 16px; text-align: center;">
                                    <div style="font-size: 11px; color: var(--muted); margin-bottom: 4px;">üìç PARCOURUE
                                    </div>
                                    <div style="font-size: 20px; font-weight: bold; color: #00e5ff;"
                                        id="telem-distance">0.00 km</div>
                                </div>
                            </div>

                            <!-- Progress Bar -->
                            <div
                                style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="font-size: 13px; font-weight: 600;">üìä PROGRESSION MISSION</span>
                                    <span style="font-size: 12px; color: var(--muted);" id="telem-remaining">0.00 km
                                        restant</span>
                                </div>
                                <div
                                    style="background: rgba(255,107,107,0.1); height: 12px; border-radius: 6px; overflow: hidden;">
                                    <div id="telem-progress-bar"
                                        style="height: 100%; background: linear-gradient(90deg, #ff6b6b, #ffd166, #00ff88); width: 0%; transition: width 0.3s;">
                                    </div>
                                </div>
                            </div>

                            <!-- Events & Parameters Grid -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <!-- Events Log -->
                                <div
                                    style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 16px;">
                                    <h4 style="margin: 0 0 12px 0; font-size: 13px;">üìã LOG D'√âV√âNEMENTS</h4>
                                    <div id="telem-events-log"
                                        style="max-height: 300px; overflow-y: auto; font-size: 12px;">
                                        <div style="color: var(--muted); text-align: center; padding: 40px 0;">En
                                            attente de simulation...</div>
                                    </div>
                                </div>

                                <!-- Mission Parameters -->
                                <div
                                    style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 16px;">
                                    <h4 style="margin: 0 0 12px 0; font-size: 13px;">‚öôÔ∏è PARAM√àTRES MISSION</h4>
                                    <div id="telem-mission-params" style="font-size: 12px;">
                                        <div style="color: var(--muted); text-align: center; padding: 40px 0;">
                                            Chargement...</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Summary -->
                            <div id="telem-summary"
                                style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                                <div style="color: var(--muted); text-align: center; padding: 20px;">Simulation en
                                    cours...</div>
                            </div>

                            <!-- Buttons -->
                            <div style="display: flex; gap: 12px;">
                                <button id="mb-new-mission" class="mb-btn-primary" style="flex: 1;">
                                    ‚ûï NOUVELLE MISSION
                                </button>
                                <button id="mb-export-report" class="mb-btn-secondary" style="flex: 1;">
                                    üìÑ EXPORTER TEL√âM√âTRIE
                                </button>
                            </div>
                        </div>

                        <!-- Static Report (Fallback) -->
                        <div id="mb-report-content"
                            style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 24px; display: none;">
                        </div>
                    </div>

                    <div style="margin-top: 24px; display: flex; gap: 12px;">
                        <button id="mb-new-mission" class="mb-btn-primary">
                            ‚ûï Nouvelle mission
                        </button>
                        <button id="mb-export-report" class="mb-btn-secondary">
                            üìÑ Exporter texte
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tab 7: Budget -->
            <div id="budget" class="tab-content">
                <div class="budget-container">
                    <header style="margin-bottom: 40px;">
                        <h2 style="font-size: 2rem; margin-bottom: 10px;">üí∞ Budget du Projet VOLTIGE</h2>
                        <p style="color: var(--muted); font-size: 1.1rem;">R√©capitulatif d√©taill√© des co√ªts mat√©riels et
                            services</p>
                    </header>

                    <!-- Budget Summary Chart -->
                    <!-- Budget Table -->
                    <div class="budget-table-container">
                        <table class="budget-table">
                            <thead>
                                <tr>
                                    <th>Poste de Co√ªt</th>
                                    <th>Co√ªt Estim√©</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="budget-row">
                                    <td class="budget-label">üõ†Ô∏è Hardware VOLTIGE</td>
                                    <td class="budget-amount"><span id="hardwareTotal">Calcul...</span></td>
                                    <td class="budget-notes">Drones, √©lectronique, batterie</td>
                                </tr>
                                <tr class="budget-row">
                                    <td class="budget-label">üé® Mod√©leur 3D (dev)</td>
                                    <td class="budget-amount">1000‚Ç¨</td>
                                    <td class="budget-notes">A√©ro haute pr√©cision</td>
                                </tr>
                                <tr class="budget-row">
                                    <td class="budget-label">‚öôÔ∏è Dev Firmware (dev)</td>
                                    <td class="budget-amount">600‚Ç¨</td>
                                    <td class="budget-notes">Code drone</td>
                                </tr>
                                <tr class="budget-row">
                                    <td class="budget-label">üíª Dev Web/App (dev)</td>
                                    <td class="budget-amount">1 500‚Ç¨</td>
                                    <td class="budget-notes">Site promo + app contr√¥le</td>
                                </tr>
                                <tr class="budget-row">
                                    <td class="budget-label">üì° Abonnement 4G/5G (24 mois)</td>
                                    <td class="budget-amount">2400‚Ç¨</td>
                                    <td class="budget-notes">Telemetry + streaming</td>
                                </tr>
                                <tr class="budget-row">
                                    <td class="budget-label">üîß Outillage/Tests/Impr√©vus</td>
                                    <td class="budget-amount">350‚Ç¨</td>
                                    <td class="budget-notes">Chargeur, c√¢bles, tests</td>
                                </tr>
                                <tr class="budget-row">
                                    <td class="budget-label">üíª Ordinateur de Travail</td>
                                    <td class="budget-amount">4000‚Ç¨</td>
                                    <td class="budget-notes">Ordinateur de travail</td>
                                </tr>
                                <tr class="budget-total">
                                    <td class="budget-label" style="font-weight: 700;">TOTAL</td>
                                    <td class="budget-amount" style="font-weight: 700; font-size: 1.3em;"
                                        id="totalSansOrdinateur">8350‚Ç¨</td>
                                    <td class="budget-amount" style="font-weight: 700; font-size: 1.3em;"
                                        id="totalAvecOrdinateur">(avec ordinateur) 12 450‚Ç¨</td>
                                    <td class="budget-notes">R√©aliste</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Hardware Components Cost Breakdown -->
                    <div style="margin-top: 40px;">
                        <h3 class="chart-title" style="margin-bottom: 24px;">D√©tail des Composants Hardware (<span
                                id="hardwareTotalTitle">2500‚Ç¨</span>)</h3>
                        <div class="components-cost-grid" id="componentsCostGrid">
                            <!-- Rempli dynamiquement par JS -->
                        </div>
                    </div>

                    <!-- Budget Statistics -->
                    <div
                        style="margin-top: 40px; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div class="stat-card">
                            <div class="stat-label">Investissement Minimum</div>
                            <div class="stat-value">~5 800‚Ç¨</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Investissement Recommand√©</div>
                            <div class="stat-value">~7 000‚Ç¨</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Investissement Maximum</div>
                            <div class="stat-value">~12 000‚Ç¨</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 8: Documentation -->
            <div id="documentation" class="tab-content">
                <div style="height: 100%; display: flex; flex-direction: column;">
                    <!-- Docs Menu (left sidebar inside tab) -->
                    <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
                        <div id="docs-menu-tab" style="display: flex; gap: 8px; flex-wrap: wrap;"></div>
                    </div>

                    <!-- Docs Viewer (main content) -->
                    <div id="docs-viewer"
                        style="flex: 1; background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 24px; overflow-y: auto; font-size: 14px; line-height: 1.6;">
                        <p style="color: var(--muted); text-align: center; padding: 40px 20px;">
                            üìö S√©lectionnez un document √† consulter...
                        </p>
                    </div>
                </div>
            </div>
    </div>
    </div>
    </div>

    </main>

    </div>

    <script src="docs/markdown-viewer.js"></script>
    <script>
        // ============ THEME HANDLING ============
        (function () {
            const THEME_KEY = 'voltige-theme';
            const root = document.documentElement;

            function getStored() { return localStorage.getItem(THEME_KEY); }
            function setStored(v) { try { localStorage.setItem(THEME_KEY, v); } catch (e) { } }

            function applyTheme(theme) {
                if (theme === 'dark') root.setAttribute('data-theme', 'dark');
                else root.removeAttribute('data-theme');
                setStored(theme);
                updateToggleIcon();
            }

            function getPreferred() {
                const stored = getStored();
                if (stored) return stored;
                return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }

            function updateToggleIcon() {
                const el = document.getElementById('themeToggle');
                if (!el) return;
                const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                if (isDark) {
                    el.innerHTML = `<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"/></svg>`;
                } else {
                    el.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>`;
                }
            }

            document.addEventListener('DOMContentLoaded', function () {
                const initial = getPreferred();
                applyTheme(initial);

                const toggle = document.getElementById('themeToggle');
                if (toggle) {
                    toggle.addEventListener('click', function () {
                        const currentlyDark = document.documentElement.getAttribute('data-theme') === 'dark';
                        const next = currentlyDark ? 'light' : 'dark';
                        toggle.animate([{ transform: 'scale(1)' }, { transform: 'scale(0.9)' }, { transform: 'scale(1)' }], { duration: 220, easing: 'ease' });
                        applyTheme(next);
                    });
                }
            });
        })();

        // ============ COMPOSANTS DATA ============
        const componentsData = { //tous en euro
            "batterie": [
                {
                    name: "Molicel P50B 20000mAh Li-Ion Battery Pack",
                    link: "https://nexusbatterysystems.com/products/6s4p-p50b?_fid=110f2f8d5",
                    explain: "Batterie Li-ion haute densit√© (1.4kg) pour autonomie longue dur√©e. 20000mAh @ 21.6V, d√©charge 100A continu. Id√©ale pour croisi√®re longue distance VTOL amphibie.",
                    spec: "6S | 20000mAh | 21.6V | 100A | 1400g | Li-ion",
                    price: 438,
                    quantity: 1,
                    categories: ["batterie"]
                },
            ],
            "moteur": [
                {
                    name: "T-MOTORHOBBY F90 2806.5 1500KV",
                    link: "https://tmotorhobby.com/goods-1057-T-Motor+F90+28065+Long+Range+Motor+-+1300KV1500KV1950KV.html",
                    explain: "PROPULSION. Moteur brushless propulsion ultra-efficace. 1500KV pour vitesse croisi√®re 75+ km/h. L√©ger (77g), puissant (2143W), transitions VTOL rapides. Longues distances",
                    spec: "1500KV | 77g | 2143W | 65.5A burst | 6S | Long Range",
                    price: 26,
                    quantity: 1,
                    categories: ["moteur"]
                },
                {
                    name: "DarwinFPV 2307.5 V3 Seawater",
                    link: "https://darwinfpv.com/products/darwinfpv-2307-5-v3-seawater-brushless-motor",
                    explain: "Moteur sustentation √©tanche eau sal√©e (Seawater). 4 unit√©s pour VTOL. 38g chacun, dimensionn√© pour d√©collage vertical amphibie.",
                    spec: "Sustentation | 38g/moteur | √âtanche | Seawater",
                    price: 25,
                    quantity: 4,
                    categories: ["moteur"]
                }
            ],
            "capteur": [
                {
                    name: "Benewake TFmini-S Capteur",
                    link: "https://www.amazon.fr/TFmini-S-Compatible-Raspberry-d%C3%A9tection-mouvement/dp/B08FFFFQ65/ref=asc_df_B08FFFFQ65?tag=googshopfr-21&hvadid=701488150708&hvpos=&hvnetw=g&hvrand=3037890900532905067&hvpone=&hvptwo=&hvqmt=&hvdev=c&hvdvcmdl=&hvlocint=&hvlocphy=9056067&hvtargid=pla-1253737867113&psc=1&hvocijid=3037890900532905067-B08FFFFQ65-&hvexpln=0",
                    explain: "Capteur distance laser pour terrain-following. Port√©e 4m, pr√©cision ¬±3mm. 2 unit√©s (avant/arri√®re) pour altitude et obstacle.",
                    spec: "12m range | ¬±1mm precision | I2C | 8g",
                    price: 39,
                    quantity: 1,
                    categories: ["capteur"]
                },
                {
                    name: "youyeetoo RPLIDAR ‚Äì Scanner laser",
                    link: "https://www.amazon.fr/youyeetoo-RPLIDAR-impliquant-positionnement-cartographie/dp/B0CNXLJJ61/ref=asc_df_B0CNXLJJ61?tag=googshopfr-21&hvadid=701554964814&hvpos=&hvnetw=g&hvrand=13408167718215426897&hvpone=&hvptwo=&hvqmt=&hvdev=c&hvdvcmdl=&hvlocint=&hvlocphy=9056067&hvtargid=pla-2303620073164&psc=1&hvocijid=13408167718215426897-B0CNXLJJ61-&hvexpln=0",
                    explain: "Lidar 360¬∞ pour robots ‚Äì Positionnement, cartographie, navigation et √©vitement des obstacles",
                    spec: "360¬∞ | HD | FUSION C1 | 0.05M to 12M",
                    price: 69,
                    quantity: 4,
                    categories: ["capteur"]
                },
                {
                    name: "ARCELI GY-521 MPU6050",
                    link: "https://www.amazon.fr/ARCELI-MPU6050-Acc%C3%A9l%C3%A9rom%C3%A8tre-Gyroscope-Convertisseur/dp/B07BVXN2GP/ref=asc_df_B07BVXN2GP?tag=googshopfr-21&hvadid=782202087245&hvpos=&hvnetw=g&hvrand=13512647288029649561&hvpone=&hvptwo=&hvqmt=&hvdev=c&hvdvcmdl=&hvlocint=&hvlocphy=9056067&hvtargid=pla-2450147623344&psc=1&hvocijid=13512647288029649561-B07BVXN2GP-&hvexpln=0&hvsb=lupin",
                    explain: "Gyroscope + acc√©l√©rom√®tre 3 axes. Stabilisation vol, d√©tection orientation, attitude.",
                    spec: "Gyro 3-axis | Acc√©l 3-axis | I2C | 5g",
                    price: 6,
                    quantity: 2,
                    categories: ["capteur"]
                },
                {
                    name: "BMP280 Capteur de Pression Barom√©trique, de Temp√©rature et d'Altitude",
                    link: "https://www.amazon.fr/AZDelivery-SparkFun-Capteur-pression-Raspberry/dp/B07D8TPVVY/ref=sr_1_3?__mk_fr_FR=%C3%85M%C3%85%C5%BD%C3%95%C3%91&dib=eyJ2IjoiMSJ9.7p9MTy8jN_ZXr-H0OQQzQ9W81SwM6FV76BD-IAqJSsATNlmWxZhIRJzIJvLcLzrFjM-Ag_GqYrp8rgUy4qzU8WdjcP1g1T1pFJ14INGFJTFnek-9EGJ42zVDD1-QZzhf9rDB5pJBk7m3bo8LjB8cpMlpRA3BQk13LZuH_X8GDYatwFYgFo7Z_6R3OTeQRBYXnFpoqwQITgirlEQ2glS5P3mMj6eSIzpfWHkoQdLQ0scE6TAbAJK10-IJo1y1F3KbsilSuIR59tMAeSPXigshZY4gl6tKC9dtnwFhA3Sh-uE.IapPQJ-9IVynIUTvKDJOPNmDc0WtWLfBVeuPFsSG0Z8&dib_tag=se&keywords=Adafruit+BMP280+Altitude/Pressure+Sensor&qid=1765911899&sr=8-3&th=1",
                    explain: "Capteur de Pression Barom√©trique, de Temp√©rature et d'Altitude",
                    spec: "altitude | pression | temp√©rature | 3-in-1",
                    price: 25,
                    quantity: 1,
                    categories: ["capteur"]
                },
                {
                    name: "PM2,5 capteur d'air Surveillance de la qualit√© poussi√®re",
                    link: "https://www.amazon.fr/Capteur-PM2-5-PMS5003-Surveillance-poussi%C3%A8re/dp/B07S6S9J6Z/ref=sr_1_1?__mk_fr_FR=%C3%85M%C3%85%C5%BD%C3%95%C3%91&dib=eyJ2IjoiMSJ9.8MUR6XzSa1BdDYI_GosAoxSdKC4-BB_ZV7csfbltelBJyA0qq27Ds54-3ZzsqYdJWOhEtW5vxSPSEQo72E_tOqAfgWGy_uGaDKpa5KyvPfq4Ab9O4QSoNp9V-yjRl4_2qo1EZbAb9XxoLTyWtcZ5cgtCWa0rEKiv2iKyR1M1dm1HO9uqsPPHm2srFtXe6MXx3O0jWH4esi6PtZKCQyVaeRzg3DLDEFv1bfQ28umlrBRXI74XlbRYQ8JWGn5a0LjCUNN-yeeUyVfK0kDuInY9smfx-C8R4kdZJ6rXsYWrcfg.mB42UPQz-KEB09gVicIdsPENxka__K2Tp2Nd4Gel-UU&dib_tag=se&keywords=Adafruit+Capteur+de+qualit%C3%A9+de+l'air+PM2.5+PMS5003&qid=1765911804&sr=8-1",
                    explain: "syst√®mes de contr√¥le automatique de la pression du vent et du d√©bit constants | ",
                    spec: "Port√©e effective : 0 ~ 500 ug/m3. Port√©e maximale: 000ug/m3 | Temps de r√©ponse ‚â§ 3 secondes",
                    price: 55,
                    quantity: 1,
                    categories: ["capteur"]
                },
                {
                    name: "CQRobot TDS capteur qualit√© de l'eau",
                    link: "https://www.amazon.fr/CQRobot-Ocean-Compatible-Scientific-Laboratory/dp/B08KXRHK7H?source=ps-sl-shoppingads-lpcontext&psc=1&smid=A22SB6W8K59090",
                    explain: "capteur pour mesur√© diff√©rente chose pour la qualit√© de l'eau",
                    spec: "Water quality",
                    price: 13,
                    quantity: 1,
                    categories: ["capteur"]
                },
                {
                    name: "sensiron SHT45",
                    link: "https://www.amazon.fr/Adafruit-Sensirion-5665-temp%C3%A9rature-dhumidit%C3%A9/dp/B0DXD7MT5S/ref=sr_1_2?__mk_fr_FR=%C3%85M%C3%85%C5%BD%C3%95%C3%91&dib=eyJ2IjoiMSJ9.x10CVKPEylxk7d-idVtBlWpruwLiu3hNZGkne2gHCTCRtPcqkwh79tjePOwb8o9lpBw2oMh0sGPVYx3CgDvYXlhfEsV5L03Hky2vtbZyf9HxT91ZNkVWsUbD7BOEGQqQSKnOjLKop-AbPAA1N9IWeHR3T5XP7Xw5pCHr3T1pe8LTt90Ws488YQd9YZb0ubbQoDmJzimWcB8LffqDh2O1h8EvWXyggZ94rUOfW5HW-hvTE5A-W8E7LkMWuDBDJADfmF8V5lc00Vr3bkAW4ub0ZsaMePTvVA3bQu5wYEkgSmw.Mu4Huie67qzFeKRj76JctAsZ8ua_aYfCcVLSwvZOsro&dib_tag=se&keywords=Sensirion+SHT85&qid=1766011201&sr=8-2",
                    explain: "capteur de pr√©cision pour la temp√©rature et l'humidit√©.",
                    spec: "humidity | temperature | high-precision",
                    price: 22,
                    quantity: 6,
                    categories: ["capteur"]
                }
            ],
            "CPU": [
                {
                    name: "Jetson Orin NX Development Kit 157 Tops",
                    link: "https://www.amazon.fr/Yahboom-Orin-16GB-Large-Model/dp/B0F181LG87?source=ps-sl-shoppingads-lpcontext&th=1",
                    explain: "cerveaux principales du drones, IA, VIDEO, CAPTEUR...",
                    spec: "16go RAM | 157TOPS | 8-core ARM A78AE | 8GB eMMC",
                    price: 879,
                    quantity: 1,
                    categories: ["CPU"]
                },
                {
                    name: "RASBERRY PI 4 4GO",
                    link: "https://www.amazon.fr/dp/B0CK3L9WD3?niid=nl_cl_lst_a_2_0&nrid=QZN9SGGN8KA9CC4X8FN3",
                    explain: "CERVEAUX BEACON, TRANSMISSION ",
                    spec: "4go ram | 2.4ghz",
                    price: 95,
                    quantity: 1,
                    categories: ["CPU", "balise"]
                }
            ],
            "cam√©ra": [
                {
                    name: "exploreHD 3.0 (400m)",
                    link: "https://dwe.ai/products/explorehd?srsltid=AfmBOoobVIBlusnh47KY85itSebgZiToKc0TXK35CyAAuCB2Wt9h0V6c",
                    explain: "Cam√©ra vid√©o temps r√©el pour pilotage longue distance et sous-marin. Retransmission sans fil, r√©solution HD, ~180-200g.",
                    spec: "HD | FPV retransmission | 180-200g",
                    price: 257,
                    quantity: 1,
                    categories: ["cam√©ra"]
                }
            ],
            "antennes": [
                {
                    name: "4G/5G modules",
                    link: "https://www.amazon.fr/Waveshare-RM520N-GL-Designed-Applications-Specification/dp/B0C2V53W3Z/ref=asc_df_B0C2V53W3Z?tag=googshopfr-21&hvadid=701716248680&hvpos=&hvnetw=g&hvrand=2931881342483318257&hvpone=&hvptwo=&hvqmt=&hvdev=c&hvdvcmdl=&hvlocint=&hvlocphy=9056067&hvtargid=pla-2316431958425&psc=1&hvocijid=2931881342483318257-B0C2V53W3Z-&hvexpln=0",
                    explain: "Ce module est un module de qualit√© industrielle destin√© exclusivement aux applications industrielles et commerciales. La s√©rie RM520N-GL couvre la quasi-totalit√© des principaux op√©rateurs mondiaux.",
                    spec: "Cat 6 | rasberry pi 5 | 900mbps",
                    price: 275,
                    quantity: 1,
                    categories: ["antennes", "balise"]
                },

                {
                    name: "Adaptateur industriel M.2 (NGFF) vers USB 3.0 avec emplacement pour carte SIM Nano pour module LTE 5G",
                    link: "https://www.amazon.fr/EXVIST-Adaptateur-industriel-emplacement-applications/dp/B08B82B6F5/ref=sr_1_8?adgrpid=59075757114&dib=eyJ2IjoiMSJ9.IXQ2IDNariXC_54iLXOPn0CY4e_OJ1DebHZ3zOyeeCv_6eFqYPNZj1An5IPkyVSf-8RgqqLaX-vSLzbQRKo0tZuaEFElC4XrrxV-vEN9Aui6LL5qI2mB8e5sPFRBEqsD6MFLBulphTfF8w9HsZXfKoGLLx3suc2441IlhoooZAbUkW54KCANavnUG0GygzkrpMoef4GjK1xsaWYewfjfevaFgSXIhY4GwtzXrZqE8Evehd2FxZa9OpPkuRf_tPm2uA-eJqKCKCdwbwHugfIjanZy4j8iLauAfpxYe9IHuek.XFMcGRO9-KlT5ZAmk1q2qZO1as2HBWaUNLjqIuL3IQ0&dib_tag=se&hvadid=275580051320&hvdev=c&hvexpln=0&hvlocphy=9056067&hvnetw=g&hvocijid=16922172073665408859--&hvqmt=b&hvrand=16922172073665408859&hvtargid=kwd-713204362541&hydadcr=14356_1762966&keywords=quectel+5g&qid=1765904194&sr=8-8&th=1",
                    explain: "EXVIST Adaptateur industriel M.2 (NGFF) vers USB 3.0 avec emplacement pour carte SIM Nano pour module LTE 5G comme Quectel RM500Q Applicable pour les applications M2M et IoT telles que le Raspberry Pi",
                    spec: "M.2 to USB 3.0",
                    price: 21,
                    quantity: 1,
                    categories: ["antennes", "balise"]
                },
            ],
            "m√©canique": [
                {
                    name: "water pump - DEVMO RC Water Pump 5V 370",
                    link: "https://www.amazon.com/DEVMO-Cooling-Step-Down-Waterproof-Accessory/dp/B09C4K1NGR",
                    explain: "pompe a eau pour les balastes de la balise.",
                    spec: "5V | 73 g | 600ml/min",
                    price: 17,
                    quantity: 1,
                    categories: ["m√©canique"]
                },
                {
                    name: "Puce COB LED",
                    link: "https://www.amazon.fr/dp/B0DN1Q42KT?niid=nl_cl_lst_a_2_0&nrid=EGQSYXE6KXXFPKHJBWCF&th=1",
                    explain: "LED Haute Puissance",
                    spec: "30-36V 20W | COB led | white",
                    price: 11,
                    quantity: 6,
                    categories: ["m√©canique"]
                },
                {
                    name: "water pump",
                    link: "https://www.amazon.com/DEVMO-Cooling-Step-Down-Waterproof-Accessory/dp/B09C4K1NGR",
                    explain: "Pompe a eau pour les balastes de la balise.",
                    spec: "5V | 73 g | 600ml/min",
                    price: 25,
                    quantity: 1,
                    categories: ["m√©canique", "balise"]
                },
                {
                    name: "Divers Fabrication et Usinage",
                    link: "",
                    explain: "PCB, cable, connecteur..., usinage divers",
                    spec: "",
                    price: 450,
                    quantity: 1,
                    categories: ["m√©canique"]
                },
            ]
        };

        // ============ FUZZY MATCH ============
        function fuzzyMatch(searchTerm, text) {
            const search = searchTerm.toLowerCase().replace(/\s+/g, '');
            const target = text.toLowerCase().replace(/\s+/g, '');
            let searchIdx = 0, targetIdx = 0, score = 0;

            while (searchIdx < search.length && targetIdx < target.length) {
                if (search[searchIdx] === target[targetIdx]) {
                    score++;
                    searchIdx++;
                }
                targetIdx++;
            }
            return searchIdx === search.length ? score : -1;
        }

        // ============ SEARCH ============
        function search(term) {
            if (!term.trim()) {
                renderAllCategories();
                return;
            }

            const results = [];
            const seen = new Set();

            Object.entries(componentsData).forEach(([category, items]) => {
                items.forEach(item => {
                    // √âviter les doublons
                    if (seen.has(item.name)) return;

                    const titleScore = fuzzyMatch(term, item.name);
                    const specScore = fuzzyMatch(term, item.spec);
                    const categoryScores = item.categories ?
                        Math.max(...item.categories.map(cat => fuzzyMatch(term, cat))) :
                        fuzzyMatch(term, category);

                    let finalScore = Math.max(titleScore, specScore, categoryScores);

                    if (finalScore >= 0) {
                        seen.add(item.name);
                        // Garder la premi√®re cat√©gorie pour l'affichage
                        const displayCategory = item.categories ? item.categories[0] : category;
                        results.push({ ...item, category: displayCategory, score: finalScore });
                    }
                });
            });

            results.sort((a, b) => b.score - a.score);
            renderResults(results);
        }

        function renderAllCategories() {
            const resultsDiv = document.getElementById('results');
            let html = '';
            const allItems = [];

            // Collecter tous les composants avec leurs cat√©gories
            Object.entries(componentsData).forEach(([category, items]) => {
                items.forEach(item => {
                    allItems.push(item);
                });
            });

            // D√©dupliquer bas√© sur le nom du composant
            const seen = new Set();
            const uniqueItems = allItems.filter(item => {
                if (seen.has(item.name)) return false;
                seen.add(item.name);
                return true;
            });

            uniqueItems.forEach(item => {
                // Afficher les cat√©gories principales
                const primaryCategory = item.categories ? item.categories[0] : 'autre';
                html += createCard(item, primaryCategory);
            });

            resultsDiv.innerHTML = html || '<div class="empty-state"><p>Aucun composant</p></div>';
        }

        function renderResults(results) {
            const resultsDiv = document.getElementById('results');
            if (results.length === 0) {
                resultsDiv.innerHTML = `<div class="empty-state"><p>üîç Aucun r√©sultat</p></div>`;
            } else {
                resultsDiv.innerHTML = results.map(item => createCard(item, item.category)).join('');
            }
        }

        function createCard(item, category) {
            // Afficher toutes les cat√©gories si disponibles
            const categoriesList = item.categories && item.categories.length > 0
                ? item.categories
                : [category];

            const categoryBadges = categoriesList.map(cat =>
                `<span class="category-badge">${cat}</span>`
            ).join('');

            return `
                <div class="card">
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px;">
                        ${categoryBadges}
                    </div>
                    <div class="card-header">
                        <h2 class="card-title">${item.name}</h2>
                        <a href="${item.link}" target="_blank" class="card-link">
                            Voir ‚Üí
                        </a>
                    </div>
                    <p class="card-explain">${item.explain}</p>
                    <div class="card-spec">${item.spec}</div>
                </div>
            `;
        }

        // ============ INITIALIZATION COMPONENTS ============
        document.addEventListener('DOMContentLoaded', () => {
            renderAllCategories();

            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    search(e.target.value);
                });
            }
        });

        // ============ TABS ============
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                btn.classList.add('active');
                document.getElementById(btn.dataset.tab).classList.add('active');

                // Redraw charts / refresh performance table when switching to performances
                if (btn.dataset.tab === 'performances') {
                    setTimeout(() => {
                        renderPerformanceTable();
                        renderMotorTable();
                        if (autonomyChart) autonomyChart.resize();
                        if (waterChart) waterChart.resize();
                    }, 100);
                }

            });
        });

        // ============================================================
        // VOLTIGE V3 - PERFORMANCE CHARTS (COMPLETE & WORKING)
        // ============================================================

        let autonomyChart = null;
        let waterChart = null;
        let cpuComparisonChart = null;

        // ============================================================
        // TABLE 1: PERFORMANCE G√âN√âRALE V1/V2/V3
        // ============================================================
        function renderPerformanceTable() {
            const container = document.getElementById('performanceTable');
            if (!container) return;

            const metrics = [
                { label: 'Vitesse Max (km/h)', v1: 30, v2: 80, v3: 160 },
                { label: 'Autonomie Cruise (min)', v1: 7, v2: 16, v3: 45 },
                { label: 'Poids Total (kg)', v1: 1.3, v2: 1.9, v3: 2.6 },
                { label: 'Payload (kg)', v1: 0, v2: 0.8, v3: 3 },
                { label: 'Port√©e 4G (km)', v1: 1, v2: 4, v3: 20 }
            ];

            let html = `<div class="performance-table"><table><thead><tr><th>M√©trique</th><th style="background:rgba(255,209,102,0.1);color:#ffd166;">V1</th><th style="background:rgba(255,107,107,0.1);color:#ff6b6b;">V2</th><th style="background:rgba(0,229,255,0.1);color:#00e5ff;">V3</th></tr></thead><tbody>`;

            metrics.forEach((m, idx) => {
                const bgColor = idx % 2 === 0 ? 'transparent' : 'rgba(255,255,255,0.02)';
                html += `<tr style="background:${bgColor};"><th>${m.label}</th><td class="perf-value">${m.v1}</td><td class="perf-value">${m.v2}</td><td class="perf-value" style="color:#00e5ff;font-weight:600;">${m.v3}</td></tr>`;
            });

            html += `</tbody></table></div>`;
            container.innerHTML = html;
        }

        // ============================================================
        // TABLE 2: MOTEURS V1/V2/V3
        // ============================================================
        function renderMotorTable() {
            const container = document.getElementById('motorTable');
            if (!container) return;

            const motors = [
                { name: 'Sustentation (4√ó)', v1: 2000, v2: 4800, v3: 5600 },
                { name: 'Propulsion (1√ó)', v1: 1800, v2: 2400, v3: 3000 }
            ];

            let html = `<div class="performance-table"><table><thead><tr><th>Moteur</th><th style="background:rgba(255,209,102,0.1);color:#ffd166;">V1</th><th style="background:rgba(255,107,107,0.1);color:#ff6b6b;">V2</th><th style="background:rgba(0,229,255,0.1);color:#00e5ff;">V3</th><th>Am√©lioration</th></tr></thead><tbody>`;

            motors.forEach((m, idx) => {
                const pct = ((m.v3 - m.v1) / m.v1 * 100).toFixed(1);
                const bgColor = idx % 2 === 0 ? 'transparent' : 'rgba(255,255,255,0.02)';
                html += `<tr style="background:${bgColor};"><th>${m.name}</th><td class="perf-value">${m.v1}g</td><td class="perf-value">${m.v2}g</td><td class="perf-value" style="color:#00e5ff;font-weight:600;">${m.v3}g</td><td style="color:#00ff88;font-weight:600;">+${pct}%</td></tr>`;
            });

            html += `</tbody></table></div>`;
            container.innerHTML = html;
        }

        // ============================================================
        // TABLE 3: PROCESSEUR CPU V1/V2/V3 (NOUVEAU)
        // ============================================================
        function renderCPUTable() {
            const container = document.getElementById('cpuTable');
            if (!container) return;

            const cpuData = [
                { metric: 'üñ•Ô∏è Processeur', v1: 'ESP32-S3', v2: 'RPi 5 ARM', v3: 'Jetson Orin NX Ultra' },
                { metric: 'Fr√©quence', v1: '240 MHz', v2: '2.4 GHz', v3: '2.6 GHz + GPU' },
                { metric: 'RAM', v1: '8 MB', v2: '8 GB', v3: '16 GB LPDDR5X' },
                { metric: 'GPU', v1: '‚ùå Aucun', v2: '‚ùå Aucun', v3: '‚úÖ 128-core NVIDIA' },
                { metric: 'CPU MOPS', v1: '~300', v2: '~28K', v3: '~100K' },
                { metric: 'IA/ML', v1: '‚ùå Pas native', v2: '‚ö†Ô∏è Limit√©', v3: '‚úÖ 100+ TOPS CUDA' },
                { metric: 'Vid√©o 4K', v1: '‚ùå Non', v2: '‚ö†Ô∏è Logiciel', v3: '‚úÖ Natif' },
                { metric: 'D√©tection RT', v1: '‚ùå 0 FPS', v2: '‚ö†Ô∏è <1 FPS', v3: '‚úÖ 30+ FPS YOLO' },
                { metric: 'Consommation', v1: '~2W', v2: '~10W', v3: '~15W' },
                { metric: 'Co√ªt', v1: '~15‚Ç¨', v2: '~100‚Ç¨', v3: '~500‚Ç¨' },
                { metric: 'Support', v1: '‚ö†Ô∏è Arduino', v2: '‚úÖ Linux', v3: '‚úÖ JetPack' },
                { metric: 'üéØ RANKING', v1: '‚≠ê', v2: '‚≠ê‚≠ê‚≠ê', v3: '‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê' }
            ];

            let html = `<div class="performance-table"><table style="width:100%;border-collapse:collapse;">`;
            html += `<thead><tr style="background:linear-gradient(90deg,rgba(124,92,255,0.1),rgba(0,229,255,0.1));">`;
            html += `<th style="padding:12px;text-align:left;border-bottom:2px solid rgba(255,255,255,0.1);color:#00e5ff;">M√©trique</th>`;
            html += `<th style="padding:12px;text-align:center;border-bottom:2px solid rgba(255,255,255,0.1);background:rgba(255,209,102,0.1);color:#ffd166;font-weight:700;">V1</th>`;
            html += `<th style="padding:12px;text-align:center;border-bottom:2px solid rgba(255,255,255,0.1);background:rgba(255,107,107,0.1);color:#ff6b6b;font-weight:700;">V2</th>`;
            html += `<th style="padding:12px;text-align:center;border-bottom:2px solid rgba(255,255,255,0.1);background:rgba(0,229,255,0.1);color:#00e5ff;font-weight:700;">V3</th>`;
            html += `</tr></thead><tbody>`;

            cpuData.forEach((row, idx) => {
                const isBold = row.metric.includes('üñ•Ô∏è') || row.metric.includes('üéØ');
                const bgColor = idx % 2 === 0 ? 'transparent' : 'rgba(255,255,255,0.02)';

                html += `<tr style="background:${bgColor};border-bottom:1px solid rgba(255,255,255,0.05);">`;
                html += `<td style="padding:12px;font-weight:${isBold ? '700' : '600'};color:var(--text);">${row.metric}</td>`;
                html += `<td style="padding:12px;text-align:center;color:var(--muted);font-size:13px;">${row.v1}</td>`;
                html += `<td style="padding:12px;text-align:center;color:var(--muted);font-size:13px;">${row.v2}</td>`;
                html += `<td style="padding:12px;text-align:center;color:#00e5ff;font-weight:600;font-size:13px;">${row.v3}</td>`;
                html += `</tr>`;
            });

            html += `</tbody></table></div>`;
            container.innerHTML = html;
        }

        // ============================================================
        // GRAPHIQUE 1: AUTONOMIE AIR (D√âJ√Ä EXISTANT - FIX√â)
        // ============================================================
        function drawAutonomyChart() {
            const ctx = document.getElementById('autonomyChart');
            if (!ctx) return;

            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const textColor = isDark ? '#e6eef8' : '#071124';
            const gridColor = isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)';

            if (autonomyChart) autonomyChart.destroy();

            autonomyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Hover (STB actif)', '50 km/h', '70 km/h', '160 km/h (Vmax)'],
                    datasets: [
                        {
                            label: 'V1 (min)',
                            data: [6, 14, 5, 0],
                            backgroundColor: 'rgba(255,209,102,0.6)',
                            borderColor: '#ffd166',
                            borderWidth: 2,
                            borderRadius: 6
                        },
                        {
                            label: 'V2 (min)',
                            data: [20, 26, 18, 8],
                            backgroundColor: 'rgba(255,107,107,0.6)',
                            borderColor: '#ff6b6b',
                            borderWidth: 2,
                            borderRadius: 6
                        },
                        {
                            label: 'V3 (min)',
                            data: [33, 40, 35, 15],
                            backgroundColor: 'rgba(0,229,255,0.6)',
                            borderColor: '#00e5ff',
                            borderWidth: 2,
                            borderRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { labels: { color: textColor, font: { size: 13, weight: '600' } } }
                    },
                    scales: {
                        y: {
                            grid: { color: gridColor },
                            ticks: { color: textColor, beginAtZero: true }
                        },
                        x: { ticks: { color: textColor } }
                    }
                }
            });
        }

        // ============================================================
        // GRAPHIQUE 2: AUTONOMIE EAU (D√âJ√Ä EXISTANT - FIX√â)
        // ============================================================
        function drawWaterChart() {
            const ctx = document.getElementById('waterChart');
            if (!ctx) return;

            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const textColor = isDark ? '#e6eef8' : '#071124';
            const gridColor = isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)';

            if (waterChart) waterChart.destroy();

            waterChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['9 km/h', '19 km/h', '28 km/h (Vmax)'],
                    datasets: [
                        {
                            label: 'V1 (min)',
                            data: [12, 3, 0],
                            backgroundColor: 'rgba(255,209,102,0.6)',
                            borderColor: '#ffd166',
                            borderWidth: 2,
                            borderRadius: 6
                        },
                        {
                            label: 'V2 (min)',
                            data: [26, 12, 4],
                            backgroundColor: 'rgba(255,107,107,0.6)',
                            borderColor: '#ff6b6b',
                            borderWidth: 2,
                            borderRadius: 6
                        },
                        {
                            label: 'V3 (min)',
                            data: [185, 99, 54],
                            backgroundColor: 'rgba(0,229,255,0.6)',
                            borderColor: '#00e5ff',
                            borderWidth: 2,
                            borderRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { labels: { color: textColor, font: { size: 13, weight: '600' } } }
                    },
                    scales: {
                        y: {
                            grid: { color: gridColor },
                            ticks: { color: textColor, beginAtZero: true }
                        },
                        x: { ticks: { color: textColor } }
                    }
                }
            });
        }

        // ============================================================
        // GRAPHIQUE 3: CPU PERFORMANCE COMPARISON (1-10 SCALE) - NOUVEAU
        // ============================================================
        function drawCPUComparisonChart() {
            const ctx = document.getElementById('cpuComparisonChart');
            if (!ctx) {
                console.warn('‚ùå cpuComparisonChart canvas not found');
                return;
            }

            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const textColor = isDark ? '#e6eef8' : '#071124';
            const gridColor = isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)';

            if (cpuComparisonChart) cpuComparisonChart.destroy();

            cpuComparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [
                        'IA/ML\nCapacit√©',
                        'Traitement\nVid√©o 4K',
                        'Gestion\nCapteurs'
                    ],
                    datasets: [
                        {
                            label: 'V1 (ESP32-S3)',
                            data: [0.5, 1, 2],
                            backgroundColor: 'rgba(255,209,102,0.7)',
                            borderColor: '#ffd166',
                            borderWidth: 2,
                            borderRadius: 8
                        },
                        {
                            label: 'V2 (RPi 5 8GB)',
                            data: [3, 4, 6],
                            backgroundColor: 'rgba(255,107,107,0.7)',
                            borderColor: '#ff6b6b',
                            borderWidth: 2,
                            borderRadius: 8
                        },
                        {
                            label: 'V3 (Jetson Orin NX)',
                            data: [9.5, 9, 9.5],
                            backgroundColor: 'rgba(0,229,255,0.7)',
                            borderColor: '#00e5ff',
                            borderWidth: 2,
                            borderRadius: 8
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            labels: {
                                color: textColor,
                                font: { size: 13, weight: '600' },
                                padding: 15
                            },
                            position: 'top'
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.9)',
                            titleColor: '#00e5ff',
                            bodyColor: textColor,
                            padding: 12,
                            displayColors: true,
                            borderColor: '#00e5ff',
                            borderWidth: 1,
                            callbacks: {
                                label: function (context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}/10`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10,
                            grid: { color: gridColor, drawBorder: false },
                            ticks: {
                                color: textColor,
                                stepSize: 2,
                                callback: function (value) {
                                    return value + '/10';
                                }
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: textColor, font: { size: 12, weight: '600' } }
                        }
                    }
                }
            });

            console.log('‚úÖ CPU Comparison Chart drawn');
        }
        // ============================================================
        // INITIALISER TOUS LES GRAPHIQUES
        // ============================================================
        function initCharts() {
            console.log('üîß Initializing charts...');
            renderPerformanceTable();
            renderMotorTable();
            renderCPUTable();
            drawAutonomyChart();
            drawWaterChart();
            drawCPUComparisonChart();
            console.log('‚úÖ All charts initialized');
        }

        // ============================================================
        // APPEL AU TAB SWITCH
        // ============================================================
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                btn.classList.add('active');
                document.getElementById(btn.dataset.tab).classList.add('active');

                // POUR LE TAB PERFORMANCES: APPELLE INITCHARTS()
                if (btn.dataset.tab === 'performances') {
                    setTimeout(() => {
                        initCharts();
                    }, 100);
                }
            });
        });
        /// ============ CALCULATEUR V3 CORRIG√â ============
        const V3_DATA = {
            battery: {
                capacity: 432, // Wh
                usable: 345.6, // Wh (80%)
                voltage: 21.6 // V
            },
            weight: 2.6, // kg

            // CONSTANTES PUISSANCE
            power: {
                sustentation: {
                    min: 585,     // 40% = hover minimum
                    hover: 585,   // 50% = hover normal
                    max: 700      // 100% = max lift
                },
                propulsion: {
                    max: 900      // 100% = 160 km/h
                }
            },

            speed: {
                max: 160        // km/h
            }
        };

        // Environment switch
        const environment = document.getElementById('environment');
        const airControls = document.getElementById('airControls');
        const waterControls = document.getElementById('waterControls');

        if (environment) {
            environment.addEventListener('change', () => {
                if (environment.value === 'air') {
                    airControls.style.display = 'block';
                    waterControls.style.display = 'none';
                } else {
                    airControls.style.display = 'none';
                    waterControls.style.display = 'block';
                }
                calculateAutonomy();
            });
        }

        // Slider updates
        const sliders = {
            sustentationThrottle: document.getElementById('sustentationThrottle'),
            propulsionThrottle: document.getElementById('propulsionThrottle'),
            windSpeed: document.getElementById('windSpeed'),
            waterSpeed: document.getElementById('waterSpeed'),
            current: document.getElementById('current'),
            relief: document.getElementById('relief'),
            stabilization: document.getElementById('stabilization')
        };

        Object.keys(sliders).forEach(key => {
            if (sliders[key]) {
                sliders[key].addEventListener('input', () => {
                    updateDisplay();
                    calculateAutonomy();
                });
            }
        });

        function updateDisplay() {
            if (document.getElementById('sustentationThrottleVal')) {
                document.getElementById('sustentationThrottleVal').textContent =
                    sliders.sustentationThrottle.value;
            }
            if (document.getElementById('propulsionThrottleVal')) {
                document.getElementById('propulsionThrottleVal').textContent =
                    sliders.propulsionThrottle.value;
            }
            if (document.getElementById('windSpeedVal')) {
                document.getElementById('windSpeedVal').textContent =
                    sliders.windSpeed.value;
            }
            if (document.getElementById('waterSpeedVal')) {
                document.getElementById('waterSpeedVal').textContent =
                    sliders.waterSpeed.value;
            }
            if (document.getElementById('currentVal')) {
                document.getElementById('currentVal').textContent =
                    sliders.current.value;
            }
            if (document.getElementById('reliefVal')) {
                document.getElementById('reliefVal').textContent =
                    sliders.relief.value;
            }
        }

        // AUTONOMY CALCULATION - CORRECTED
        function calculateAutonomy() {
            if (!environment) return;

            const env = environment.value;
            let power = 0;
            let speed = 0;

            if (env === 'air') {
                const sustThrottle = parseInt(sliders.sustentationThrottle.value);
                const propThrottle = parseInt(sliders.propulsionThrottle.value);
                const windSpeed = parseInt(sliders.windSpeed.value);
                const hasStab = sliders.stabilization.checked;

                // ===== PUISSANCE SUSTENTATION =====
                // Formule: 585 + ((sustThrottle - 50) / 50) √ó 115
                const sustPower = V3_DATA.power.sustentation.hover +
                    ((sustThrottle - 50) / 50) * 115;

                // ===== PUISSANCE PROPULSION =====
                // Formule: (propThrottle / 100) √ó 900
                const propPower = (propThrottle / 100) * V3_DATA.power.propulsion.max;

                // ===== PUISSANCE TOTALE =====
                let basePower = sustPower + propPower;

                // ===== IMPACT VENT =====
                // Vent augmente la tra√Æn√©e
                if (windSpeed > 0) {
                    const windFactor = (windSpeed / 20) * 0.08; // +8% per 20 km/h
                    basePower = basePower * (1 + windFactor);
                }

                // ===== STABILISATION =====
                if (hasStab) {
                    basePower += 25; // +25W pour stabilisation active
                }

                power = Math.round(basePower);
                speed = (propThrottle / 100) * V3_DATA.speed.max;

            } else { // water
                const waterSpd = parseInt(sliders.waterSpeed.value);
                const currentSpd = parseFloat(sliders.current.value);

                if (waterSpd <= 10) {
                    power = 112; // ~9 km/h
                    speed = 9;
                } else if (waterSpd <= 20) {
                    power = 209; // ~19 km/h
                    speed = 19;
                } else {
                    power = 382; // ~28 km/h
                    speed = 28;
                }

                // Current penalty
                if (currentSpd > 0) {
                    power += currentSpd * 5;
                }
            }

            // ===== CALCULS AUTONOMIE =====
            const autonomyMin = Math.round((V3_DATA.battery.usable / power) * 60);
            const distance = Math.round((speed * autonomyMin / 60) * 10) / 10;
            const energyUsed = V3_DATA.battery.usable - (power * (autonomyMin / 60));

            // ===== AFFICHAGE =====
            if (document.getElementById('consumption')) {
                document.getElementById('consumption').textContent = power;
            }
            if (document.getElementById('autonomy')) {
                document.getElementById('autonomy').textContent = autonomyMin;
            }
            if (document.getElementById('distance')) {
                document.getElementById('distance').textContent = distance;
            }
            if (document.getElementById('energyUsed')) {
                document.getElementById('energyUsed').textContent =
                    Math.round(energyUsed * 100) / 100;
            }
        }

        // Mission calculator - CORRECTED
        function calculateMission() {
            const distance = parseFloat(document.getElementById('missionDistance').value);
            const speed = parseInt(document.getElementById('missionSpeed').value);
            const relief = parseInt(document.getElementById('relief').value);
            const batteryPercent = parseInt(document.getElementById('batteryPercent').value);

            const sustThrottle = parseInt(document.getElementById('sustentationThrottle').value);
            const propThrottle = parseInt(document.getElementById('propulsionThrottle').value);
            const windSpeed = parseInt(document.getElementById('windSpeed').value);

            // ===== BASE TIME =====
            let time = (distance / speed) * 60; // minutes

            // ===== RELIEF PENALTY =====
            // +10% temps par 100m d'altitude
            const reliefPenalty = (relief / 100) * 0.1;
            time = time * (1 + reliefPenalty);

            // ===== POWER CONSUMPTION =====
            // Interpoler puissance selon vitesse
            let power = 0;

            if (speed <= 0) {
                // Hover
                power = 585;
            } else if (speed <= 50) {
                // Entre hover (585W) et 50km/h (600W)
                power = 585 + (speed / 50) * (600 - 585);
            } else if (speed <= 70) {
                // Entre 50km/h (600W) et 70km/h (700W)
                power = 600 + ((speed - 50) / 20) * (700 - 600);
            } else if (speed <= 100) {
                // Entre 70km/h (700W) et 100km/h (800W)
                power = 700 + ((speed - 70) / 30) * (800 - 700);
            } else if (speed <= 160) {
                // Entre 100km/h (800W) et 160km/h (900W)
                power = 800 + ((speed - 100) / 60) * (900 - 800);
            } else {
                power = 900;
            }

            // ===== WIND PENALTY =====
            if (windSpeed > 0) {
                const windFactor = (windSpeed / 20) * 0.08; // +8% per 20 km/h
                power = power * (1 + windFactor);
            }

            // ===== ENERGY CALCULATION =====
            // Energy = Power (W) √ó Time (h)
            const energyNeeded_Wh = power * (time / 60);

            // Battery available
            const batteryAvailable_Wh = V3_DATA.battery.usable * (batteryPercent / 100);

            // Battery remaining
            const batteryRemaining_Wh = batteryAvailable_Wh - energyNeeded_Wh;

            // Safety margin (30% pour RTH)
            const safetyMargin_Wh = V3_DATA.battery.usable * 0.3; // 103.68 Wh
            const safeRemaining_Wh = batteryRemaining_Wh - safetyMargin_Wh;

            // Convert to percentages for display
            const batteryNeeded_Percent = (energyNeeded_Wh / V3_DATA.battery.usable) * 100;
            const batteryRemaining_Percent = (batteryRemaining_Wh / V3_DATA.battery.usable) * 100;
            const safeRemaining_Percent = (safeRemaining_Wh / V3_DATA.battery.usable) * 100;

            // ===== UPDATE DISPLAY =====
            document.getElementById('missionTime').textContent = Math.round(time);
            document.getElementById('batteryNeeded').textContent =
                Math.round(batteryNeeded_Percent) + '% (' + Math.round(energyNeeded_Wh) + ' Wh)';
            document.getElementById('batteryRemaining').textContent =
                Math.round(safeRemaining_Percent) + '% (' + Math.round(safeRemaining_Wh) + ' Wh)';

            // ===== STATUS CHECK =====
            const missionAlert = document.getElementById('missionAlert');

            if (safeRemaining_Wh < 0) {
                document.getElementById('missionStatus').textContent = '‚ùå FAIL';
                document.getElementById('missionStatus').style.color = '#ff6b6b';

                const deficit = Math.abs(safeRemaining_Wh);
                missionAlert.innerHTML = `
            <strong style="color: #ff6b6b;">‚ùå BATTERIE INSUFFISANTE!</strong><br/>
            Manque ${Math.round(deficit)} Wh pour RTH<br/>
            Besoin: ${Math.round(energyNeeded_Wh)} Wh<br/>
            Dispo: ${Math.round(batteryAvailable_Wh)} Wh
        `;
                missionAlert.style.display = 'block';
            } else {
                document.getElementById('missionStatus').textContent = '‚úÖ OK';
                document.getElementById('missionStatus').style.color = '#00ff88';
                missionAlert.style.display = 'none';
            }
        }

        // Initial calculations
        calculateAutonomy();
        updateDisplay();
        // ============ LIVE TELEMETRY SIMULATOR - AM√âLIOR√â ============

        // MISSION CONFIGURATIONS
        const missionConfigs = {
            courte: {
                name: 'Courte (3-5 min)',
                duration: 180, // 3 minutes r√©elles max (speedup 1x)
                phases: {
                    takeoff: 5,
                    transit: 20,
                    scanning: 15,
                    dive: 10,
                    rth: 15,
                    landing: 15
                }
            },
            moyenne: {
                name: 'Moyenne (8-10 min)',
                duration: 540, // 9 minutes r√©elles
                phases: {
                    takeoff: 8,
                    transit: 60,
                    scanning: 90,
                    dive: 120,
                    rth: 120,
                    landing: 42
                }
            },
            longue: {
                name: 'Longue (15+ min)',
                duration: 900, // 15 minutes r√©elles
                phases: {
                    takeoff: 10,
                    transit: 120,
                    scanning: 180,
                    dive: 240,
                    rth: 180,
                    landing: 70
                }
            }
        };

        let selectedMission = 'moyenne';
        let telemetryRunning = false;
        let telemetryTime = 0;
        let telemetrySpeedup = 1; // 1x = real-time
        let phaseStart = 0; // Track when phase started

        let telemetryData = {
            flightState: 'STANDBY',
            flightTime: 0,
            altitude: 0,
            altitude_max: 100,
            gps: { lat: 47.3215, lon: 5.0397 },
            distance: 0,
            heading: 0,
            groundSpeed: 0,
            batteryPercent: 100,
            voltage: 21.6,
            current: 0,
            power: 0,
            batteryTemp: 35,
            cpuLoad: 0,
            ram: 0,
            pitch: 0,
            roll: 0,
            yaw: 0,
            motors: [0, 0, 0, 0, 0],
            waterMode: false,
            depth: 0,
            waterTemp: 0,
            beaconActive: false,
            alerts: [],

            // New: Environment conditions
            windSpeed: 0,
            windDirection: 0,
            visibility: 200,
            waterCurrent: 0.3,
            signalStrength: -85,
            signalQuality: 85,
            batteryHealth: 95
        };

        let telemCharts = {};
        let telemHistory = {
            time: [],
            altitude: [],
            speed: [],
            battery: [],
            power: [],
            temperature: [],
            voltage: [],
            motors: [[], [], [], [], []]
        };

        let telemEventLog = [];

        // ===== MISSION SELECTOR =====
        function initMissionSelector() {
            const selector = document.getElementById('mission-selector');
            if (!selector) {
                console.warn('Mission selector not found');
                return;
            }

            Object.keys(missionConfigs).forEach(key => {
                const btn = document.createElement('button');
                btn.className = 'mission-btn';
                btn.textContent = missionConfigs[key].name;
                btn.style.cssText = `
            padding: 8px 16px;
            margin: 4px;
            background: ${selectedMission === key ? '#00e5ff' : 'rgba(0,229,255,0.2)'};
            border: 1px solid #00e5ff;
            color: #00e5ff;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.3s;
        `;

                btn.addEventListener('click', () => {
                    selectedMission = key;
                    document.querySelectorAll('.mission-btn').forEach(b => {
                        b.style.background = 'rgba(0,229,255,0.2)';
                    });
                    btn.style.background = '#00e5ff';
                    btn.style.color = '#000';
                    addTelemetryEvent(`üìã Mission s√©lectionn√©e: ${missionConfigs[key].name}`);
                });

                selector.appendChild(btn);
                if (selectedMission === key) {
                    btn.style.background = '#00e5ff';
                    btn.style.color = '#000';
                }
            });
        }

        // ===== SPEEDUP CONTROL =====
        function initSpeedupControl() {
            const speedupContainer = document.getElementById('speedup-container');
            if (!speedupContainer) return;

            speedupContainer.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
            <label style="color: var(--muted);">Vitesse simulation:</label>
            <input type="range" id="speedup-slider" min="0.5" max="4" step="0.5" value="1" 
                   style="width: 150px; cursor: pointer;">
            <span id="speedup-display" style="color: #00e5ff; font-weight: bold; min-width: 50px;">1.0x</span>
        </div>
    `;

            const slider = document.getElementById('speedup-slider');
            const display = document.getElementById('speedup-display');

            slider.addEventListener('input', (e) => {
                telemetrySpeedup = parseFloat(e.target.value);
                display.textContent = telemetrySpeedup.toFixed(1) + 'x';
            });
        }

        // ===== ENHANCED CHARTS WITH ZOOM/PAN =====
        function initTelemetryCharts() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const textColor = isDark ? '#e6eef8' : '#071124';
            const gridColor = isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)';

            const chartConfig = {
                responsive: true,
                maintainAspectRatio: true,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { labels: { color: textColor }, position: 'bottom' },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleColor: '#00e5ff',
                        bodyColor: textColor,
                        borderColor: '#00e5ff',
                        borderWidth: 1,
                        padding: 10,
                        displayColors: true
                    },
                    zoom: {
                        zoom: {
                            wheel: { enabled: true, speed: 0.1 },
                            pinch: { enabled: true },
                            mode: 'xy'
                        },
                        pan: {
                            enabled: true,
                            mode: 'xy'
                        }
                    }
                },
                scales: {
                    x: { ticks: { color: textColor }, grid: { color: gridColor } },
                    y: { ticks: { color: textColor }, grid: { color: gridColor } }
                }
            };

            // Chart Altitude
            const ctxAlt = document.getElementById('chart-altitude');
            if (ctxAlt) {
                telemCharts.altitude = new Chart(ctxAlt, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            { label: 'Altitude (m)', data: [], borderColor: '#00e5ff', backgroundColor: 'rgba(0,229,255,0.1)', fill: true, tension: 0.2, borderWidth: 2 },
                            { label: 'Profondeur (m)', data: [], borderColor: '#0099ff', backgroundColor: 'rgba(0,153,255,0.1)', fill: true, tension: 0.2, borderWidth: 2 }
                        ]
                    },
                    options: {
                        ...chartConfig,
                        scales: {
                            ...chartConfig.scales,
                            y: { ...chartConfig.scales.y, max: 150 }
                        }
                    }
                });
            }

            // Chart Speed + Wind
            const ctxSpd = document.getElementById('chart-speed');
            if (ctxSpd) {
                telemCharts.speed = new Chart(ctxSpd, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            { label: 'Vitesse (km/h)', data: [], borderColor: '#FFD166', backgroundColor: 'rgba(255,209,102,0.1)', fill: true, tension: 0.2, borderWidth: 2 },
                            { label: 'Vent (km/h)', data: [], borderColor: '#ff9800', backgroundColor: 'rgba(255,152,0,0.1)', fill: true, tension: 0.2, borderWidth: 2 }
                        ]
                    },
                    options: { ...chartConfig, scales: { ...chartConfig.scales, y: { ...chartConfig.scales.y, max: 160 } } }
                });
            }

            // Chart Battery + Voltage
            const ctxBat = document.getElementById('chart-battery');
            if (ctxBat) {
                telemCharts.battery = new Chart(ctxBat, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            { label: 'Batterie (%)', data: [], borderColor: '#ff6b6b', backgroundColor: 'rgba(255,107,107,0.1)', fill: true, tension: 0.2, borderWidth: 2, yAxisID: 'y' },
                            { label: 'Voltage (V)', data: [], borderColor: '#00ff88', backgroundColor: 'rgba(0,255,136,0.1)', fill: false, tension: 0.2, borderWidth: 2, yAxisID: 'y1' }
                        ]
                    },
                    options: {
                        ...chartConfig,
                        scales: {
                            ...chartConfig.scales,
                            y: { ...chartConfig.scales.y, max: 100, min: 0, position: 'left' },
                            y1: { ...chartConfig.scales.y, max: 25, min: 15, position: 'right' }
                        }
                    }
                });
            }

            // Chart Power + Temperature
            const ctxPwr = document.getElementById('chart-power');
            if (ctxPwr) {
                telemCharts.power = new Chart(ctxPwr, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            { label: 'Puissance (W)', data: [], borderColor: '#8b63ff', backgroundColor: 'rgba(139,99,255,0.1)', fill: true, tension: 0.2, borderWidth: 2, yAxisID: 'y' },
                            { label: 'Temp batterie (¬∞C)', data: [], borderColor: '#ff6b6b', backgroundColor: 'rgba(255,107,107,0.1)', fill: false, tension: 0.2, borderWidth: 2, yAxisID: 'y1' }
                        ]
                    },
                    options: {
                        ...chartConfig,
                        scales: {
                            ...chartConfig.scales,
                            y: { ...chartConfig.scales.y, max: 1500, position: 'left' },
                            y1: { ...chartConfig.scales.y, max: 60, min: 20, position: 'right' }
                        }
                    }
                });
            }
        }

        // ===== RANDOM EVENTS & VARIABILITY =====
        function generateRandomConditions() {
            // Vent al√©atoire (0-15 km/h)
            telemetryData.windSpeed = Math.max(0, telemetryData.windSpeed + (Math.random() - 0.5) * 2);
            telemetryData.windSpeed = Math.min(15, Math.max(0, telemetryData.windSpeed));

            // Direction vent
            telemetryData.windDirection = (telemetryData.windDirection + (Math.random() - 0.5) * 10) % 360;

            // Visibility variations
            telemetryData.visibility = Math.max(20, 150 + Math.sin(telemetryTime / 30) * 50 + (Math.random() - 0.5) * 30);

            // Signal strength variations
            telemetryData.signalStrength = -80 - Math.abs(Math.sin(telemetryTime / 20) * 20) + (Math.random() - 0.5) * 10;
            telemetryData.signalQuality = Math.max(30, 85 - Math.abs(Math.sin(telemetryTime / 20) * 40));

            // Water current
            telemetryData.waterCurrent = 0.3 + Math.sin(telemetryTime / 40) * 0.4 + (Math.random() - 0.5) * 0.2;

            // Battery health degradation (slight)
            if (telemetryData.batteryHealth > 85) {
                telemetryData.batteryHealth -= Math.random() * 0.05;
            }
        }

        // ===== WEATHER EVENTS =====
        function checkWeatherEvents(phase) {
            const eventChance = Math.random();

            if (phase === 'transit' && eventChance < 0.3) {
                if (telemetryData.windSpeed > 10) {
                    addTelemetryEvent(`‚ö†Ô∏è Vent augmente: ${Math.floor(telemetryData.windSpeed)} km/h`);
                }
            }

            if (phase === 'scanning' && eventChance < 0.2) {
                if (telemetryData.visibility < 80) {
                    addTelemetryEvent(`‚ö†Ô∏è Visibilit√© r√©duite: ${Math.floor(telemetryData.visibility)}m`);
                }
            }

            if (phase === 'dive' && eventChance < 0.15) {
                if (telemetryData.waterCurrent > 0.5) {
                    addTelemetryEvent(`‚ö†Ô∏è Courant marin: ${telemetryData.waterCurrent.toFixed(1)} km/h`);
                }
            }

            if (telemetryData.signalStrength < -100 && eventChance < 0.1) {
                addTelemetryEvent(`‚ö†Ô∏è Signal 4G faible: ${Math.floor(telemetryData.signalStrength)} dBm`);
            }
        }

        // ===== ENHANCED FLIGHT SIMULATION =====
        function simulateFlightStep() {
            if (!telemetryRunning) return;

            telemetryTime += telemetrySpeedup; // Apply speedup
            telemetryData.flightTime += telemetrySpeedup;

            const config = missionConfigs[selectedMission];
            let phase = '';
            let phaseProgress = 0;

            // Determine current phase
            let cumulativeTime = 0;
            for (let [phaseName, phaseDuration] of Object.entries(config.phases)) {
                if (telemetryTime <= cumulativeTime + phaseDuration) {
                    phase = phaseName;
                    phaseProgress = (telemetryTime - cumulativeTime) / phaseDuration;
                    break;
                }
                cumulativeTime += phaseDuration;
            }

            // Generate random conditions every tick
            generateRandomConditions();
            checkWeatherEvents(phase);

            // ===== SIMULATION PAR PHASE =====
            if (phase === 'takeoff') {
                telemetryData.flightState = 'üõ´ D√âCOLLAGE';
                telemetryData.altitude = phaseProgress * 50 + Math.random() * 2;
                telemetryData.groundSpeed = 0;
                telemetryData.batteryPercent = 100 - (phaseProgress * 2);
                telemetryData.motors = [
                    1000 + phaseProgress * 5000 + Math.random() * 200,
                    1000 + phaseProgress * 5000 + Math.random() * 200,
                    1000 + phaseProgress * 5000 + Math.random() * 200,
                    1000 + phaseProgress * 5000 + Math.random() * 200,
                    0 + phaseProgress * 500
                ];
                telemetryData.power = 100 + phaseProgress * 500;
                telemetryData.pitch = phaseProgress * 5;
                telemetryData.roll = Math.sin(telemetryTime) * 2;

            } else if (phase === 'transit') {
                telemetryData.flightState = '‚úàÔ∏è EN ROUTE';
                telemetryData.altitude = 50 + Math.sin(phaseProgress * Math.PI) * 3 + Math.random() * 2;
                telemetryData.groundSpeed = Math.min(60, phaseProgress * 80);
                telemetryData.distance = phaseProgress * 1500;
                telemetryData.heading = 135 + Math.sin(phaseProgress * Math.PI) * 10;
                telemetryData.batteryPercent = 100 - (telemetryData.flightTime * 0.8);
                telemetryData.motors = [
                    5500 + Math.random() * 500,
                    5500 + Math.random() * 500,
                    5500 + Math.random() * 500,
                    5500 + Math.random() * 500,
                    2000 + phaseProgress * 1000
                ];
                telemetryData.power = 400 + Math.random() * 50 + telemetryData.windSpeed * 3;
                telemetryData.pitch = Math.sin(phaseProgress * Math.PI * 2) * 3;
                telemetryData.roll = Math.cos(phaseProgress * Math.PI * 2) * 2;
                telemetryData.gps.lat += 0.0002 * phaseProgress;
                telemetryData.gps.lon += 0.0003 * phaseProgress;

            } else if (phase === 'scanning') {
                telemetryData.flightState = 'üëÅÔ∏è SCANNING';
                telemetryData.altitude = 50 + Math.sin(phaseProgress * Math.PI * 4) * 5;
                telemetryData.groundSpeed = Math.abs(Math.sin(phaseProgress * Math.PI * 3) * 10);
                telemetryData.distance = 1500 + Math.random() * 20;
                telemetryData.batteryPercent = 100 - (telemetryData.flightTime * 0.85);
                telemetryData.motors = [
                    5800 + Math.random() * 300,
                    5800 + Math.random() * 300,
                    5800 + Math.random() * 300,
                    5800 + Math.random() * 300,
                    100
                ];
                telemetryData.power = 550 + Math.random() * 40;
                telemetryData.cpuLoad = 70 + Math.random() * 15;
                telemetryData.ram = 200 + Math.random() * 30;

                // D√©tection al√©atoire entre 40-80% de la phase
                if (phaseProgress > 0.4 && phaseProgress < 0.8 && !telemetryData.beaconActive && Math.random() < 0.05) {
                    addTelemetryEvent('‚úì D√âTECTION CONFIRM√âE');
                    addTelemetryAlert('üîî Balise beacon d√©ploy√©e');
                    telemetryData.beaconActive = true;
                }

                // Scanning circle pattern
                telemetryData.gps.lat = 47.322 + Math.sin(phaseProgress * Math.PI * 4) * 0.0005;
                telemetryData.gps.lon = 5.0405 + Math.cos(phaseProgress * Math.PI * 4) * 0.0005;

            } else if (phase === 'dive') {
                telemetryData.flightState = 'üåä PLONG√âE';
                telemetryData.waterMode = true;
                const diveDepth = phaseProgress < 0.5 ? phaseProgress * 2 * 20 : 20 - (phaseProgress - 0.5) * 2 * 20;
                telemetryData.altitude = 50 - diveDepth;
                telemetryData.depth = Math.max(0, diveDepth);
                telemetryData.waterTemp = 12 + Math.random() * 1;
                telemetryData.batteryPercent = 100 - (telemetryData.flightTime * 0.9);
                telemetryData.motors = [
                    5200 + Math.random() * 400,
                    5200 + Math.random() * 400,
                    5200 + Math.random() * 400,
                    5200 + Math.random() * 400,
                    1500 + phaseProgress * 1000
                ];
                telemetryData.power = 450 + Math.random() * 40 + telemetryData.waterCurrent * 50;
                telemetryData.current = telemetryData.power / 20.8;

                // Batterie critique warning @ 70%
                if (phaseProgress > 0.7 && telemetryData.batteryPercent < 40) {
                    addTelemetryAlert('üî¥ ALERTE: Batterie critique - RTH imm√©diat');
                }

            } else if (phase === 'rth') {
                telemetryData.flightState = 'üè† RETOUR BASE';
                telemetryData.waterMode = false;
                telemetryData.altitude = Math.max(0, 30 + phaseProgress * 20);
                telemetryData.depth = 0;
                telemetryData.groundSpeed = 50 * (1 - phaseProgress);
                telemetryData.heading = 315;
                telemetryData.distance = Math.max(0, 1500 - phaseProgress * 1500);
                telemetryData.batteryPercent = 100 - (telemetryData.flightTime * 1.0);
                telemetryData.motors = [
                    5500 + Math.random() * 400,
                    5500 + Math.random() * 400,
                    5500 + Math.random() * 400,
                    5500 + Math.random() * 400,
                    2200
                ];
                telemetryData.power = 480 + Math.random() * 30;

            } else if (phase === 'landing') {
                telemetryData.flightState = 'üõ¨ ATTERRISSAGE';
                telemetryData.altitude = Math.max(0, 30 * (1 - phaseProgress));
                telemetryData.groundSpeed = Math.max(0, 20 * (1 - phaseProgress));
                telemetryData.distance = Math.max(0, 100 - phaseProgress * 100);
                telemetryData.batteryPercent = Math.max(5, 100 - (telemetryData.flightTime * 1.05));
                telemetryData.motors = [
                    4000 * (1 - phaseProgress),
                    4000 * (1 - phaseProgress),
                    4000 * (1 - phaseProgress),
                    4000 * (1 - phaseProgress),
                    500 * (1 - phaseProgress)
                ];
                telemetryData.power = 250 * (1 - phaseProgress);
                telemetryData.cpuLoad = 40 * (1 - phaseProgress);

                if (phaseProgress === 1) {
                    addTelemetryEvent('‚úÖ MISSION COMPL√àTE - Atterrissage r√©ussi');
                    stopTelemetry();
                }
            } else {
                stopTelemetry();
            }

            // Battery temperature increases with power
            telemetryData.batteryTemp = 30 + (telemetryData.power / 120) + (telemetryData.flightTime / 60);
            telemetryData.voltage = 21.6 - (telemetryData.flightTime / 200);

            // Update charts
            const timeStr = Math.floor(telemetryData.flightTime / 60) + ':' + String(Math.floor(telemetryData.flightTime % 60)).padStart(2, '0');
            telemHistory.time.push(timeStr);
            telemHistory.altitude.push(telemetryData.altitude);
            telemHistory.speed.push(telemetryData.groundSpeed);
            telemHistory.battery.push(telemetryData.batteryPercent);
            telemHistory.power.push(telemetryData.power);
            telemHistory.temperature.push(telemetryData.batteryTemp);
            telemHistory.voltage.push(telemetryData.voltage);

            for (let i = 0; i < 5; i++) {
                telemHistory.motors[i].push(telemetryData.motors[i]);
            }

            // Keep only last 300 data points
            const maxPoints = 300;
            if (telemHistory.time.length > maxPoints) {
                telemHistory.time.shift();
                telemHistory.altitude.shift();
                telemHistory.speed.shift();
                telemHistory.battery.shift();
                telemHistory.power.shift();
                telemHistory.temperature.shift();
                telemHistory.voltage.shift();
                for (let i = 0; i < 5; i++) {
                    telemHistory.motors[i].shift();
                }
            }

            // Update charts
            updateCharts();
            updateTelemetryDisplay();
        }

        function updateCharts() {
            if (telemCharts.altitude) {
                telemCharts.altitude.data.labels = telemHistory.time;
                telemCharts.altitude.data.datasets[0].data = telemHistory.altitude;
                telemCharts.altitude.data.datasets[1].data = telemHistory.altitude.map((alt, i) => {
                    return telemData.waterMode && telemData.depth > 0 ? -telemHistory[i] : null;
                });
                telemCharts.altitude.update('none');
            }
            if (telemCharts.speed) {
                telemCharts.speed.data.labels = telemHistory.time;
                telemCharts.speed.data.datasets[0].data = telemHistory.speed;
                telemCharts.speed.data.datasets[1].data = telemHistory.speed.map(() => telemetryData.windSpeed);
                telemCharts.speed.update('none');
            }
            if (telemCharts.battery) {
                telemCharts.battery.data.labels = telemHistory.time;
                telemCharts.battery.data.datasets[0].data = telemHistory.battery;
                telemCharts.battery.data.datasets[1].data = telemHistory.voltage;
                telemCharts.battery.update('none');
            }
            if (telemCharts.power) {
                telemCharts.power.data.labels = telemHistory.time;
                telemCharts.power.data.datasets[0].data = telemHistory.power;
                telemCharts.power.data.datasets[1].data = telemHistory.temperature;
                telemCharts.power.update('none');
            }
        }

        function updateTelemetryDisplay() {
            document.getElementById('telem-flight-state').textContent = telemetryData.flightState;
            document.getElementById('telem-flight-time').textContent =
                Math.floor(telemetryData.flightTime / 60) + ':' + String(Math.floor(telemetryData.flightTime % 60)).padStart(2, '0');
            document.getElementById('telem-gps').textContent =
                telemetryData.gps.lat.toFixed(4) + '¬∞N, ' + telemetryData.gps.lon.toFixed(4) + '¬∞E';
            document.getElementById('telem-altitude').textContent = Math.floor(telemetryData.altitude) + ' m';
            document.getElementById('telem-distance').textContent = (telemetryData.distance / 1000).toFixed(2) + ' km';
            document.getElementById('telem-heading').textContent = Math.floor(telemetryData.heading) + '¬∞';
            document.getElementById('telem-groundspeed').textContent = Math.floor(telemetryData.groundSpeed) + ' km/h';
            document.getElementById('telem-wind').textContent = Math.floor(telemetryData.windSpeed) + ' km/h';

            const batteryPercent = Math.max(0, telemetryData.batteryPercent);
            document.getElementById('telem-battery-bar').style.width = batteryPercent + '%';
            document.getElementById('telem-battery-bar').style.background =
                batteryPercent > 60 ? 'linear-gradient(90deg, #00e5ff, #00ffc6)' :
                    batteryPercent > 30 ? 'linear-gradient(90deg, #FFD166, #ff9800)' :
                        'linear-gradient(90deg, #ff6b6b, #d32f2f)';
            document.getElementById('telem-battery-percent').textContent = Math.round(batteryPercent) + '%';
            document.getElementById('telem-voltage').textContent = telemetryData.voltage.toFixed(2) + 'V';
            document.getElementById('telem-current').textContent = telemetryData.current.toFixed(1) + ' A';
            document.getElementById('telem-power').textContent = Math.floor(telemetryData.power) + ' W';
            document.getElementById('telem-battery-temp').textContent = Math.floor(telemetryData.batteryTemp) + '¬∞C';

            document.getElementById('telem-signal').textContent = Math.floor(telemetryData.signalStrength) + ' dBm';
            document.getElementById('telem-signal-quality').textContent = Math.round(telemetryData.signalQuality) + '%';
            document.getElementById('telem-visibility').textContent = Math.round(telemetryData.visibility) + ' m';

            document.getElementById('telem-cpu').textContent = Math.floor(telemetryData.cpuLoad) + '%';
            document.getElementById('telem-ram').textContent = Math.floor(telemetryData.ram) + '/256 MB';

            for (let i = 0; i < 5; i++) {
                document.getElementById(`telem-motor-${i + 1}`).textContent = Math.floor(telemetryData.motors[i]) + ' RPM';
            }

            document.getElementById('telem-pitch').textContent = telemetryData.pitch.toFixed(1) + '¬∞';
            document.getElementById('telem-roll').textContent = telemetryData.roll.toFixed(1) + '¬∞';
            document.getElementById('telem-yaw').textContent = telemetryData.yaw.toFixed(1) + '¬∞';

            if (telemetryData.waterMode) {
                document.getElementById('telem-water-state').textContent = 'ACTIF üåä';
                document.getElementById('telem-depth').textContent = telemetryData.depth.toFixed(1) + ' m';
                document.getElementById('telem-water-temp').textContent = telemetryData.waterTemp.toFixed(1) + '¬∞C';
                document.getElementById('telem-beacon').textContent = telemetryData.beaconActive ? 'ACTIF ‚úì' : 'DORMANT';
                document.getElementById('telem-current').textContent = telemetryData.waterCurrent.toFixed(2) + ' km/h';
            }
        }

        function addTelemetryEvent(msg) {
            const timeline = document.getElementById('telem-timeline');
            const time = Math.floor(telemetryData.flightTime / 60) + ':' + String(Math.floor(telemetryData.flightTime % 60)).padStart(2, '0');
            const div = document.createElement('div');
            div.style.cssText = 'padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.85em; color: var(--muted);';
            div.innerHTML = `<strong>[${time}]</strong> ${msg}`;
            timeline.insertBefore(div, timeline.firstChild);
            if (timeline.childElementCount > 50) timeline.removeChild(timeline.lastChild);
        }

        function addTelemetryAlert(msg) {
            const alerts = document.getElementById('telem-alerts');
            const alertDiv = document.createElement('div');
            alertDiv.style.cssText = 'padding: 8px; background: rgba(255,107,107,0.1); border-left: 3px solid #ff6b6b; margin-bottom: 8px; border-radius: 4px; font-size: 0.85em;';
            alertDiv.textContent = msg;
            alerts.insertBefore(alertDiv, alerts.firstChild);
            if (alerts.childElementCount > 15) alerts.removeChild(alerts.lastChild);
        }

        function startTelemetry() {
            if (telemetryRunning) return;
            telemetryRunning = true;
            telemetryTime = 0;
            telemetryData.flightTime = 0;
            telemHistory = { time: [], altitude: [], speed: [], battery: [], power: [], temperature: [], voltage: [], motors: [[], [], [], [], []] };
            document.getElementById('telem-timeline').innerHTML = '';
            document.getElementById('telem-alerts').innerHTML = '<div style="color: var(--muted); text-align: center;">En attente d\'alertes...</div>';
            document.getElementById('telemetry-start').disabled = true;
            document.getElementById('telemetry-start').style.opacity = '0.5';
            document.getElementById('telemetry-stop').disabled = false;
            document.getElementById('telemetry-stop').style.opacity = '1';
            initTelemetryCharts();
            addTelemetryEvent(`‚ñ∂Ô∏è Mission ${missionConfigs[selectedMission].name} d√©marr√©e`);

            const interval = setInterval(() => {
                if (!telemetryRunning) {
                    clearInterval(interval);
                    return;
                }
                simulateFlightStep();
            }, 500); // Update every 500ms = 2 updates per second
        }

        function stopTelemetry() {
            telemetryRunning = false;
            document.getElementById('telemetry-start').disabled = false;
            document.getElementById('telemetry-start').style.opacity = '1';
            document.getElementById('telemetry-stop').disabled = true;
            document.getElementById('telemetry-stop').style.opacity = '0.5';
        }

        function resetTelemetry() {
            stopTelemetry();
            telemetryTime = 0;
            telemetrySpeedup = 1;
            telemetryData = {
                ...telemetryData,
                flightTime: 0,
                altitude: 0,
                batteryPercent: 100,
                flightState: 'STANDBY',
                waterMode: false,
                beaconActive: false,
                distance: 0,
                groundSpeed: 0,
                motors: [0, 0, 0, 0, 0],
                pitch: 0,
                roll: 0,
                yaw: 0
            };
            telemHistory = { time: [], altitude: [], speed: [], battery: [], power: [], temperature: [], voltage: [], motors: [[], [], [], [], []] };
            document.getElementById('telem-timeline').innerHTML = '<div style="color: var(--muted); text-align: center;">√âv√©nements en attente...</div>';
            document.getElementById('telem-alerts').innerHTML = '<div style="color: var(--muted); text-align: center;">Aucune alerte</div>';
            document.getElementById('speedup-slider').value = 1;
            document.getElementById('speedup-display').textContent = '1.0x';
            updateTelemetryDisplay();
            if (telemCharts.altitude) {
                Object.values(telemCharts).forEach(chart => chart.destroy());
                telemCharts = {};
            }
        }

        // ===== EVENT LISTENERS =====
        document.addEventListener('DOMContentLoaded', () => {
            initMissionSelector();
            initSpeedupControl();

            const startBtn = document.getElementById('telemetry-start');
            const stopBtn = document.getElementById('telemetry-stop');
            const resetBtn = document.getElementById('telemetry-reset');

            if (startBtn) startBtn.addEventListener('click', startTelemetry);
            if (stopBtn) stopBtn.addEventListener('click', stopTelemetry);
            if (resetBtn) resetBtn.addEventListener('click', resetTelemetry);
        });

        // ============ INIT ============
        // ============ MISSION BUILDER INIT ============
        initMissionBuilder();

        // ============ MISSION BUILDER v2.0 - COMPLET ET R√âALISTE ============

        // ============ STATE & CONSTANTS ============
        const missionBuilderState = {
            selectedScenario: null,
            waypoints: [],
            actions: {},
            map: null,
            markers: {},
            polyline: null,
            conditions: {
                wind: 5,
                visibility: 200,
                waves: 1,
                tempWater: 12,
                weather: 'cloudy',
                time: '14:00',
                waterType: 'coastal',
                current: 0.5
            },
            config: 'B',
            payloads: { thermal: true },
            missionData: null,
            simulation: { isRunning: false, progress: 0, events: [] }
        };

        // BATTERY CONSTANTS
        const BATTERY_CAPACITY_WH = 345.6;
        const BATTERY_USABLE_PERCENT = 0.8;
        const BATTERY_USABLE_WH = BATTERY_CAPACITY_WH * BATTERY_USABLE_PERCENT;

        // DRONE CONFIGS - R√âALISTE
        const droneConfigs = {
            A: {
                name: 'CONFIG A (L√©ger)',
                basePower: 600,
                weight: 2.05,
                maxWeight: 2.05,
                autonomy: 28,
                autonomyWater: 45,
                price: 2500
            },
            B: {
                name: 'CONFIG B (Standard)',
                basePower: 650,
                weight: 2.1,
                maxWeight: 3.0,
                autonomy: 35,
                autonomyWater: 55,
                price: 3500
            },
            C: {
                name: 'CONFIG C (Lourd)',
                basePower: 700,
                weight: 2.6,
                maxWeight: 4.5,
                autonomy: 45,
                autonomyWater: 75,
                price: 5000
            }
        };

        // PAYLOADS R√âALISTES VOLTIGE V3
        const payloadDefinitions = {
            beacon: { name: 'Beacon + Ballast', weight: 0.2, power: 0, description: 'Syst√®me de localisation + ballast eau' },
            camera: { name: 'Cam√©ra HD 4K', weight: 0.15, power: 80, description: 'R√©solution 2160p 30fps' },
            sensors: { name: 'Capteurs eau x6', weight: 0.1, power: 0, description: 'pH, TDS, Temp, Conductivity, Turbidity, Salinit√©' },
            thermal: { name: 'Cam√©ra Thermique', weight: 0.2, power: 0, description: 'Infrarouge 320√ó256' },
            ledExtra: { name: 'LED suppl√©mentaire', weight: 0.05, power: 40, description: 'Spotlight 2000 lm' }
        };

        // ACTION DEFINITIONS - R√âALISTE
        const actionDefinitions = {
            hover: {
                name: '‚è∏Ô∏è Hover',
                power: 585,
                duration: 30,
                unit: 'sec',
                description: 'Rester en place stable',
                batteryImpact: -1.41
            },
            photo: {
                name: 'üì∏ Photo 4K',
                power: 80,
                duration: 1,
                unit: 'sec',
                description: 'Capture photo unique',
                batteryImpact: -0.01
            },
            video: {
                name: 'üìπ Vid√©o 15s',
                power: 90,
                duration: 15,
                unit: 'sec',
                description: 'Enregistrement vid√©o 15 secondes',
                batteryImpact: -0.04
            },
            waterSampling: {
                name: 'üíß Pr√©l√®vement eau',
                power: 15,
                duration: 20,
                unit: 'sec',
                description: 'Capteurs eau (6 param√®tres)',
                batteryImpact: -0.09
            },
            beacon: {
                name: 'üîî Beacon 2min',
                power: 50,
                duration: 120,
                unit: 'sec',
                description: 'D√©ploiement modem acoustique',
                batteryImpact: -0.48
            },
            thermal: {
                name: 'üå°Ô∏è Scan thermique',
                power: 80,
                duration: 30,
                unit: 'sec',
                description: 'Balayage infrarouge 30sec',
                batteryImpact: -0.19
            },
            ledSpotlight: {
                name: 'üí° LED 5min',
                power: 40,
                duration: 300,
                unit: 'sec',
                description: 'Spotlight 5 minutes',
                batteryImpact: -0.96
            }
        };

        // ============ BATTERY FORMULAS - R√âALISTE ============

        function airPowerForSpeed(speed_kmh) {
            const points = { 50: 600, 70: 700, 100: 800, 160: 900 };
            const speeds = [50, 70, 100, 160];

            if (speed_kmh <= 50) return 600;
            if (speed_kmh >= 160) return 900;

            for (let i = 0; i < speeds.length - 1; i++) {
                const s1 = speeds[i], s2 = speeds[i + 1];
                if (speed_kmh >= s1 && speed_kmh <= s2) {
                    const p1 = points[s1], p2 = points[s2];
                    return p1 + (speed_kmh - s1) * (p2 - p1) / (s2 - s1);
                }
            }
            return 900;
        }

        function waterPowerForSpeed(speed_kmh) {
            const points = { 9: 112, 18: 225, 28: 382 };
            const speeds = [9, 18, 28];

            if (speed_kmh <= 9) return 112;
            if (speed_kmh >= 28) return 382;

            for (let i = 0; i < speeds.length - 1; i++) {
                const s1 = speeds[i], s2 = speeds[i + 1];
                if (speed_kmh >= s1 && speed_kmh <= s2) {
                    const p1 = points[s1], p2 = points[s2];
                    return p1 + (speed_kmh - s1) * (p2 - p1) / (s2 - s1);
                }
            }
            return 382;
        }

        function adjustPowerForWind(power, wind_kmh) {
            return power * (1 + (wind_kmh / 20) * 0.08);
        }

        function adjustPowerForTemp(power, temp_celsius) {
            return temp_celsius < 15 ? power * 0.92 : power;
        }

        function batteryWattHourToPercent(wh) {
            return (wh / BATTERY_CAPACITY_WH) * 100;
        }

        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) ** 2 +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
            const c = 2 * Math.asin(Math.sqrt(a));
            return R * c;
        }

        function detectionProbability(visibility_m, weather, hasPayload) {
            let prob = 0.5;

            if (visibility_m > 500) prob += 0.3;
            else if (visibility_m > 200) prob += 0.15;
            else if (visibility_m > 100) prob += 0.05;

            if (weather === 'clear') prob += 0.25;
            else if (weather === 'cloudy') prob += 0.1;
            else if (weather === 'light-rain') prob -= 0.15;
            else if (weather === 'heavy-rain') prob -= 0.3;

            if (hasPayload) prob += 0.2;

            return Math.min(Math.max(prob, 0), 1.0) * 100;
        }

        // ============ INITIALIZATION ============

        function initMissionBuilder() {
            console.log('üöÄ Mission Builder v2.0 R√âALISTE initialized');

            document.querySelectorAll('.mb-step').forEach(s => s.style.display = 'none');
            document.getElementById('mb-step1').style.display = 'block';

            setupStep1();
            setupStep2();
            setupStep3();
            setupStep4();
            setupStep5();
        }

        function setupStep1() {
            document.querySelectorAll('.scenario-card').forEach(card => {
                card.addEventListener('click', function () {
                    document.querySelectorAll('.scenario-card').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    missionBuilderState.selectedScenario = this.dataset.scenario;
                    document.getElementById('mb-continue-step1').disabled = false;
                    document.getElementById('mb-continue-step1').style.opacity = '1';
                    document.getElementById('mb-continue-step1').style.cursor = 'pointer';
                });
            });

            document.getElementById('mb-continue-step1').addEventListener('click', () => {
                showMBStep(2);
                setTimeout(initMapStep, 100);
            });
        }

        function setupStep2() {
            document.getElementById('mb-back-step1')?.addEventListener('click', () => showMBStep(1));
            document.getElementById('mb-continue-step2')?.addEventListener('click', () => {
                if (missionBuilderState.waypoints.length < 2) {
                    alert('‚ùå Ajoute au moins 2 waypoints!');
                    return;
                }
                showMBStep(3);
                renderActionsStep();
            });
        }

        function setupStep3() {
            document.getElementById('mb-back-step2')?.addEventListener('click', () => showMBStep(2));
            document.getElementById('mb-continue-step3')?.addEventListener('click', () => showMBStep(4));
        }

        function setupStep4() {
            ['wind', 'visibility', 'waves', 'temp', 'current'].forEach(param => {
                const elem = document.getElementById(`mb-${param}`);
                if (elem) {
                    elem.addEventListener('input', (e) => {
                        const key = param === 'temp' ? 'tempWater' : param;
                        missionBuilderState.conditions[key] = parseFloat(e.target.value);
                        document.getElementById(`mb-${param}-val`).textContent = e.target.value;
                        updateConditionsImpact();
                    });
                }
            });

            document.getElementById('mb-weather')?.addEventListener('change', (e) => {
                missionBuilderState.conditions.weather = e.target.value;
                updateConditionsImpact();
            });

            document.getElementById('mb-water-type')?.addEventListener('change', (e) => {
                missionBuilderState.conditions.waterType = e.target.value;
                updateConditionsImpact();
            });

            document.getElementById('mb-time')?.addEventListener('change', (e) => {
                missionBuilderState.conditions.time = e.target.value;
                updateConditionsImpact();
            });

            document.getElementById('mb-back-step3')?.addEventListener('click', () => showMBStep(3));
            document.getElementById('mb-continue-step4')?.addEventListener('click', () => showMBStep(5));
        }

        function setupStep5() {
            document.querySelectorAll('input[name="config"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    missionBuilderState.config = e.target.value;
                    updateDroneConfig();
                });
            });

            document.querySelectorAll('.mb-payload').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const payload = e.target.value;
                    missionBuilderState.payloads[payload] = e.target.checked;
                    updateDroneConfig();
                });
            });

            document.getElementById('mb-back-step4')?.addEventListener('click', () => showMBStep(4));
            document.getElementById('mb-launch-simulation')?.addEventListener('click', launchSimulation);
            document.getElementById('mb-new-mission')?.addEventListener('click', resetMissionBuilder);
            document.getElementById('mb-export-report')?.addEventListener('click', exportReport);
        }

        function showMBStep(step) {
            document.querySelectorAll('.mb-step').forEach(s => s.style.display = 'none');
            const elem = document.getElementById(`mb-step${step}`);
            if (elem) {
                elem.style.display = 'block';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // ============ MAP & WAYPOINTS ============

        function initMapStep() {
            if (missionBuilderState.map) return;

            const mapContainer = document.getElementById('mb-map');
            if (!mapContainer) return;

            missionBuilderState.map = L.map(mapContainer).setView([47.32, 5.04], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap',
                maxZoom: 19
            }).addTo(missionBuilderState.map);

            const homeMarker = L.circleMarker([47.32, 5.04], {
                radius: 10,
                fillColor: '#00e5ff',
                color: 'white',
                weight: 3,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(missionBuilderState.map);
            homeMarker.bindPopup('<strong>üè† Base (Home)</strong>');

            missionBuilderState.waypoints = [{
                id: Date.now(),
                index: 0,
                lat: 47.32,
                lng: 5.04,
                speed: 50,
                altitude: 0,
                type: 'home',
                actions: []
            }];

            missionBuilderState.markers[0] = homeMarker;

            missionBuilderState.map.on('click', (e) => {
                addWaypoint(e.latlng.lat, e.latlng.lng);
            });
        }

        function addWaypoint(lat, lng) {
            const index = missionBuilderState.waypoints.length;
            const waypoint = {
                id: Date.now(),
                index: index,
                lat: parseFloat(lat.toFixed(6)),
                lng: parseFloat(lng.toFixed(6)),
                speed: 50,
                altitude: 50,
                type: 'air',
                actions: []
            };

            missionBuilderState.waypoints.push(waypoint);
            missionBuilderState.actions[index] = {};

            const marker = L.circleMarker([lat, lng], {
                radius: 8,
                fillColor: '#ff6b6b',
                color: 'white',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(missionBuilderState.map);

            marker.bindPopup(`
                <div style="font-size:12px;">
                    <strong>üéØ WP ${index}</strong><br>
                    Lat: ${lat.toFixed(4)}¬∞ N<br>
                    Lng: ${lng.toFixed(4)}¬∞ E<br>
                    <button onclick="editWaypoint(${index})" style="padding:4px 8px;margin:4px 0;background:#7c5cff;color:white;border:none;border-radius:3px;cursor:pointer;">‚úèÔ∏è √âditer</button>
                    <button onclick="deleteWaypoint(${index})" style="padding:4px 8px;margin:4px 4px 4px 0;background:#ff6b6b;color:white;border:none;border-radius:3px;cursor:pointer;">üóëÔ∏è Supprimer</button>
                </div>
            `);

            missionBuilderState.markers[index] = marker;
            updateWaypointsList();
            document.getElementById('mb-continue-step2').disabled = false;
            document.getElementById('mb-continue-step2').style.opacity = '1';
        }

        function editWaypoint(index) {
            const wp = missionBuilderState.waypoints[index];

            const lat = prompt(`Latitude WP${index}:`, wp.lat);
            if (lat === null) return;
            const lng = prompt(`Longitude WP${index}:`, wp.lng);
            if (lng === null) return;
            const speed = prompt(`Vitesse WP${index} (km/h, 20-160):`, wp.speed);
            if (speed === null) return;
            const altitude = prompt(`Altitude/Profondeur WP${index} (m, 0-150, n√©gatif=plong√©e):`, wp.altitude || 50);
            if (altitude === null) return;
            const type = prompt(`Type trajet (air ou eau):`, wp.type || 'air');
            if (type === null) return;

            wp.lat = parseFloat(lat);
            wp.lng = parseFloat(lng);
            wp.speed = Math.max(20, Math.min(160, parseFloat(speed)));
            wp.altitude = parseFloat(altitude);
            wp.type = type.toLowerCase() === 'eau' ? 'eau' : 'air';

            missionBuilderState.markers[index].setLatLng([wp.lat, wp.lng]);
            updateWaypointsList();
        } function deleteWaypoint(index) {
            if (index === 0) {
                alert('‚ùå Cannot delete home base!');
                return;
            }

            missionBuilderState.map.removeLayer(missionBuilderState.markers[index]);
            missionBuilderState.waypoints.splice(index, 1);

            missionBuilderState.waypoints.forEach((wp, i) => {
                wp.index = i;
                if (missionBuilderState.markers[index]) {
                    const marker = missionBuilderState.markers[index];
                    marker.setPopupContent(`<strong>WP ${i}</strong>`);
                }
            });

            delete missionBuilderState.markers[index];
            delete missionBuilderState.actions[index];

            updateWaypointsList();
        }

        function updateWaypointsList() {
            const container = document.getElementById('mb-waypoints-list');
            if (!container) return;

            let html = '<table style="width:100%;font-size:11px;border-collapse:collapse;">';
            html += '<thead><tr style="border-bottom:1px solid var(--border);"><th>WP</th><th>Lat/Lng</th><th>Alt</th><th>Spd</th><th>Dist</th><th>Time</th><th>Batt%</th></tr></thead>';
            html += '<tbody>';

            let totalDist = 0, totalTime = 0, totalBatt = 0;

            missionBuilderState.waypoints.forEach((wp, i) => {
                if (i === 0) {
                    html += `<tr style="border-bottom:1px solid var(--border);"><td>${i}</td><td>${wp.lat.toFixed(3)}¬∞/${wp.lng.toFixed(3)}¬∞</td><td>üè†</td><td>-</td><td>-</td><td>START</td><td>100%</td></tr>`;
                    return;
                }

                const prev = missionBuilderState.waypoints[i - 1];
                const dist = haversineDistance(prev.lat, prev.lng, wp.lat, wp.lng);
                const timeMin = (dist / (wp.speed / 60));

                const basePower = airPowerForSpeed(wp.speed);
                const windAdjusted = adjustPowerForWind(basePower, missionBuilderState.conditions.wind);
                const tempAdjusted = adjustPowerForTemp(windAdjusted, missionBuilderState.conditions.tempWater);
                const energy = (tempAdjusted * timeMin) / 60;
                const battPercent = batteryWattHourToPercent(energy);

                totalDist += dist;
                totalTime += timeMin;
                totalBatt += battPercent;

                html += `<tr style="border-bottom:1px solid var(--border);"><td>${i}</td><td>${wp.lat.toFixed(3)}¬∞/${wp.lng.toFixed(3)}¬∞</td><td>${wp.altitude}m</td><td>${wp.speed}km/h</td><td>${dist.toFixed(2)}km</td><td>${Math.floor(timeMin)}m</td><td>${battPercent.toFixed(1)}%</td></tr>`;
            });

            if (missionBuilderState.waypoints.length > 1) {
                const last = missionBuilderState.waypoints[missionBuilderState.waypoints.length - 1];
                const home = missionBuilderState.waypoints[0];
                const rthDist = haversineDistance(last.lat, last.lng, home.lat, home.lng);
                const rthTime = (rthDist / (50 / 60));
                const rthEnergy = (600 * rthTime) / 60;
                const rthBatt = batteryWattHourToPercent(rthEnergy);

                totalDist += rthDist;
                totalTime += rthTime;
                totalBatt += rthBatt;

                html += `<tr style="background:rgba(255,107,107,0.1);border-bottom:1px solid var(--border);"><td>RTH</td><td>HOME</td><td>-</td><td>50km/h</td><td>${rthDist.toFixed(2)}km</td><td>${Math.floor(rthTime)}m</td><td>${rthBatt.toFixed(1)}%</td></tr>`;
            }

            html += '</tbody></table>';
            html += `<div style="margin-top:12px;padding:8px;background:rgba(124,92,255,0.1);border-radius:6px;font-size:12px;"><strong>TOTAUX:</strong> ${totalDist.toFixed(2)}km | ${Math.floor(totalTime)}min | ${totalBatt.toFixed(1)}% batterie</div>`;

            container.innerHTML = html;

            document.getElementById('mb-total-distance').textContent = totalDist.toFixed(2);
            document.getElementById('mb-total-time').textContent = `${Math.floor(totalTime)}:${String(Math.round((totalTime % 1) * 60)).padStart(2, '0')}`;
            document.getElementById('mb-total-battery').textContent = totalBatt.toFixed(1) + '%';
            document.getElementById('mb-battery-remaining').textContent = (100 - totalBatt).toFixed(1) + '%';

            if (missionBuilderState.map) {
                if (missionBuilderState.polyline) missionBuilderState.map.removeLayer(missionBuilderState.polyline);
                const coords = missionBuilderState.waypoints.map(wp => [wp.lat, wp.lng]);
                missionBuilderState.polyline = L.polyline(coords, {
                    color: '#7c5cff',
                    weight: 2,
                    opacity: 0.7
                }).addTo(missionBuilderState.map);
            }
        }

        // ============ ACTIONS STEP ============

        function renderActionsStep() {
            const container = document.getElementById('mb-actions-container');
            if (!container) return;

            let html = '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;">';

            missionBuilderState.waypoints.forEach((wp, i) => {
                if (i === 0) return;

                html += `<div style="background:var(--card-bg);border:1px solid var(--border);border-radius:12px;padding:16px;">`;
                html += `<h4 style="margin:0 0 12px 0;">üéØ WP ${i}</h4>`;

                Object.entries(actionDefinitions).forEach(([key, def]) => {
                    const checked = missionBuilderState.actions[i]?.[key] ? 'checked' : '';
                    html += `<label style="display:block;margin-bottom:8px;font-size:13px;">`;
                    html += `<input type="checkbox" data-wp="${i}" data-action="${key}" ${checked} onchange="toggleAction(${i},'${key}')"> `;
                    html += `${def.name}<br>`;
                    const unitStr = def.unit === 'sec' ? 's' : (def.unit || '');
                    const energyWh = (def.power * def.duration / 3600).toFixed(2);
                    html += `<span style="color:var(--muted);font-size:11px;">‚ö°${def.power}W √ó ${def.duration}${unitStr} = ${energyWh}Wh</span>`;
                    html += `</label>`;
                });

                html += `</div>`;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function toggleAction(wpIndex, actionKey) {
            if (!missionBuilderState.actions[wpIndex]) {
                missionBuilderState.actions[wpIndex] = {};
            }
            const checkbox = document.querySelector(`input[data-wp="${wpIndex}"][data-action="${actionKey}"]`);
            missionBuilderState.actions[wpIndex][actionKey] = checkbox?.checked || false;
            updateConditionsImpact();
        }

        // ============ CONDITIONS IMPACT ============

        function updateConditionsImpact() {
            const analysis = calculateConditionsImpact();

            const windPower = airPowerForSpeed(50) * (1 + (missionBuilderState.conditions.wind / 20) * 0.08);
            const windImpact = ((windPower / airPowerForSpeed(50)) - 1) * 100;
            document.getElementById('mb-wind-impact').textContent = `Impact: +${windImpact.toFixed(1)}% batterie`;

            const visProb = detectionProbability(missionBuilderState.conditions.visibility, missionBuilderState.conditions.weather, true);
            document.getElementById('mb-visibility-impact').textContent = `Impact: ${visProb.toFixed(0)}% d√©tection`;

            const wavesRisk = missionBuilderState.conditions.waves > 2 ? '‚ö†Ô∏è Risque' : '‚úì Stable';
            document.getElementById('mb-waves-impact').textContent = `Impact: ${wavesRisk}`;

            const tempPenalty = missionBuilderState.conditions.tempWater < 15 ? -8 : 0;
            document.getElementById('mb-temp-impact').textContent = `Impact: ${tempPenalty}% batterie`;

            const weatherImpacts = { clear: '+25%', cloudy: '+10%', 'light-rain': '-15%', 'heavy-rain': '-30%' };
            document.getElementById('mb-weather-impact').textContent = `Impact: D√©tection ${weatherImpacts[missionBuilderState.conditions.weather]}`;

            const hour = parseInt(missionBuilderState.conditions.time.split(':')[0]);
            const timeImpact = (hour >= 20 || hour < 6) ? 'üåô Nuit (-80% visibilit√©)' : '‚òÄÔ∏è Jour optimal';
            document.getElementById('mb-time-impact').textContent = `Impact: ${timeImpact}`;

            const waterVis = { fresh: '90%', coastal: '60%', ocean: '85%' };
            document.getElementById('mb-water-type-impact').textContent = `Impact: Visibilit√© ${waterVis[missionBuilderState.conditions.waterType]}`;

            const totalDist = parseFloat(document.getElementById('mb-total-distance').textContent) || 0;
            const driftM = (missionBuilderState.conditions.current * totalDist * 1000) / 100;
            document.getElementById('mb-current-impact').textContent = `Impact: D√©rive ${driftM.toFixed(0)}m`;

            updateMainAnalysis(analysis);
        }

        function calculateConditionsImpact() {
            const cond = missionBuilderState.conditions;
            const visProb = detectionProbability(cond.visibility, cond.weather, true);

            let risks = [];
            if (cond.wind > 20) risks.push('‚ö†Ô∏è Vent √©lev√©');
            if (cond.visibility < 50) risks.push('‚ö†Ô∏è Visibilit√© critique');
            if (cond.waves > 2.5) risks.push('‚ö†Ô∏è Vagues importantes');
            if (cond.tempWater < 5) risks.push('‚ùå Temp√©rature critique');

            const baseBatt = parseFloat(document.getElementById('mb-total-battery').textContent) || 0;
            const tempPenalty = cond.tempWater < 15 ? 0.92 : 1.0;
            const windMult = (600 + (600 * (cond.wind / 20) * 0.08)) / 600;
            const adjustedBatt = baseBatt * windMult * tempPenalty;

            return {
                baseBattery: baseBatt,
                adjustedBattery: adjustedBatt,
                detectionProb: visProb,
                risks: risks,
                isNight: parseInt(cond.time.split(':')[0]) >= 20 || parseInt(cond.time.split(':')[0]) < 6
            };
        }

        function updateMainAnalysis(analysis) {
            const battChange = analysis.adjustedBattery - analysis.baseBattery;
            const battColor = battChange < 0 ? '#ff6b6b' : '#00ff88';

            const detQuality = analysis.detectionProb > 80 ? 'Excellent' :
                analysis.detectionProb > 60 ? 'Bon' :
                    analysis.detectionProb > 40 ? 'Moyen' : 'Faible';

            document.getElementById('mb-analysis-battery').innerHTML =
                `${analysis.baseBattery.toFixed(1)}% ‚Üí <span style="color:${battColor};">${analysis.adjustedBattery.toFixed(1)}%</span> (${battChange > 0 ? '+' : ''}${battChange.toFixed(1)}%)`;

            document.getElementById('mb-analysis-detection').textContent =
                `${analysis.detectionProb.toFixed(0)}% (${detQuality})`;

            const timeStr = document.getElementById('mb-total-time').textContent || '0:00';
            document.getElementById('mb-analysis-time').textContent = timeStr;

            const riskText = analysis.risks.length > 0 ? analysis.risks.join(' | ') : '‚úÖ Aucun risque majeur';
            document.getElementById('mb-analysis-risks').textContent = riskText;

            const rec = analysis.isNight ? 'üí° LED spotlight recommand√©e (nuit)' :
                analysis.risks.length > 0 ? '‚ö†Ô∏è V√©rifier conditions de s√©curit√©' :
                    '‚úì Conditions optimales - Mission faisable';
            document.getElementById('mb-analysis-recommendations').textContent = rec;
        }

        // ============ DRONE CONFIG ============

        function updateDroneConfig() {
            const cfg = droneConfigs[missionBuilderState.config];
            let weight = cfg.weight;
            let totalPayload = 0.45;

            if (missionBuilderState.payloads.thermal) {
                weight += 0.2;
                totalPayload += 0.2;
            }
            if (missionBuilderState.payloads['extra-led']) {
                weight += 0.05;
                totalPayload += 0.05;
            }

            const totalWeight = weight;
            const isValid = totalWeight <= cfg.maxWeight;

            let html = `<div style="padding:12px;background:var(--card-bg);border-radius:6px;">`;
            html += `<p style="margin:0 0 8px 0;"><strong>Drone:</strong> ${cfg.name}</p>`;
            html += `<p style="margin:0 0 8px 0;"><strong>Poids drone:</strong> ${cfg.weight}kg</p>`;
            html += `<p style="margin:0 0 8px 0;"><strong>Payload:</strong> ${totalPayload.toFixed(2)}kg</p>`;
            html += `<p style="margin:0 0 12px 0;"><strong>Total:</strong> ${totalWeight.toFixed(2)}kg / ${cfg.maxWeight}kg ${isValid ? '‚úÖ' : '‚ùå'}</p>`;

            html += `<hr style="border:none;border-top:1px solid var(--border);margin:12px 0;">`;
            html += `<p style="margin:0 0 8px 0;"><strong>Autonomie th√©orique:</strong> ${cfg.autonomy}min</p>`;

            const missionMinutes = (parseFloat(document.getElementById('mb-total-time').textContent.split(':')[0]) || 0) +
                (parseFloat(document.getElementById('mb-total-time').textContent.split(':')[1]) || 0) / 60;
            const margin = cfg.autonomy - missionMinutes;
            const marginColor = margin < 5 ? '#ff6b6b' : '#00ff88';

            html += `<p style="margin:0 0 8px 0;"><strong>Dur√©e mission:</strong> ${Math.floor(missionMinutes)}min</p>`;
            html += `<p style="margin:0;color:${marginColor};"><strong>Marge batterie:</strong> ${margin.toFixed(1)}min</p>`;

            if (!isValid) html += `<p style="color:#ff6b6b;margin:12px 0 0 0;">‚ö†Ô∏è D√âPASSE LE POIDS MAX!</p>`;
            if (margin < 5) html += `<p style="color:#ff6b6b;margin:12px 0 0 0;">‚ö†Ô∏è MARGE BATTERIE FAIBLE!</p>`;

            html += `</div>`;

            document.getElementById('mb-config-summary').innerHTML = html;

            document.getElementById('mb-drone-weight').textContent = cfg.weight.toFixed(2);
            document.getElementById('mb-payload-weight').textContent = totalPayload.toFixed(2);
            document.getElementById('mb-total-weight').textContent = totalWeight.toFixed(2);
            document.getElementById('mb-autonomy-theo').textContent = cfg.autonomy;
            document.getElementById('mb-autonomy-mission').textContent = Math.max(0, Math.round(cfg.autonomy - (totalPayload * 2)));
            document.getElementById('mb-flight-duration').textContent = missionMinutes.toFixed(1);
            document.getElementById('mb-battery-margin').textContent = margin.toFixed(1) + 'min';
            document.getElementById('mb-battery-margin').style.color = marginColor;
        }

        // ============ SIMULATION & REPORT ============

        function launchSimulation() {
            if (missionBuilderState.waypoints.length < 2) {
                alert('‚ùå Ajoute au moins 2 waypoints!');
                return;
            }

            showMBStep('result');
            document.getElementById('mb-live-telemetry').style.display = 'block';
            document.getElementById('mb-report-content').style.display = 'none';

            // Start live telemetry simulation
            if (typeof startTelemetrySimulation === 'function') {
                startTelemetrySimulation();
            } else {
                // Fallback to static report if telemetry system not loaded
                generateMissionReport();
                document.getElementById('mb-report-content').style.display = 'block';
                document.getElementById('mb-live-telemetry').style.display = 'none';
            }
        }

        function generateMissionReport() {
            const cfg = droneConfigs[missionBuilderState.config];
            const cond = missionBuilderState.conditions;

            let report = `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
            report += `üìã RAPPORT MISSION R√âALISTE\n`;
            report += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
            report += `üéØ SC√âNARIO: ${missionBuilderState.selectedScenario}\n`;
            report += `üöÅ DRONE: ${cfg.name}\n`;
            report += `üìÖ DATE: ${new Date().toLocaleString('fr-FR')}\n\n`;

            report += `üåç CONDITIONS:\n`;
            report += `‚îú‚îÄ Vent: ${cond.wind} km/h\n`;
            report += `‚îú‚îÄ Visibilit√©: ${cond.visibility}m\n`;
            report += `‚îú‚îÄ Vagues: ${cond.waves}m\n`;
            report += `‚îú‚îÄ Temp√©rature eau: ${cond.tempWater}¬∞C\n`;
            report += `‚îú‚îÄ M√©t√©o: ${cond.weather}\n`;
            report += `‚îú‚îÄ Heure: ${cond.time}\n`;
            report += `‚îú‚îÄ Type eau: ${cond.waterType}\n`;
            report += `‚îî‚îÄ Courant: ${cond.current} km/h\n\n`;

            report += `üìç WAYPOINTS & TRAJET:\n`;
            let totalDist = 0, totalTime = 0, totalBatt = 0;

            missionBuilderState.waypoints.forEach((wp, i) => {
                if (i === 0) {
                    report += `‚îú‚îÄ WP0 (HOME): [${wp.lat.toFixed(4)}¬∞N, ${wp.lng.toFixed(4)}¬∞E]\n`;
                    return;
                }

                const prev = missionBuilderState.waypoints[i - 1];
                const dist = haversineDistance(prev.lat, prev.lng, wp.lat, wp.lng);
                const timeMin = (dist / (wp.speed / 60));
                const basePower = airPowerForSpeed(wp.speed);
                const tempPower = adjustPowerForTemp(basePower, cond.tempWater);
                const windPower = adjustPowerForWind(tempPower, cond.wind);
                const energy = (windPower * timeMin) / 60;
                const battPercent = batteryWattHourToPercent(energy);

                totalDist += dist;
                totalTime += timeMin;
                totalBatt += battPercent;

                report += `‚îú‚îÄ WP${i}: [${wp.lat.toFixed(4)}¬∞N, ${wp.lng.toFixed(4)}¬∞E]\n`;
                report += `‚îÇ  ‚îú‚îÄ Distance: ${dist.toFixed(2)}km √† ${wp.speed}km/h\n`;
                report += `‚îÇ  ‚îú‚îÄ Dur√©e: ${Math.floor(timeMin)}min ${Math.round((timeMin % 1) * 60)}sec\n`;
                report += `‚îÇ  ‚îú‚îÄ Puissance: ${windPower.toFixed(0)}W\n`;
                report += `‚îÇ  ‚îî‚îÄ Batterie: ${battPercent.toFixed(2)}% (${energy.toFixed(1)}Wh)\n`;

                const actions = missionBuilderState.actions[i];
                if (actions && Object.keys(actions).some(k => actions[k])) {
                    report += `‚îÇ  Actions:\n`;
                    Object.entries(actions).forEach(([key, active]) => {
                        if (active) {
                            const def = actionDefinitions[key];
                            report += `‚îÇ  ‚îî‚îÄ ${def.name} (${def.power}W √ó ${def.duration}${def.unit})\n`;
                        }
                    });
                }
            });

            if (missionBuilderState.waypoints.length > 1) {
                const last = missionBuilderState.waypoints[missionBuilderState.waypoints.length - 1];
                const home = missionBuilderState.waypoints[0];
                const rthDist = haversineDistance(last.lat, last.lng, home.lat, home.lng);
                const rthTime = (rthDist / (50 / 60));
                const rthEnergy = (600 * rthTime) / 60;
                const rthBatt = batteryWattHourToPercent(rthEnergy);

                totalDist += rthDist;
                totalTime += rthTime;
                totalBatt += rthBatt;

                report += `‚îî‚îÄ RTH (Retour base): ${rthDist.toFixed(2)}km\n`;
                report += `   ‚îî‚îÄ Batterie: ${rthBatt.toFixed(2)}%\n`;
            }

            report += `\n‚ö° BILAN √âNERGIE:\n`;
            report += `‚îú‚îÄ Distance totale: ${totalDist.toFixed(2)}km\n`;
            report += `‚îú‚îÄ Dur√©e totale: ${Math.floor(totalTime)}min ${Math.round((totalTime % 1) * 60)}sec\n`;
            report += `‚îú‚îÄ Batterie utilis√©e: ${totalBatt.toFixed(2)}%\n`;
            report += `‚îú‚îÄ Batterie restante: ${(100 - totalBatt).toFixed(2)}%\n`;
            report += `‚îî‚îÄ Autonomie: ${cfg.autonomy}min (${totalTime < cfg.autonomy ? '‚úÖ OK' : '‚ùå INSUFFISANT'})\n\n`;

            const analysis = calculateConditionsImpact();
            report += `üéØ D√âTECTION:\n`;
            report += `‚îú‚îÄ Probabilit√©: ${analysis.detectionProb.toFixed(1)}%\n`;
            report += `‚îú‚îÄ Risques: ${analysis.risks.length > 0 ? analysis.risks.join(', ') : 'Aucun'}\n`;
            report += `‚îî‚îÄ Status: ${totalBatt < 100 && totalTime < cfg.autonomy ? '‚úÖ MISSION POSSIBLE' : '‚ùå MISSION IMPOSSIBLE'}\n`;

            const reportElem = document.getElementById('mb-report-content');
            if (reportElem) {
                reportElem.innerHTML = `<pre style="overflow-x:auto;white-space:pre-wrap;word-wrap:break-word;font-size:12px;line-height:1.5;">${report}</pre>`;
                reportElem.style.display = 'block';
            }

            document.getElementById('mb-simulation-container').style.display = 'none';
        }

        function resetMissionBuilder() {
            missionBuilderState.selectedScenario = null;
            missionBuilderState.waypoints = [];
            missionBuilderState.actions = {};
            if (missionBuilderState.map) {
                missionBuilderState.map.remove();
                missionBuilderState.map = null;
            }
            missionBuilderState.markers = {};
            missionBuilderState.polyline = null;

            document.querySelectorAll('.scenario-card').forEach(c => c.classList.remove('selected'));
            document.getElementById('mb-continue-step1').disabled = true;
            document.getElementById('mb-continue-step1').style.opacity = '0.5';

            showMBStep(1);
        }

        function exportReport() {
            const reportText = document.getElementById('mb-report-content').textContent;
            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(reportText));
            element.setAttribute('download', `mission-${Date.now()}.txt`);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

        window.editWaypoint = editWaypoint;
        window.deleteWaypoint = deleteWaypoint;
        window.toggleAction = toggleAction;
        window.updateDroneConfig = updateDroneConfig;
        window.initMissionBuilder = initMissionBuilder;

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üé¨ SYST√àME DE T√âL√âM√âTRIE EN DIRECT - INT√âGR√â
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // √âtat global de la t√©l√©m√©trie
        const telemetryState = {
            isRunning: false,
            isPaused: false,
            currentTime: 0,
            totalTime: 0,
            currentWaypoint: 0,
            batteryPercent: 100,
            batteryWh: 276.5,
            speedCurrent: 0,
            altitudeCurrent: 0,
            distanceTraveled: 0,
            distanceRemaining: 0,
            events: [],
            simulationSpeed: 1,
            simulationLoop: null,
            droneConfig: null,
            conditions: null,
            waypoints: [],
            actions: {}
        };

        function addTelemetryEvent(time, type, description, battery, distance) {
            const event = {
                time: formatTelemetryTime(time),
                type: type,
                description: description,
                battery: battery.toFixed(1),
                distance: distance.toFixed(2)
            };
            telemetryState.events.push(event);
            if (telemetryState.events.length > 15) telemetryState.events.shift();
            updateTelemEvents();
        }

        function formatTelemetryTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }

        function startTelemetrySimulation() {
            telemetryState.isRunning = true;
            telemetryState.isPaused = false;
            telemetryState.currentTime = 0;
            telemetryState.currentWaypoint = 0;
            telemetryState.batteryPercent = 100;
            telemetryState.batteryWh = 276.5;
            telemetryState.speedCurrent = 0;
            telemetryState.altitudeCurrent = 0;
            telemetryState.distanceTraveled = 0;
            telemetryState.distanceRemaining = calculateTelemTotalDistance();
            telemetryState.events = [];

            addTelemetryEvent(0, 'START', 'üöÄ D√©collage drone', 100, 0);

            if (telemetryState.simulationLoop) clearInterval(telemetryState.simulationLoop);
            telemetryState.simulationLoop = setInterval(() => {
                if (telemetryState.isRunning && !telemetryState.isPaused) {
                    telemSimulationStep(0.05 * telemetryState.simulationSpeed);
                }
            }, 50);

            document.getElementById('btn-start-telemetry').disabled = true;
            document.getElementById('btn-pause-telemetry').disabled = false;
            document.getElementById('btn-reset-telemetry').disabled = false;
        }

        function pauseTelemetrySimulation() {
            telemetryState.isPaused = !telemetryState.isPaused;
            document.getElementById('btn-pause-telemetry').textContent = telemetryState.isPaused ? '‚ñ∂Ô∏è REPRENDRE' : '‚è∏Ô∏è PAUSE';
        }

        function resetTelemetrySimulation() {
            telemetryState.isRunning = false;
            telemetryState.isPaused = false;
            if (telemetryState.simulationLoop) clearInterval(telemetryState.simulationLoop);

            document.getElementById('btn-start-telemetry').disabled = false;
            document.getElementById('btn-pause-telemetry').disabled = true;
            document.getElementById('btn-pause-telemetry').textContent = '‚è∏Ô∏è PAUSE';
            document.getElementById('btn-reset-telemetry').disabled = true;

            telemetryState.currentTime = 0;
            telemetryState.batteryPercent = 100;
            telemetryState.distanceTraveled = 0;
            telemetryState.currentWaypoint = 0;
            telemetryState.events = [];

            updateTelemDisplay();
        }

        function telemSimulationStep(deltaTime) {
            telemetryState.currentTime += deltaTime;

            const wp = missionBuilderState.waypoints[telemetryState.currentWaypoint];
            if (!wp) return;

            telemetryState.speedCurrent = wp.speed || 10;
            telemetryState.altitudeCurrent = wp.altitude || 30;

            const distThisStep = (telemetryState.speedCurrent / 3600) * deltaTime;
            telemetryState.distanceTraveled += distThisStep;
            telemetryState.distanceRemaining = Math.max(0, calculateTelemTotalDistance() - telemetryState.distanceTraveled);

            const power = calculateTelemPower();
            const energyThisStep = (power * deltaTime) / 3600;
            telemetryState.batteryWh -= energyThisStep;
            telemetryState.batteryPercent = (telemetryState.batteryWh / 276.5) * 100;

            if (telemetryState.batteryPercent <= 0) {
                endTelemSimulation('FAIL', '‚ùå Batterie √©puis√©e');
                return;
            }

            if (telemetryState.batteryPercent <= 10 && telemetryState.events.length > 0 &&
                telemetryState.events[telemetryState.events.length - 1].type !== 'WARNING') {
                addTelemetryEvent(telemetryState.currentTime, 'WARNING', '‚ö†Ô∏è Batterie faible', telemetryState.batteryPercent, telemetryState.distanceTraveled);
            }

            checkTelemWaypoint();
            updateTelemDisplay();
        }

        function calculateTelemPower() {
            const cond = missionBuilderState.conditions;
            const speed = telemetryState.speedCurrent;

            let basePower = 500;
            if (speed < 5) basePower = 500;
            else if (speed < 15) basePower = 600 + (speed - 5) * 5;
            else basePower = 700 + (speed - 15) * 10;

            const windMult = 1 + (cond.wind / 50) * 0.2;
            const tempMult = cond.tempWater < 15 ? 1.08 : 1.0;

            let totalPower = basePower * windMult * tempMult;

            const actions = missionBuilderState.actions[telemetryState.currentWaypoint];
            if (actions) {
                for (const [key, active] of Object.entries(actions)) {
                    if (active && actionDefinitions[key]) {
                        totalPower += actionDefinitions[key].power * 0.5;
                    }
                }
            }

            return totalPower;
        }

        function checkTelemWaypoint() {
            if (telemetryState.currentWaypoint >= missionBuilderState.waypoints.length - 1) {
                if (telemetryState.distanceRemaining < 0.1) {
                    endTelemSimulation('SUCCESS', '‚úÖ Mission r√©ussie');
                }
                return;
            }

            const currentWp = missionBuilderState.waypoints[telemetryState.currentWaypoint];
            const nextWp = missionBuilderState.waypoints[telemetryState.currentWaypoint + 1];
            const distToNext = haversineDistance(currentWp.lat, currentWp.lng, nextWp.lat, nextWp.lng);

            if (distToNext < 0.02) {
                telemetryState.currentWaypoint++;
                addTelemetryEvent(telemetryState.currentTime, 'WAYPOINT',
                    `üéØ WP${telemetryState.currentWaypoint} atteint`,
                    telemetryState.batteryPercent,
                    telemetryState.distanceTraveled);
            }
        }

        function endTelemSimulation(status, message) {
            telemetryState.isRunning = false;
            if (telemetryState.simulationLoop) clearInterval(telemetryState.simulationLoop);
            addTelemetryEvent(telemetryState.currentTime, 'END', message, telemetryState.batteryPercent, telemetryState.distanceTraveled);
            document.getElementById('btn-start-telemetry').disabled = false;
            document.getElementById('btn-pause-telemetry').disabled = true;
            document.getElementById('btn-reset-telemetry').disabled = false;
        }

        function updateTelemDisplay() {
            if (!document.getElementById('telem-time')) return;

            document.getElementById('telem-time').textContent = formatTelemetryTime(telemetryState.currentTime);

            const battColor = telemetryState.batteryPercent > 20 ? '#00ff88' :
                telemetryState.batteryPercent > 10 ? '#ffd166' : '#ff6b6b';
            document.getElementById('telem-battery').textContent = Math.max(0, telemetryState.batteryPercent).toFixed(1) + '%';
            document.getElementById('telem-battery').style.color = battColor;

            const battBar = document.getElementById('telem-battery-bar');
            if (battBar) {
                battBar.style.width = Math.max(0, telemetryState.batteryPercent) + '%';
                battBar.style.background = battColor;
            }

            document.getElementById('telem-speed').textContent = telemetryState.speedCurrent.toFixed(1) + ' km/h';
            document.getElementById('telem-altitude').textContent = telemetryState.altitudeCurrent.toFixed(0) + ' m';
            document.getElementById('telem-waypoint').textContent = 'WP' + telemetryState.currentWaypoint;
            document.getElementById('telem-distance').textContent = telemetryState.distanceTraveled.toFixed(2) + ' km';
            document.getElementById('telem-remaining').textContent = telemetryState.distanceRemaining.toFixed(2) + ' km restant';

            const totalDist = calculateTelemTotalDistance();
            const progress = totalDist > 0 ? (telemetryState.distanceTraveled / totalDist) * 100 : 0;
            const progBar = document.getElementById('telem-progress-bar');
            if (progBar) progBar.style.width = Math.min(100, progress) + '%';
        }

        function updateTelemEvents() {
            const logDiv = document.getElementById('telem-events-log');
            if (!logDiv) return;

            let html = '';
            telemetryState.events.forEach((evt) => {
                const colors = {
                    'START': { bg: 'rgba(0,255,136,0.1)', border: '#00ff88' },
                    'END': { bg: 'rgba(255,107,107,0.1)', border: '#ff6b6b' },
                    'WARNING': { bg: 'rgba(255,209,102,0.1)', border: '#ffd166' },
                    'WAYPOINT': { bg: 'rgba(0,229,255,0.1)', border: '#00e5ff' }
                };
                const color = colors[evt.type] || { bg: 'transparent', border: '#999' };

                html += `<div style="background: ${color.bg}; padding: 8px; margin: 4px 0; border-radius: 6px; border-left: 3px solid ${color.border}; font-size: 11px;">
                    <div style="font-weight: 600;">${evt.time} - ${evt.description}</div>
                    <div style="color: var(--muted); font-size: 10px;">üîã ${evt.battery}% | üìç ${evt.distance}km</div>
                </div>`;
            });

            logDiv.innerHTML = html || '<div style="color: var(--muted); text-align: center; padding: 20px;">Aucun √©v√©nement</div>';
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function calculateTelemTotalDistance() {
            let total = 0;
            for (let i = 1; i < missionBuilderState.waypoints.length; i++) {
                const prev = missionBuilderState.waypoints[i - 1];
                const curr = missionBuilderState.waypoints[i];
                total += haversineDistance(prev.lat, prev.lng, curr.lat, curr.lng);
            }
            if (missionBuilderState.waypoints.length > 1) {
                const last = missionBuilderState.waypoints[missionBuilderState.waypoints.length - 1];
                const home = missionBuilderState.waypoints[0];
                total += haversineDistance(last.lat, last.lng, home.lat, home.lng);
            }
            return total;
        }

        // Export functions to global scope
        window.telemetryState = telemetryState;
        window.startTelemetrySimulation = startTelemetrySimulation;
        window.pauseTelemetrySimulation = pauseTelemetrySimulation;
        window.resetTelemetrySimulation = resetTelemetrySimulation;
        window.addTelemetryEvent = addTelemetryEvent;
        window.updateTelemDisplay = updateTelemDisplay;
        window.updateTelemEvents = updateTelemEvents;

        // Event listeners
        document.getElementById('btn-start-telemetry')?.addEventListener('click', startTelemetrySimulation);
        document.getElementById('btn-pause-telemetry')?.addEventListener('click', pauseTelemetrySimulation);
        document.getElementById('btn-reset-telemetry')?.addEventListener('click', resetTelemetrySimulation);
        document.getElementById('speed-slider')?.addEventListener('change', (e) => {
            telemetryState.simulationSpeed = parseFloat(e.target.value);
            document.getElementById('speed-display').textContent = telemetryState.simulationSpeed + 'x';
        });

        // ============ BUDGET TAB LOGIC ============
        // Co√ªts des services (modifiables dynamiquement)
        const budgetServices = {
            modeleur3d: 1000,
            firmwareDev: 600,
            webAppDev: 400,
            abonnement4g: 2400,
            outillageTests: 350,
            ordinateur: 4000
        };

        function initBudgetTab() {
            // Calculer le co√ªt total du hardware avec QUANTIT√âS
            let hardwareCost = 0;
            const componentsCost = {};

            Object.entries(componentsData).forEach(([category, items]) => {
                let categoryCost = 0;
                items.forEach(item => {
                    if (item.price) {
                        // Prix unitaire √ó Quantit√© = Co√ªt total
                        const quantity = item.quantity || 1;
                        const itemTotalCost = item.price * quantity;
                        hardwareCost += itemTotalCost;
                        categoryCost += itemTotalCost;

                        if (!componentsCost[category]) {
                            componentsCost[category] = { total: 0, items: [] };
                        }
                        componentsCost[category].total += itemTotalCost;
                        componentsCost[category].items.push({
                            name: item.name,
                            price: item.price,
                            quantity: quantity,
                            totalCost: itemTotalCost,
                            link: item.link
                        });
                    }
                });
            });

            // Mettre √† jour le co√ªt hardware dans le tableau
            const hardwareTotalEl = document.getElementById('hardwareTotal');
            if (hardwareTotalEl) {
                hardwareTotalEl.textContent = hardwareCost + '‚Ç¨';
            }

            // Mettre √† jour le titre du d√©tail
            const hardwareTotalTitleEl = document.getElementById('hardwareTotalTitle');
            if (hardwareTotalTitleEl) {
                hardwareTotalTitleEl.textContent = hardwareCost + '‚Ç¨';
            }

            // Calculer les totaux globaux
            const totalServices = budgetServices.modeleur3d + budgetServices.firmwareDev + budgetServices.webAppDev + budgetServices.abonnement4g + budgetServices.outillageTests;
            const totalSansOrdinateur = hardwareCost + totalServices;
            const totalAvecOrdinateur = totalSansOrdinateur + budgetServices.ordinateur;

            // Mettre √† jour le tableau des co√ªts - lignes individuelles
            const budgetTableRows = document.querySelectorAll('.budget-table tbody tr.budget-row');
            budgetTableRows.forEach(row => {
                const label = row.querySelector('.budget-label');
                const amount = row.querySelector('.budget-amount');
                if (!label || !amount) return;

                const labelText = label.textContent.trim();

                if (labelText.includes('Mod√©leur 3D')) {
                    amount.textContent = budgetServices.modeleur3d + '‚Ç¨';
                } else if (labelText.includes('Dev Firmware')) {
                    amount.textContent = budgetServices.firmwareDev + '‚Ç¨';
                } else if (labelText.includes('Dev Web/App')) {
                    amount.textContent = budgetServices.webAppDev + '‚Ç¨';
                } else if (labelText.includes('Abonnement 4G/5G')) {
                    amount.textContent = budgetServices.abonnement4g + '‚Ç¨';
                } else if (labelText.includes('Outillage/Tests')) {
                    amount.textContent = budgetServices.outillageTests + '‚Ç¨';
                } else if (labelText.includes('Ordinateur de Travail')) {
                    amount.textContent = budgetServices.ordinateur + '‚Ç¨';
                }
            });

            // Mettre √† jour les totaux finaux avec IDs
            const totalSansOrdEl = document.getElementById('totalSansOrdinateur');
            if (totalSansOrdEl) {
                totalSansOrdEl.textContent = totalSansOrdinateur + '‚Ç¨';
            }
            const totalAvecOrdEl = document.getElementById('totalAvecOrdinateur');
            if (totalAvecOrdEl) {
                totalAvecOrdEl.textContent = '(avec ordinateur) ' + totalAvecOrdinateur + '‚Ç¨';
            }

            // Remplir la grille des composants
            const grid = document.getElementById('componentsCostGrid');
            if (grid) {
                let html = '';
                Object.entries(componentsCost).forEach(([category, data]) => {
                    html += `
                        <div class="component-cost-card">
                            <div class="component-cost-category">${category.toUpperCase()}</div>
                            <div style="margin-bottom: 12px;">
                                ${data.items.map(item => `
                                    <div style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border);">
                                        <div style="font-size: 0.9rem; color: var(--text); margin-bottom: 4px;">${item.name}</div>
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                            <span style="color: var(--muted); font-size: 0.85rem;">
                                                ${item.price}‚Ç¨ √ó ${item.quantity} = <strong style="color: var(--accent);">${item.totalCost}‚Ç¨</strong>
                                            </span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <div style="background: rgba(124, 92, 255, 0.1); padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 0.85rem; color: var(--muted); margin-bottom: 4px;">Sous-total ${category}</div>
                                <div class="component-cost-price">${data.total}‚Ç¨</div>
                            </div>
                        </div>
                    `;
                });
                grid.innerHTML = html;
            }

            // Dessiner le graphique du budget
            drawBudgetChart(hardwareCost, componentsCost);
        }

        function drawBudgetChart(hardwareTotal, componentsCost) {
            const ctx = document.getElementById('budgetChart');
            if (!ctx) return;

            // Cr√©er les donn√©es pour le graphique avec breakdown par cat√©gorie
            const budgetData = [];
            const colors = ['#FFD166', '#7C5CFF', '#00E5FF', '#FF6B6B', '#00FF88', '#FFB84D', '#FF6B9D'];
            let colorIdx = 0;

            Object.entries(componentsCost).forEach(([category, data]) => {
                budgetData.push({
                    label: `${category} (${data.total}‚Ç¨)`,
                    value: data.total,
                    color: colors[colorIdx % colors.length]
                });
                colorIdx++;
            });

            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const textColor = isDark ? '#e6eef8' : '#071124';

            if (window.budgetChart) window.budgetChart.destroy();

            window.budgetChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: budgetData.map(d => d.label),
                    datasets: [{
                        data: budgetData.map(d => d.value),
                        backgroundColor: budgetData.map(d => d.color),
                        borderColor: isDark ? 'rgba(8,10,18,0.8)' : 'rgba(255,255,255,0.8)',
                        borderWidth: 2,
                        hoverBorderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: textColor,
                                font: { size: 12, weight: '600' },
                                padding: 16,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: isDark ? 'rgba(0,0,0,0.8)' : 'rgba(255,255,255,0.8)',
                            titleColor: textColor,
                            bodyColor: textColor,
                            borderColor: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                label: function (context) {
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: ${value}‚Ç¨ (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Fonction pour mettre √† jour les co√ªts dynamiquement
        window.updateBudgetCost = function (serviceName, newPrice) {
            if (budgetServices.hasOwnProperty(serviceName)) {
                budgetServices[serviceName] = newPrice;
                initBudgetTab();
                console.log(`‚úÖ ${serviceName} mis √† jour √† ${newPrice}‚Ç¨`);
            } else {
                console.error(`‚ùå Service "${serviceName}" non trouv√©. Disponibles: ${Object.keys(budgetServices).join(', ')}`);
            }
        };

        // Fonction pour afficher le budget actuel
        window.getBudgetSummary = function () {
            const totalServices = budgetServices.modeleur3d + budgetServices.firmwareDev + budgetServices.webAppDev + budgetServices.abonnement4g + budgetServices.outillageTests;
            return {
                hardware: parseFloat(document.getElementById('hardwareTotal')?.textContent || '0'),
                services: totalServices,
                sans_ordinateur: totalServices + parseFloat(document.getElementById('hardwareTotal')?.textContent || '0'),
                avec_ordinateur: totalServices + budgetServices.ordinateur + parseFloat(document.getElementById('hardwareTotal')?.textContent || '0'),
                details: budgetServices
            };
        };

        // ============ SPOTLIGHT SEARCH LOGIC ============
        const spotlightBtn = document.getElementById('spotlightBtn');
        const spotlightOverlay = document.getElementById('spotlightOverlay');
        const spotlightModal = document.getElementById('spotlightModal');
        const spotlightInput = document.getElementById('spotlightInput');
        const spotlightResults = document.getElementById('spotlightResults');
        let selectedResultIndex = -1;
        let currentResults = [];

        // Ouvrir Spotlight
        function openSpotlight() {
            spotlightOverlay.style.display = 'block';
            spotlightModal.style.display = 'block';
            spotlightInput.focus();
            selectedResultIndex = -1;
        }

        // Fermer Spotlight
        function closeSpotlight() {
            spotlightOverlay.style.display = 'none';
            spotlightModal.style.display = 'none';
            spotlightInput.value = '';
            spotlightResults.innerHTML = '<div style="color: var(--muted); text-align: center; padding: 40px 20px; font-size: 14px;">Commence √† taper pour chercher...</div>';
            selectedResultIndex = -1;
        }

        // Fonction de recherche Spotlight
        function performSpotlightSearch(query) {
            if (!query || query.length < 2) {
                currentResults = [];
                spotlightResults.innerHTML = '<div style="color: var(--muted); text-align: center; padding: 40px 20px; font-size: 14px;">Commence √† taper pour chercher...</div>';
                return;
            }

            let results = [];
            let filterType = 'all';
            let searchQuery = query;

            // V√©rifier si la requ√™te a un filtre sp√©cialis√©
            const filterMatch = query.match(/@(\w+)\[(.*?)\]/);
            if (filterMatch) {
                filterType = filterMatch[1];
                searchQuery = filterMatch[2];
            }

            searchQuery = searchQuery.toLowerCase().trim();
            if (!searchQuery) {
                currentResults = [];
                spotlightResults.innerHTML = '<div style="color: var(--muted); text-align: center; padding: 40px 20px; font-size: 14px;">Commence √† taper pour chercher...</div>';
                return;
            }

            // RECHERCHE DANS COMPOSANTS
            if (filterType === 'all' || filterType === 'composants') {
                Object.entries(componentsData).forEach(([category, items]) => {
                    items.forEach(item => {
                        if (item.name.toLowerCase().includes(searchQuery) || item.description?.toLowerCase().includes(searchQuery)) {
                            results.push({
                                type: 'composant',
                                category: category,
                                title: item.name,
                                description: `Prix: ${item.price}‚Ç¨ | Quantit√©: ${item.quantity || 1}`,
                                tab: 'composants',
                                element: item,
                                scrollTo: category
                            });
                        }
                    });
                });
            }

            // RECHERCHE DANS BUDGET
            if (filterType === 'all' || filterType === 'budget') {
                Object.entries(budgetServices).forEach(([key, value]) => {
                    const displayName = key.replace(/([A-Z])/g, ' $1').trim();
                    if (displayName.toLowerCase().includes(searchQuery) || value.toString().includes(searchQuery)) {
                        results.push({
                            type: 'budget',
                            title: displayName,
                            description: `Co√ªt: ${value}‚Ç¨`,
                            tab: 'budget',
                            scrollTo: 'budgetChart'
                        });
                    }
                });
            }

            // RECHERCHE DANS PERFORMANCES
            if (filterType === 'all' || filterType === 'performances') {
                const perfSearchItems = [
                    { name: 'Autonomie Air', desc: 'Autonomie en mode air' },
                    { name: 'Autonomie Eau', desc: 'Autonomie en mode eau' },
                    { name: 'Vitesse Max', desc: 'Vitesse maximale' },
                    { name: 'Poids', desc: 'Poids total du drone' },
                    { name: 'Dimensions', desc: 'Dimensions du drone' }
                ];
                perfSearchItems.forEach(item => {
                    if (item.name.toLowerCase().includes(searchQuery) || item.desc.toLowerCase().includes(searchQuery)) {
                        results.push({
                            type: 'performances',
                            title: item.name,
                            description: item.desc,
                            tab: 'performances',
                            scrollTo: 'performanceTable'
                        });
                    }
                });
            }

            // RECHERCHE DANS CALCULATEUR
            if (filterType === 'all' || filterType === 'calculateur') {
                const calcItems = ['Autonomie', 'Throttle', 'Vitesse', 'Mode Op√©ration'];
                calcItems.forEach(item => {
                    if (item.toLowerCase().includes(searchQuery)) {
                        results.push({
                            type: 'calculateur',
                            title: item,
                            description: 'Param√®tre du calculateur',
                            tab: 'calculateur',
                            scrollTo: 'results'
                        });
                    }
                });
            }

            currentResults = results.slice(0, 10);

            if (currentResults.length > 0) {
                let html = '';
                currentResults.forEach((result, index) => {
                    const icon = result.type === 'composant' ? 'üì¶' : result.type === 'budget' ? 'üí∞' : result.type === 'performances' ? 'üìä' : '‚ö°';
                    html += `
                        <div data-index="${index}" style="padding: 12px; border-left: 3px solid var(--accent); margin-bottom: 8px; cursor: pointer; background: rgba(124,92,255,0.05); border-radius: 6px; transition: all 0.2s;" 
                             onmouseover="this.style.background='rgba(124,92,255,0.15)'; highlightResult(${index});" 
                             onmouseout="this.style.background='rgba(124,92,255,0.05)'"
                             onclick="selectSpotlightResult(${index})">
                            <div style="font-weight: 600; color: var(--text);">${icon} ${result.title}</div>
                            <div style="font-size: 12px; color: var(--muted);">${result.description}</div>
                        </div>
                    `;
                });
                spotlightResults.innerHTML = html;
            } else {
                spotlightResults.innerHTML = '<div style="color: var(--muted); text-align: center; padding: 40px 20px; font-size: 14px;">‚ùå Aucun r√©sultat trouv√©</div>';
            }

            selectedResultIndex = -1;
        }

        // Mettre en avant un r√©sultat
        window.highlightResult = function (index) {
            document.querySelectorAll('#spotlightResults > div[data-index]').forEach(el => {
                el.style.background = 'rgba(124,92,255,0.05)';
            });
            if (currentResults[index]) {
                document.querySelector(`#spotlightResults > div[data-index="${index}"]`).style.background = 'rgba(124,92,255,0.2)';
                selectedResultIndex = index;
            }
        };

        // S√©lectionner un r√©sultat
        window.selectSpotlightResult = function (index) {
            const result = currentResults[index];
            if (!result) return;

            // Fermer Spotlight
            closeSpotlight();

            // Changer de tab
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));

            const btn = document.querySelector(`[data-tab="${result.tab}"]`);
            const content = document.getElementById(result.tab);

            if (btn) btn.classList.add('active');
            if (content) content.classList.add('active');

            // Attendre un peu puis scroll
            setTimeout(() => {
                const element = document.getElementById(result.scrollTo) || document.querySelector(`[class*="${result.scrollTo}"]`);
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Highlight temporaire
                    element.style.background = 'rgba(124,92,255,0.2)';
                    setTimeout(() => {
                        element.style.background = '';
                    }, 1500);
                }
            }, 100);
        };

        // Event listeners Spotlight
        spotlightBtn?.addEventListener('click', openSpotlight);
        spotlightOverlay?.addEventListener('click', closeSpotlight);

        spotlightInput?.addEventListener('input', function (e) {
            performSpotlightSearch(e.target.value);
        });

        spotlightInput?.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                closeSpotlight();
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (selectedResultIndex < currentResults.length - 1) {
                    highlightResult(selectedResultIndex + 1);
                }
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (selectedResultIndex > 0) {
                    highlightResult(selectedResultIndex - 1);
                }
            } else if (e.key === 'Enter' && selectedResultIndex >= 0) {
                selectSpotlightResult(selectedResultIndex);
            }
        });

        // Ouvrir avec Cmd+K ou Ctrl+K
        document.addEventListener('keydown', function (e) {
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                e.preventDefault();
                if (spotlightModal.style.display === 'none' || spotlightModal.style.display === '') {
                    openSpotlight();
                } else {
                    closeSpotlight();
                }
            }
        });

        // Bouton Documentation - Cr√©e le bouton dynamiquement et le branche
        document.addEventListener('DOMContentLoaded', function () {
            // ============ BUDGET TAB INITIALIZATION ============
            initBudgetTab();

            // Essayer de cr√©er le bouton s'il n'existe pas
            let docBtn = document.getElementById('btn-open-docs');
            if (!docBtn) {
                // Cr√©er le bouton dans la sidebar
                const sidebar = document.querySelector('.sidebar');
                if (sidebar) {
                    const docSection = document.createElement('div');
                    docSection.innerHTML = `
                        <h2>Documentation</h2>
                        <div class="file-links">
                            <button id="btn-open-docs" style="width: 100%; padding: 10px; background: #7c5cff; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                                üìñ Documentation
                            </button>
                        </div>
                    `;
                    sidebar.appendChild(docSection);
                    docBtn = document.getElementById('btn-open-docs');
                }
            }

            // Ajouter l'event listener
            if (docBtn) {
                docBtn.addEventListener('click', function () {
                    // Ouvrir l'onglet Documentation
                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));

                    const docsTab = document.querySelector('[data-tab="documentation"]');
                    if (docsTab) {
                        docsTab.classList.add('active');
                        document.getElementById('documentation').classList.add('active');
                    }
                });
            }

            // ============ TAB SWITCHING LOGIC ============
            document.querySelectorAll('.tab-btn').forEach(tabBtn => {
                tabBtn.addEventListener('click', function () {
                    const tabName = this.getAttribute('data-tab');

                    // D√©sactiver tous les tabs
                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));

                    // Activer le tab cliqu√©
                    this.classList.add('active');
                    const tabContent = document.getElementById(tabName);
                    if (tabContent) {
                        tabContent.classList.add('active');

                        // R√©initialiser les appels de fonction pour les tabs sp√©cifiques
                        if (tabName === 'budget') {
                            initBudgetTab();
                        }
                    }
                });
            });
        });

        console.log('‚úÖ T√©l√©m√©trie int√©gr√©e et accessible globalement');
    </script>
</body>


</html>
